<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>NAVIFLEET - Pe≈Çny Interfejs Floty</title>
    <style>
        /* CSS dla ca≈Çego uk≈Çadu */
        body {
            display: flex;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            width: 100%;
            height: 100vh;
        }

        /* --- STYLY DLA LOGOWANIA (pozostajƒÖ bez zmian) --- */
        .login-container { display: none; justify-content: center; align-items: center; height: 100vh; width: 100%; background-color: #e9ecef; }
        .login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 350px; text-align: center; }
        .login-box input[type="text"], .login-box input[type="password"], .login-box input[type="email"] { width: 100%; padding: 10px; margin: 8px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .login-box button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; }

        /* --- STYLY DLA G≈Å√ìWNEJ APLIKACJI --- */
        .main-app { display: none; width: 100%; height: 100vh; display: flex; }
        .sidebar { width: 250px; background-color: #ffffff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); padding-top: 20px; min-height: 100vh; overflow-y: auto; }
        .menu-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; color: #333; }
        .menu-item:hover, .menu-item.active { background-color: #e6f7ff; color: #007bff; font-weight: bold; }
        
        /* Zmiana stylu dla podmenu, aby umo≈ºliwiƒá wyr√≥wnanie kropki */
        .menu-subitem { 
            padding: 8px 20px 8px 45px; 
            cursor: pointer; 
            color: #555; 
            font-size: 13px;
            display: flex; 
            align-items: center;
        }
        .menu-subitem:hover, .menu-subitem.active { background-color: #f0f8ff; color: #007bff; }
        
        .content-area { flex-grow: 1; padding: 20px 40px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h1 { margin: 0; font-size: 24px; }

        .btn-add { background-color: #28a745; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; }

        .table-container { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        /* Zmienione kolumny dla pojazd√≥w, aby zmie≈õciƒá akcje */
        .table-header, .table-row { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 1fr 1fr 120px; padding: 12px 0; border-bottom: 1px solid #ddd; }
        .table-header { font-weight: bold; background-color: #e9ecef; }
        /* Zmienione kolumny dla ma≈Çych tabel, aby zmie≈õciƒá akcje */
        .table-header-sm, .table-row-sm { display: grid; grid-template-columns: 50px 1.5fr 1fr 1.5fr 1fr 120px; padding: 12px 0; border-bottom: 1px solid #ddd; }
        .table-header-sm { font-weight: bold; background-color: #e9ecef; }
        .error { color: red; text-align: center; padding: 20px; font-size: 1.1em; }

        /* Styl dla przycisku wylogowania */
        #logout-btn { background: none; border: none; color: #dc3545; cursor: pointer; font-weight: bold; margin-top: 20px; width: 100%; text-align: left; padding: 12px 20px; }
        #logout-btn:hover { background-color: #ffeaea; }

        /* --- STYLY DLA MODALU (NOWE) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-content button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        .btn-save { background-color: #007bff; color: white; }
        #delete-btn { background-color: #dc3545; color: white; float: right; }

        /* --- STYLY DLA KOLOROWYCH K√ì≈ÅEK W MENU --- */
        .color-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px; /* Odstƒôp od tekstu */
        }
        .dot-policy { background-color: #007bff; }
        .dot-review { background-color: #28a745; }
        .dot-inspection { background-color: #ffc107; }
        .dot-repair { background-color: #dc3545; }

        /* --- STYLY DLA KALENDARZA --- */
        .calendar-view {
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .day-name {
            font-weight: bold;
            padding: 10px 0;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .calendar-day {
            min-height: 100px;
            padding: 5px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: left;
        }
        .calendar-day.current-month {
            background-color: #ffffff;
        }
        .calendar-day:hover {
            background-color: #e6f7ff;
        }
        .calendar-day-number {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            display: block;
            color: #333;
        }
        .event-item {
            font-size: 0.75em;
            padding: 2px 4px;
            margin-top: 2px;
            border-radius: 3px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Kolory dla r√≥≈ºnych typ√≥w zdarze≈Ñ (te same co kropki w menu) */
        .event-review { background-color: #28a745; } /* PrzeglƒÖd */
        .event-inspection { background-color: #ffc107; } /* Badanie/Inspekcja/Legalizacja */
        .event-policy { background-color: #007bff; } /* Polisa */
        .event-repair { background-color: #dc3545; } /* Naprawa */

        /* --- STYLY DLA KOLOROWYCH RAMEK DNI (NOWE) --- */
        /* U≈ºywamy !important, aby nadpisaƒá standardowy border: 1px solid #dee2e6 */
        .day-border-policy { border: 2px solid #007bff !important; }
        .day-border-review { border: 2px solid #28a745 !important; }
        .day-border-inspection { border: 2px solid #ffc107 !important; }
        .day-border-repair { border: 2px solid #dc3545 !important; }

    </style>
</head>
<body>



        <div class="login-container" id="login-container">
            <div class="login-box" id="login-box">
                <h2>Logowanie do NAVIFLEET</h2>
                <p style="color: red; height: 1.5em;" id="login-error"></p>
                <form id="login-form">
                    <input type="text" id="username" placeholder="Nazwa u≈ºytkownika" required>
                    <input type="password" id="password" placeholder="Has≈Ço" required>
                    <input type="password" id="pin_2fa" placeholder="PIN 2FA (tylko Admin)" style="display: none;">
                    <button type="submit">Zaloguj</button>
                </form>
                <p style="margin-top: 15px; font-size: 0.9em;">
                    Nie masz konta? <a href="#" onclick="showRegister()">Za≈Ç√≥≈º konto</a>
                </p>
            </div>

            <div class="login-box" id="register-box" style="display: none;">
                <h2>Za≈Ç√≥≈º konto</h2>
                <p style="color: red; height: 1.5em;" id="register-error"></p>
                <input type="text" id="reg_first_name" placeholder="Imiƒô" required>
                <input type="text" id="reg_last_name" placeholder="Nazwisko" required>
                <input type="text" id="reg_username" placeholder="Nowy login" required>
                <input type="email" id="reg_email" placeholder="Adres e-mail" required>
                <input type="password" id="reg_password" placeholder="Nowe has≈Ço" required>
                <select id="reg_role">
                    <option value="EMPLOYEE">Pracownik</option>
                    <option value="DRIVER">Kierowca</option>
                    <option value="MANAGER">Mened≈ºer Floty</option>
                </select>
                <button onclick="handleRegister()" style="width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                    Zarejestruj siƒô
                </button>
                <p style="margin-top: 15px; font-size: 0.9em;">
                    Masz ju≈º konto? <a href="#" onclick="showLogin()">Wr√≥ƒá do logowania</a>
                </p>
            </div>
        </div> <div class="main-app" id="main-app" style="display: none;">
            <div class="sidebar">
                <div style="padding: 10px 20px; font-size: 1.5em; color: #007bff; font-weight: 900;">NAVIFLEET</div>

                <div class="menu-item active" data-view="vehicles"><span>üöó Pojazdy</span></div>
                <div class="menu-item" data-view="drivers"><i class="fas fa-users"></i> U≈ºytkownicy</div>
                <div class="menu-item" data-view="handover">‚áå Przekazania</div>
                <div class="menu-item" data-view="inspection">üìú Inspekcje</div>
                <div class="menu-item" data-view="damages">‚ö†Ô∏è Szkody</div>

                <div class="menu-item" data-view="calendar">üìÖ Terminarz</div>

                <div class="menu-subitem" data-view="policies"><span class="color-dot dot-policy"></span>Polisy</div>
                <div class="menu-subitem" data-view="tech_inspections"><span class="color-dot dot-inspection"></span>Badania techniczne</div>
                <div class="menu-subitem" data-view="reviews"><span class="color-dot dot-review"></span>PrzeglƒÖdy</div>
                <div class="menu-subitem" data-view="repairs"><span class="color-dot dot-repair"></span>Naprawy</div>
                <div class="menu-subitem" data-view="legalization"><span class="color-dot dot-inspection"></span>Legalizacje</div>

                <div class="menu-item" data-view="leasing">üßæ Leasingi</div>
                <div class="menu-item" data-view="hr_docs">üìÑ Dokumenty kadrowe</div>
                <div class="menu-item" data-view="settlements">üí∂ Rozliczenia</div>
                <div class="menu-item" data-view="other">üïí Pozosta≈Çe</div>

                <div class="menu-item" data-view="settings" style="margin-top: 30px;">‚öôÔ∏è Ustawienia</div>

                <div style="padding: 20px;">
                    <button id="logout-btn" style="width: 100%;">Wyloguj (rola: <span id="user-role-display"></span>)</button>
                </div>
            </div>

            <div class="content-area">
                <div class="header">
                    <h1 id="view-title">Pojazdy</h1>
                    <button class="btn-add" id="add-btn">‚ûï DODAJ</button>
                </div>

                <div class="table-container" id="main-content">
                    </div>
            </div>
        </div>

        <div id="data-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h2 id="modal-title">Dodaj nowy rekord</h2>
                <p style="color: red; height: 1.5em;" id="modal-error"></p>
                <form id="modal-form"></form>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn-save" id="save-btn">ZAPISZ</button>
                    <button id="delete-btn" style="display: none; background-color: #dc3545; color: white; border: none; padding: 10px; border-radius: 4px;">USU≈É</button>
                </div>
            </div>
        </div>



    <script>
        const mainContent = document.getElementById('main-content');
        const viewTitle = document.getElementById('view-title');
        const menuItems = document.querySelectorAll('.menu-item, .menu-subitem');
        const API_BASE = 'http://127.0.0.1:8000/api/';

        // Elementy Logowania (bez zmian)
        const loginContainer = document.getElementById('login-container');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const pin2faInput = document.getElementById('pin_2fa');
        const loginError = document.getElementById('login-error');
        const userRoleDisplay = document.getElementById('user-role-display');
        const logoutBtn = document.getElementById('logout-btn');

        // Elementy Modalu (NOWE)
        const modal = document.getElementById('data-modal');
        const closeModalBtn = document.querySelector('.close-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalForm = document.getElementById('modal-form');
        const modalError = document.getElementById('modal-error');
        const saveBtn = document.getElementById('save-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const addBtn = document.getElementById('add-btn');

        let currentView = 'vehicles'; // ≈öledzenie aktualnego widoku
        let currentRecordId = null; // ID rekordu do edycji/usuniƒôcia

        // --- FUNKCJE POMOCNICZE (TOKENY, LOGOUT, LOGIN - BEZ ZMIAN) ---

        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_role');
            loginContainer.style.display = 'flex';
            mainApp.style.display = 'none';
        }

        logoutBtn.addEventListener('click', handleLogout);

        async function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = '';
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const pin_2fa = pin2faInput.value;
            try {
                const response = await fetch(API_BASE + 'login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ username, password, pin_2fa }),
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user_role', data.user_role);
                    loginContainer.style.display = 'none';
                    mainApp.style.display = 'flex';
                    userRoleDisplay.textContent = data.user_role;
                    loginForm.reset();
                    pin2faInput.style.display = 'none';
                    loadView('vehicles');
                } else {
                    loginError.textContent = data.detail || 'WystƒÖpi≈Ç nieznany b≈ÇƒÖd logowania.';
                    if (username.toUpperCase().includes('ADMIN') || (data.detail && data.detail.includes('PIN 2FA'))) {
                         pin2faInput.style.display = 'block';
                         pin2faInput.focus();
                    } else {
                         pin2faInput.style.display = 'none';
                    }
                }
            } catch (error) {
                loginError.textContent = 'B≈ÇƒÖd sieci. Sprawd≈∫, czy serwer Django dzia≈Ça na porcie 8000.';
            }
        }
        loginForm.addEventListener('submit', handleLogin);

        // Funkcje prze≈ÇƒÖczania widok√≥w
        function showRegister() {
            // Ukrywamy box logowania, pokazujemy box rejestracji
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('register-box').style.display = 'block';
        }

        function showLogin() {
            // Ukrywamy box rejestracji, pokazujemy box logowania
            document.getElementById('login-box').style.display = 'block';
            document.getElementById('register-box').style.display = 'none';
        }

        // Obs≈Çuga wysy≈Çania rejestracji do Django
        async function handleRegister() {
            const username = document.getElementById('reg_username').value;
            const email = document.getElementById('reg_email').value;
            const password = document.getElementById('reg_password').value;
            const rola = document.getElementById('reg_role').value;
            const first_name = document.getElementById('reg_first_name').value; // NOWE
            const last_name = document.getElementById('reg_last_name').value;   // NOWE
            const errorElem = document.getElementById('register-error');


            // Reset b≈Çƒôdu przed wys≈Çaniem
            errorElem.textContent = "";

            try {
                const response = await fetch('http://127.0.0.1:8000/api/register/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, rola, first_name, last_name })
                });

                const data = await response.json();

                if (response.ok) {
                    alert("Konto utworzone pomy≈õlnie! Teraz mo≈ºesz siƒô zalogowaƒá.");
                    showLogin(); // Automatyczny powr√≥t do ekranu logowania
                } else {
                    // Wy≈õwietlenie b≈Çƒôdu z serwera (np. "U≈ºytkownik ju≈º istnieje")
                    errorElem.textContent = data.detail || "B≈ÇƒÖd rejestracji";
                }
            } catch (error) {
                errorElem.textContent = "B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.";
            }
        }

        // --- FUNKCJE DLA MODALU (DODAWANIE/EDYCJA/USUNIƒòCIE) ---

        closeModalBtn.onclick = () => { modal.style.display = "none"; };
        window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };

        // Mapowanie widok√≥w do endpoint√≥w API
        const endpointMap = {
            'vehicles': 'vehicles',
            'drivers': 'drivers',
            'damages': 'damage_events',
            'inspection': 'service_events',
            'repairs': 'service_events',
            'reviews': 'service_events',
            'tech_inspections': 'service_events',
            'legalization': 'service_events',
            'policies': 'policies',
            // Kalendarz bƒôdzie u≈ºywa≈Ç dynamicznie 'service_events' lub 'policies'
            'calendar': null
        };

        // Dodawanie rekordu
        addBtn.addEventListener('click', () => openModal(currentView));

        // NOWA FUNKCJA: Pobieranie listy pojazd√≥w
        async function fetchVehicles() {
            try {
                const response = await fetch(API_BASE + 'vehicles/', { headers: getAuthHeaders() });
                if (response.status === 401) { handleLogout(); return []; }
                if (!response.ok) throw new Error(response.statusText);
                return await response.json();
            } catch (error) {
                console.error("B≈ÇƒÖd pobierania listy pojazd√≥w:", error);
                return [];
            }
        }

        // NOWA FUNKCJA: Dynamiczna zmiana p√≥l formularza w Terminarzu
        function updateFormFields(eventType) {
            const container = document.getElementById('dynamic-fields-container');
            let fieldsHtml = '';

            if (eventType === 'POLICY_OC') {
                 // Pola dla Polisy
                 fieldsHtml = `
                    <label for="numer_polisy_val">Numer Polisy:</label>
                    <input type="text" id="numer_polisy_val" required>

                    <label for="data_waznosci_ac_val">Data Wa≈ºno≈õci AC (opcjonalnie):</label>
                    <input type="date" id="data_waznosci_ac_val">
                 `;
            } else {
                 // Pola dla ServiceEvent
                 fieldsHtml = `
                    <label for="opis_zdarzenia_val">Opis Zdarzenia:</label>
                    <textarea id="opis_zdarzenia_val" required></textarea>

                    <label for="koszt_val">Koszt (PLN, opcjonalnie):</label>
                    <input type="number" id="koszt_val" step="0.01" value="0">
                 `;
            }
            container.innerHTML = fieldsHtml;
        }
        window.updateFormFields = updateFormFields; // Udostƒôpnienie do eventu 'onchange' w HTML


        /** Otwiera modal i ≈Çaduje odpowiedni formularz */
        async function openModal(viewName, record = null) {
            currentRecordId = record ? record.id : null;
            modalTitle.textContent = currentRecordId ? `Edytuj rekord (${viewName})` : `Dodaj nowy rekord (${viewName})`;
            modalError.textContent = '';
            modalForm.innerHTML = '';
            deleteBtn.style.display = currentRecordId ? 'inline' : 'none';

            let formHtml = '';
            const isCalendarEventView = ['calendar', 'policies', 'tech_inspections', 'reviews', 'repairs', 'legalization', 'inspection'].includes(viewName);

            // LOGIKA DLA UNIWERSALNEGO FORMULARZA TERMINARZA (NOWY TERMIN)
            if (isCalendarEventView && !currentRecordId) {
                modalTitle.textContent = `Dodaj Nowy Termin/Zdarzenie`;

                // Dynamiczne pobranie pojazd√≥w do dropdown
                const vehicles = await fetchVehicles();
                const vehicleOptions = vehicles.map(v => `<option value="${v.id}">${v.registration_number} (ID: ${v.id})</option>`).join('');

                formHtml = `
                    <label for="event_type_selector">Rodzaj Zdarzenia:</label>
                    <select id="event_type_selector" required onchange="updateFormFields(this.value)">
                        <option value="" disabled selected>-- Wybierz rodzaj --</option>
                        <option value="BADANIE_TECH">Badanie Techniczne</option>
                        <option value="PRZEGLAD">PrzeglƒÖd Okresowy</option>
                        <option value="NAPRAWA">Naprawa</option>
                        <option value="INSPEKCJA">Inspekcja</option>
                        <option value="LEGALIZACJA">Legalizacja</option>
                        <option value="POLICY_OC">Polisa OC/AC</option>
                    </select>

                    <label for="pojazd_id_selector">Pojazd:</label>
                    <select id="pojazd_id_selector" required>
                        <option value="" disabled selected>-- Wybierz pojazd --</option>
                        ${vehicleOptions}
                    </select>

                    <div id="dynamic-fields-container">
                        </div>

                    <label for="data_terminu">Data Terminu (Wa≈ºno≈õci/Serwisu):</label>
                    <input type="date" id="data_terminu" required>
                `;
            }
            // POZOSTA≈ÅA LOGIKA FORMULARZA (EDYCJA ORAZ DODAWANIE W INNYCH WIDOKACH)
            else if (viewName === 'vehicles') {
                const sel = (val) => (record && record.fuel_type === val) ? 'selected' : '';
                formHtml = `
                    <label for="reg_num">Nr Rejestracyjny:</label>
                    <input type="text" id="reg_num" value="${record ? record.registration_number : ''}" required>

                    <label for="vin_num">VIN:</label>
                    <input type="text" id="vin_num" value="${record ? record.vin : ''}" required>

                    <label for="fuel_type_input">Rodzaj Paliwa:</label>
                    <select id="fuel_type_input" required>
                        <option value="BENZYNA" ${sel('BENZYNA')}>Benzyna</option>
                        <option value="DIESEL" ${sel('DIESEL')}>Diesel</option>
                        <option value="ELECTRIC" ${sel('ELECTRIC')}>Elektryczny</option>
                        <option value="HYBRID" ${sel('HYBRID')}>Hybryda</option>
                        <option value="PHEV" ${sel('PHEV')}>Hybryda Plug-in</option>
                        <option value="LPG" ${sel('LPG')}>LPG</option>
                        <option value="CNG" ${sel('CNG')}>CNG</option>
                        <option value="HYDROGEN" ${sel('HYDROGEN')}>Wodorowy</option>
                    </select>

                    <label for="przebieg_val">Przebieg (km):</label>
                    <input type="number" id="przebieg_val" value="${record ? record.przebieg : ''}" required>

                    <label for="company_id">ID Firmy (wymagane):</label>
                    <input type="number" id="company_id" value="${record ? record.company : ''}" required>
                `;
            }
            else if (viewName === 'damages') {
                formHtml = `
                    <label for="pojazd_id">ID Pojazdu:</label>
                    <input type="number" id="pojazd_id" value="${record ? record.pojazd : ''}" required>
                    <label for="opis_szkody">Opis:</label>
                    <textarea id="opis_szkody" required>${record ? record.opis : ''}</textarea>
                    <label for="data_zdarzenia_val">Data Zdarzenia:</label>
                    <input type="date" id="data_zdarzenia_val" value="${record ? record.data_zdarzenia : ''}" required>
                    <label for="status_naprawy_val">Status:</label>
                    <select id="status_naprawy_val">
                        <option value="ZGLOSZONA" ${record && record.status_naprawy === 'ZGLOSZONA' ? 'selected' : ''}>Zg≈Çoszona</option>
                        <option value="W_NAPRAWIE" ${record && record.status_naprawy === 'W_NAPRAWIE' ? 'selected' : ''}>W naprawie</option>
                        <option value="ZAMKNIETA" ${record && record.status_naprawy === 'ZAMKNIETA' ? 'selected' : ''}>Zamkniƒôta</option>
                    </select>
                `;
            }
            else if (viewName === 'drivers') {
                formHtml = `
                    <label>Numer Prawa Jazdy:</label>
                    <input type="text" id="prawa_jazdy_num" value="${record ? record.numer_prawa_jazdy : ''}">
                    <label>Kategorie:</label>
                    <input type="text" id="kat_prawa_jazdy" value="${record ? record.kategorie_prawa_jazdy : 'B'}">
                    <label>Wa≈ºno≈õƒá bada≈Ñ lekarskich:</label>
                    <input type="date" id="data_badan_val" value="${record ? record.data_waznosci_badan : ''}">
                `;
            }
            // Logika edycji zdarzenia serwisowego lub polisy - uproszczona (mo≈ºna rozbudowaƒá, ale na razie u≈ºywamy starych formularzy, je≈õli to edycja)
            else if (isCalendarEventView && currentRecordId) {
                 // U≈ºywamy starej logiki edycji
                 const endpointForType = endpointMap[viewName];
                 if (endpointForType === 'service_events') {
                      const typeMap = {
                        'inspection': 'INSPEKCJA',
                        'repairs': 'NAPRAWA',
                        'reviews': 'PRZEGLAD',
                        'tech_inspections': 'BADANIE_TECH',
                        'legalization': 'LEGALIZACJA'
                      };
                      const currentType = typeMap[viewName] || record.typ_zdarzenia; // U≈ºywamy typu z rekordu, je≈õli to edycja

                      formHtml = `
                        <input type="hidden" id="typ_zdarzenia_val" value="${currentType}">
                        <label for="pojazd_id">ID Pojazdu:</label>
                        <input type="number" id="pojazd_id" value="${record ? record.pojazd : ''}" required>

                        <label for="opis_serwisu">Opis:</label>
                        <textarea id="opis_serwisu" required>${record ? record.opis : ''}</textarea>

                        <label for="koszt_val">Koszt (PLN):</label>
                        <input type="number" id="koszt_val" step="0.01" value="${record ? record.koszt : ''}" required>

                        <label for="data_serwisu_val">Data Zdarzenia:</label>
                        <input type="date" id="data_serwisu_val" value="${record ? record.data_serwisu : ''}" required>
                    `;
                 } else if (endpointForType === 'policies') {
                      formHtml = `
                            <label for="pojazd_id">ID Pojazdu:</label>
                            <input type="number" id="pojazd_id" value="${record ? record.pojazd : ''}" required>
                            <label for="numer_polisy">Numer Polisy:</label>
                            <input type="text" id="numer_polisy" value="${record ? record.numer_polisy : ''}" required>
                            <label for="data_waznosci_oc">Data Wa≈ºno≈õci OC:</label>
                            <input type="date" id="data_waznosci_oc" value="${record ? record.data_waznosci_oc : ''}" required>
                            <label for="data_waznosci_ac">Data Wa≈ºno≈õci AC (opcjonalnie):</label>
                            <input type="date" id="data_waznosci_ac" value="${record ? record.data_waznosci_ac : ''}">
                        `;
                 }
            }

            modalForm.innerHTML = formHtml;
            modal.style.display = "block";
        }


        /** Obs≈Çuguje logikƒô zapisu (POST - dodawanie / PUT - edycja) */
        async function handleSave() {
            modalError.textContent = '';

            // 1. Sprawdzamy, czy to jest formularz uniwersalny dodawania (z Terminarza)
            const eventTypeSelector = document.getElementById('event_type_selector');
            let data = {};
            let endpoint = endpointMap[currentView] || currentView;
            let method = currentRecordId ? 'PUT' : 'POST';
            let url = currentRecordId ? `${API_BASE}${endpoint}/${currentRecordId}/` : `${API_BASE}${endpoint}/`;

            if (eventTypeSelector && !currentRecordId) {
                // LOGIKA ZAPISU DLA NOWEGO TERMINU Z KALENDARZA
                const selectedType = eventTypeSelector.value;
                const pojazdId = document.getElementById('pojazd_id_selector').value;
                const dataTerminu = document.getElementById('data_terminu').value;

                if (!selectedType || !pojazdId || !dataTerminu) {
                    modalError.textContent = "Proszƒô wype≈Çniƒá wszystkie wymagane pola (Typ, Pojazd, Data).";
                    return;
                }

                if (selectedType === 'POLICY_OC') {
                     // Zapis Polisy
                     const numerPolisy = document.getElementById('numer_polisy_val').value;
                     const dataWaznosciAC = document.getElementById('data_waznosci_ac_val').value;

                     data = {
                        pojazd: pojazdId,
                        numer_polisy: numerPolisy,
                        data_waznosci_oc: dataTerminu,
                        data_waznosci_ac: dataWaznosciAC || null
                     };
                     endpoint = 'policies';
                } else {
                     // Zapis ServiceEvent
                     const opis = document.getElementById('opis_zdarzenia_val').value;
                     const koszt = document.getElementById('koszt_val').value || 0;

                     data = {
                        pojazd: pojazdId,
                        opis: opis,
                        koszt: koszt,
                        data_serwisu: dataTerminu,
                        typ_zdarzenia: selectedType
                     };
                     endpoint = 'service_events';
                }

                method = 'POST';
                url = `${API_BASE}${endpoint}/`;
            }
            // 2. Logika dla istniejƒÖcych formularzy (edytowanie lub dodawanie w innych widokach)
            else if (currentView === 'vehicles') {
                data = {
                    registration_number: document.getElementById('reg_num').value,
                    vin: document.getElementById('vin_num').value,
                    fuel_type: document.getElementById('fuel_type_input').value, // NOWE
                    przebieg: document.getElementById('przebieg_val').value,
                    company: document.getElementById('company_id').value,
                    is_active: true
                };
            }
            else if (currentView === 'damages') {
                data = {
                    pojazd: document.getElementById('pojazd_id').value,
                    opis: document.getElementById('opis_szkody').value,
                    data_zdarzenia: document.getElementById('data_zdarzenia_val').value,
                    status_naprawy: document.getElementById('status_naprawy_val').value,
                    szacowany_koszt: 0
                };
            }
            else if (endpoint === 'service_events' && currentRecordId) { // Edycja ServiceEvent
                 data = {
                    pojazd: document.getElementById('pojazd_id').value,
                    opis: document.getElementById('opis_serwisu').value,
                    koszt: document.getElementById('koszt_val').value,
                    data_serwisu: document.getElementById('data_serwisu_val').value,
                    typ_zdarzenia: document.getElementById('typ_zdarzenia_val').value
                 };
            }
            else if (currentView === 'policies' && currentRecordId) { // Edycja Polisy
                 data = {
                    pojazd: document.getElementById('pojazd_id').value,
                    numer_polisy: document.getElementById('numer_polisy').value,
                    data_waznosci_oc: document.getElementById('data_waznosci_oc').value,
                    data_waznosci_ac: document.getElementById('data_waznosci_ac').value || null
                 };
            }


            // 3. Wykonanie zapisu
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });

                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }

                if (response.ok) {
                    modal.style.display = "none";

                    // Po dodaniu terminu, prze≈Çadowujemy widok kalendarza, aby zobaczyƒá ramkƒô.
                    if (eventTypeSelector && !currentRecordId) {
                        loadView('calendar');
                    } else {
                        loadView(currentView);
                    }
                } else {
                    const errorData = await response.json();
                    modalError.textContent = `B≈ÇƒÖd ${response.status}: ${JSON.stringify(errorData)}`;
                }

            } catch (error) {
                modalError.textContent = `B≈ÇƒÖd sieci: ${error.message}`;
            }
        }

        saveBtn.onclick = handleSave;


        /** Obs≈Çuguje logikƒô usuwania (DELETE) - bez zmian */
        async function handleDelete() {
            if (!currentRecordId || !confirm(`Czy na pewno chcesz usunƒÖƒá rekord o ID: ${currentRecordId}?`)) {
                return;
            }

            const endpoint = endpointMap[currentView] || currentView;
            const url = `${API_BASE}${endpoint}/${currentRecordId}/`;

            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }

                if (response.status === 204) {
                    modal.style.display = "none";
                    loadView(currentView);
                } else {
                    modalError.textContent = `B≈ÇƒÖd usuwania (Status: ${response.status}).`;
                }

            } catch (error) {
                modalError.textContent = `B≈ÇƒÖd sieci podczas usuwania: ${error.message}`;
            }
        }

        deleteBtn.onclick = handleDelete;


        // --- FUNKCJE RENDERUJƒÑCE WIDOKI ---

        // Helper dla generowania przycisk√≥w
        function getActionButtons(record, viewName) {
            return `<button onclick="openModal('${viewName}', ${JSON.stringify(record).replace(/"/g, '&quot;')})">Edytuj</button>`;
        }

        // ... (renderVehicles, renderDrivers, renderServiceEvents, renderDamageEvents, renderPolicies - bez zmian) ...
        // Uwaga: Dla oszczƒôdno≈õci miejsca pomijam powtarzanie tych funkcji, ale w rzeczywistym kodzie one muszƒÖ byƒá.

        // Zmodyfikowana funkcja, aby upewniƒá siƒô, ≈ºe inne widoki dzia≈ÇajƒÖ
        async function renderVehicles() {
             currentView = 'vehicles';
             viewTitle.textContent = 'Pojazdy';
             mainContent.innerHTML = `<div class="table-header" style="grid-template-columns: 50px 1fr 1fr 1fr 1fr 1fr 1fr 120px;">
                <div>Lp.</div>
                <div>Nr Rej.</div>
                <div>VIN</div>
                <div>Paliwo</div> <div>Przebieg</div>
                <div>Firma</div>
                <div>Status</div>
                <div>Akcje</div>
                </div><div id="data-list">≈Åadowanie pojazd√≥w...</div>`;
             const dataListDiv = document.getElementById('data-list');
             try {
                 const response = await fetch(API_BASE + 'vehicles/', { headers: getAuthHeaders() });
                 if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                 if (!response.ok) throw new Error(response.statusText);
                 const vehicles = await response.json();
                 dataListDiv.innerHTML = '';
                 vehicles.forEach((vehicle, index) => {
                     const statusColor = vehicle.is_active ? 'green' : '#ffc107';
                     const statusText = vehicle.is_active ? 'Aktywny' : 'Serwis';
                     const companyName = vehicle.company_name || 'Brak Firmy';
                     const paliwo = vehicle.fuel_type_display || vehicle.fuel_type || '-';
                     const row = document.createElement('div');
                     row.className = 'table-row';
                     row.style.gridTemplateColumns = "50px 1fr 1fr 1fr 1fr 1fr 1fr 120px";
                     row.innerHTML = `
                     <div>${index + 1}.</div>
                     <div>${vehicle.registration_number}</div>
                     <div>${vehicle.vin}</div>
                     <div>${paliwo}</div> <div>${vehicle.przebieg ? vehicle.przebieg.toLocaleString() : 'N/A'} km</div>
                     <div>${companyName}</div>
                     <div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>
                     <div>${getActionButtons(vehicle, 'vehicles')}</div>
                 `;
                 dataListDiv.appendChild(row);
             });
             } catch (error) {
                 dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}. Brak danych lub brak autoryzacji.</div>`;
             }
         }

         // Funkcja renderujƒÖca zdarzenia serwisowe (potrzebna dla podmenu)
         async function renderServiceEvents(filterType = null) {
            const filterMap = {
                'inspection': {title: 'Inspekcje', type: 'INSPEKCJA'},
                'repairs': {title: 'Naprawy', type: 'NAPRAWA'},
                'reviews': {title: 'PrzeglƒÖdy Okresowe', type: 'PRZEGLAD'},
                'tech_inspections': {title: 'Badania Techniczne', type: 'BADANIE_TECH'},
                'legalization': {title: 'Legalizacje', type: 'LEGALIZACJA'}
            };
            const currentFilter = filterMap[filterType] || {title: 'Zdarzenia Serwisowe', type: null};
            currentView = filterType || 'service_events';
            viewTitle.textContent = currentFilter.title;
            mainContent.innerHTML = `<div class="table-header-sm"><div>Lp.</div><div>Pojazd (Nr Rej.)</div><div>Opis Zdarzenia</div><div>Koszt</div><div>Data Serwisu</div><div>Akcje</div></div><div id="data-list">≈Åadowanie zdarze≈Ñ...</div>`;
            const dataListDiv = document.getElementById('data-list');
            try {
                const response = await fetch(API_BASE + 'service_events/', { headers: getAuthHeaders() });
                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                if (!response.ok) throw new Error(response.statusText);
                let events = await response.json();
                if (currentFilter.type) {
                     events = events.filter(e => e.typ_zdarzenia === currentFilter.type);
                }
                dataListDiv.innerHTML = '';
                events.forEach((event, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.innerHTML = `<div>${index + 1}.</div><div>${event.pojazd_nr_rej}</div><div>${event.opis}</div><div>${event.koszt} PLN</div><div>${event.data_serwisu}</div><div>${getActionButtons(event, currentView)}</div>`;
                    dataListDiv.appendChild(row);
                });
            } catch (error) {
                dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}. Brak danych lub brak autoryzacji.</div>`;
            }
        }

        async function renderPolicies() {
             currentView = 'policies';
             viewTitle.textContent = 'Polisy Ubezpieczeniowe';
             mainContent.innerHTML = `<div class="table-header-sm"><div>Lp.</div><div>Pojazd (Nr Rej.)</div><div>Numer Polisy</div><div>Wa≈ºno≈õƒá OC</div><div>Wa≈ºno≈õƒá AC</div><div>Akcje</div></div><div id="data-list">≈Åadowanie danych polis...</div>`;
             const dataListDiv = document.getElementById('data-list');
             try {
                 const response = await fetch(API_BASE + 'policies/', { headers: getAuthHeaders() });
                 if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                 if (!response.ok) throw new Error(response.statusText);
                 const policies = await response.json();
                 dataListDiv.innerHTML = '';
                 policies.forEach((policy, index) => {
                     const row = document.createElement('div');
                     row.className = 'table-row-sm';
                     row.innerHTML = `<div>${index + 1}.</div><div>${policy.pojazd_nr_rej}</div><div>${policy.numer_polisy}</div><div>${policy.data_waznosci_oc}</div><div>${policy.data_waznosci_ac || 'Brak'}</div><div>${getActionButtons(policy, 'policies')}</div>`;
                     dataListDiv.appendChild(row);
                 });
             } catch (error) {
                 dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}. <p style="color: #007bff;">Modu≈Ç Polisy oczekuje na implementacjƒô endpointu API: <strong style="font-size: 1.1em;">/api/policies/</strong>.</p></div>`;
             }
         }

                 // Funkcje dla innych widok√≥w - placeholdery
                 // Widok Kierowc√≥w
        async function renderDrivers() {
            viewTitle.textContent = 'U≈ºytkownicy (Kierowcy)';
            const token = localStorage.getItem('access_token');

            // Przygotowanie tabeli
            mainContent.innerHTML = `
                <div class="table-header" style="grid-template-columns: 50px 1fr 1fr 1fr 1fr 120px 120px;">
                    <div>Lp.</div>
                    <div>Kierowca</div>
                    <div>Nr Pr. Jazdy</div>
                    <div>Kategorie</div>
                    <div>Wa≈ºno≈õƒá PJ</div>
                    <div>Badania lek.</div>
                    <div>Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie...</div>
            `;

            try {
                const response = await fetch('http://127.0.0.1:8000/api/drivers/', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const drivers = await response.json();
                const dataListDiv = document.getElementById('data-list');
                dataListDiv.innerHTML = '';

                drivers.forEach((driver, index) => {
                    // Sprawdzanie czy badania sƒÖ aktualne
                    const dzis = new Date();
                    const dataBadan = driver.data_waznosci_badan ? new Date(driver.data_waznosci_badan) : null;
                    const czyPrzeterminowane = dataBadan && dataBadan < dzis;

                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.style.gridTemplateColumns = "50px 1fr 1fr 1fr 1fr 120px 120px";
                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div><strong>${driver.user_name}</strong></div>
                        <div>${driver.numer_prawa_jazdy}</div>
                        <div>${driver.kategorie_prawa_jazdy || 'B'}</div>
                        <div>${driver.data_waznosci_prawa_jazdy}</div>
                        <div style="color: ${czyPrzeterminowane ? 'red' : 'green'}; font-weight: bold;">
                            ${driver.data_waznosci_badan || 'Brak'}
                        </div>
                        <div>${getActionButtons(driver, 'drivers')}</div>
                    `;
                    dataListDiv.appendChild(row);
                });
            } catch (err) {
                document.getElementById('data-list').innerHTML = "B≈ÇƒÖd ≈Çadowania: " + err;
            }
        }

        // Widok Szk√≥d
        async function renderDamageEvents() {
            viewTitle.textContent = 'Zdarzenia Szkodowe i Awarie';
            const token = localStorage.getItem('access_token');
            mainContent.innerHTML = `
                <div class="table-header" style="grid-template-columns: 50px 120px 1fr 150px 150px 120px;">
                    <div>Lp.</div>
                    <div>Nr Rej.</div>
                    <div>Opis Szkody</div>
                    <div>Data</div>
                    <div>Status</div>
                    <div>Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie szk√≥d...</div>
            `;

            const dataListDiv = document.getElementById('data-list');

            try {
                const response = await fetch('http://127.0.0.1:8000/api/damage_events/', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const damages = await response.json();

                dataListDiv.innerHTML = '';
                damages.forEach((damage, index) => {
                    const statusMap = {
                        'ZGLOSZONA': { txt: 'Zg≈Çoszona', col: '#ffc107' },
                        'W_NAPRAWIE': { txt: 'W naprawie', col: '#17a2b8' },
                        'ZAMKNIETA': { txt: 'Zamkniƒôta', col: '#28a745' }
                    };
                    const status = statusMap[damage.status_naprawy] || { txt: damage.status_naprawy, col: '#6c757d' };

                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.style.gridTemplateColumns = "50px 120px 1fr 150px 150px 120px";
                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div>${damage.pojazd_nr_rej}</div>
                        <div>${damage.opis}</div>
                        <div>${damage.data_zdarzenia}</div>
                        <div style="color: ${status.col}; font-weight: bold;">${status.txt}</div>
                        <div>${getActionButtons(damage, 'damages')}</div>
                    `;
                    dataListDiv.appendChild(row);
                });
            } catch (err) {
                dataListDiv.innerHTML = `<p style="color:red;">B≈ÇƒÖd: ${err.message}</p>`;
            }
        }
         function renderPlaceholder(title) {
             currentView = title;
             viewTitle.textContent = title;
             mainContent.innerHTML = `<div style="padding: 40px; text-align: center; color: #6c757d;">
                 <h2>${title}</h2>
                 <p>Ten modu≈Ç wymaga osobnego endpointu API Django, modelu i logiki biznesowej. Front-end jest gotowy!</p>
             </div>`;
         }


        // --- NOWA LOGIKA DLA KALENDARZA ---

        let currentDate = new Date(); // Globalna zmienna do ≈õledzenia aktualnego miesiƒÖca

        /**
         * Pobiera wszystkie zdarzenia terminowe, kt√≥re powinny byƒá wy≈õwietlone w kalendarzu.
         */
        async function fetchCalendarEvents() {
            const headers = getAuthHeaders();
            let events = [];

            try {
                // 1. Pobierz Zdarzenia Serwisowe
                const serviceResponse = await fetch(API_BASE + 'service_events/', { headers });
                if (serviceResponse.ok) {
                    const serviceEvents = await serviceResponse.json();
                    serviceEvents.forEach(e => {
                        if (e.data_serwisu) {
                            let type;
                            if (e.typ_zdarzenia.toLowerCase().includes('przeglad')) {
                                type = 'review';
                            } else if (e.typ_zdarzenia.toLowerCase().includes('naprawa')) {
                                type = 'repair';
                            } else {
                                type = 'inspection'; // Badanie, Inspekcja, Legalizacja
                            }
                            events.push({
                                date: e.data_serwisu,
                                title: `${e.pojazd_nr_rej} - ${e.typ_zdarzenia}`,
                                type: type,
                                record: e
                            });
                        }
                    });
                }

                // 2. Pobierz Polisy
                const policyResponse = await fetch(API_BASE + 'policies/', { headers });
                if (policyResponse.ok) {
                    const policies = await policyResponse.json();
                    policies.forEach(p => {
                        // OC
                        if (p.data_waznosci_oc) {
                            events.push({
                                date: p.data_waznosci_oc,
                                title: `${p.pojazd_nr_rej} - Wa≈ºno≈õƒá OC`,
                                type: 'policy',
                                record: p
                            });
                        }
                        // AC (je≈õli istnieje)
                        if (p.data_waznosci_ac && p.data_waznosci_ac !== 'Brak') {
                             events.push({
                                date: p.data_waznosci_ac,
                                title: `${p.pojazd_nr_rej} - Wa≈ºno≈õƒá AC`,
                                type: 'policy',
                                record: p
                            });
                        }
                    });
                }

            } catch (error) {
                console.error("B≈ÇƒÖd ≈Çadowania zdarze≈Ñ do kalendarza:", error);
            }

            return events;
        }


        /**
         * G≈Ç√≥wna funkcja renderujƒÖca Kalendarz
         */
        async function renderCalendar() {
            currentView = 'calendar';
            viewTitle.textContent = 'Terminarz Floty';

            const allEvents = await fetchCalendarEvents();
            generateCalendarHTML(allEvents, currentDate);
        }

        /**
         * Rysuje siatkƒô kalendarza.
         * ZMODYFIKOWANA o logikƒô ramki.
         */
        function generateCalendarHTML(events, displayDate) {
            mainContent.innerHTML = ''; // Czy≈õcimy zawarto≈õƒá
            const container = document.createElement('div');
            container.className = 'calendar-view';

            const year = displayDate.getFullYear();
            const month = displayDate.getMonth();

            const monthNames = ["Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec",
                                "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"];

            // Nag≈Ç√≥wek Kalendarza
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.innerHTML = `
                <button onclick="changeMonth(-1)">&#9664; Poprzedni</button>
                <span>${monthNames[month]} ${year}</span>
                <button onclick="changeMonth(1)">Nastƒôpny &#9654;</button>
            `;
            container.appendChild(header);

            // Siatka Kalendarza
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';

            const dayNames = ["Pon", "Wto", "≈öro", "Czw", "PiƒÖ", "Sob", "Nie"];
            dayNames.forEach(day => {
                const dayNameDiv = document.createElement('div');
                dayNameDiv.className = 'day-name';
                dayNameDiv.textContent = day;
                grid.appendChild(dayNameDiv);
            });

            const firstDayOfMonth = new Date(year, month, 1);
            const dayOfWeek = (firstDayOfMonth.getDay() === 0) ? 6 : firstDayOfMonth.getDay() - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Wype≈Çnianie pustymi polami na poczƒÖtku
            for (let i = 0; i < dayOfWeek; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Dodawanie dni miesiƒÖca
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day current-month';
                dayDiv.setAttribute('data-date', dateString);

                dayDiv.innerHTML = `<span class="calendar-day-number">${day}</span>`;

                const dayEvents = events.filter(e => e.date === dateString);

                // Zestaw klas do ramki (eliminacja duplikat√≥w)
                const borderClasses = new Set();

                dayEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    let borderClass = '';

                    if (event.type === 'policy') {
                        eventDiv.className = `event-item event-policy`;
                        borderClass = 'day-border-policy';
                    } else if (event.type === 'review') {
                        eventDiv.className = `event-item event-review`;
                        borderClass = 'day-border-review';
                    } else if (event.type === 'inspection') {
                        eventDiv.className = `event-item event-inspection`;
                        borderClass = 'day-border-inspection';
                    } else if (event.type === 'repair') {
                        eventDiv.className = `event-item event-repair`;
                        borderClass = 'day-border-repair';
                    } else {
                        eventDiv.className = `event-item`;
                    }

                    eventDiv.title = event.title;
                    eventDiv.textContent = event.title;
                    dayDiv.appendChild(eventDiv);

                    if (borderClass) {
                        borderClasses.add(borderClass);
                    }
                });

                // Dodanie unikalnych klas ramki (je≈õli jest wiele zdarze≈Ñ, dodajemy np. ramkƒô najpilniejszego)
                borderClasses.forEach(className => dayDiv.classList.add(className));

                grid.appendChild(dayDiv);
            }

            container.appendChild(grid);
            mainContent.appendChild(container);
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }
        window.changeMonth = changeMonth;


        // --- LOGIKA PRZE≈ÅƒÑCZANIA WIDOK√ìW I AUTORYZACJI ---

        const viewMap = {
            'vehicles': renderVehicles,
            'drivers': renderDrivers,        // Zmienione z renderPlaceholder
            'damages': renderDamageEvents,   // Zmienione z renderPlaceholder

            'inspection': () => renderServiceEvents('inspection'),
            'calendar': renderCalendar,

            'policies': renderPolicies,
            'tech_inspections': () => renderServiceEvents('tech_inspections'),
            'reviews': () => renderServiceEvents('reviews'),
            'repairs': () => renderServiceEvents('repairs'),
            'legalization': () => renderServiceEvents('legalization'),

            // Reszta mo≈ºe zostaƒá jako placeholder, dop√≥ki nie zrobimy dla nich modeli
            'handover': renderPlaceholder,
            'leasing': renderPlaceholder,
            'hr_docs': renderPlaceholder,
            'settlements': renderPlaceholder,
            'other': renderPlaceholder,
            'settings': renderPlaceholder,
        };

        function loadView(viewName) {
            menuItems.forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`[data-view="${viewName}"]`);
            if(activeItem) {
                activeItem.classList.add('active');
            }

            const parentView = activeItem ? activeItem.closest('.menu-item') : null;
            if (parentView) {
                parentView.classList.add('active');
            }

            // Logika ukrywania/pokazywania przycisku "DODAJ"
            const isCalendarRelated = ['calendar', 'policies', 'tech_inspections', 'reviews', 'repairs', 'legalization', 'inspection'].includes(viewName);

            // Przycisk DODAJ jest widoczny dla Pojazd√≥w i Terminarza (i jego podkategorii)
            if (viewName === 'vehicles' || isCalendarRelated) {
                addBtn.style.display = 'inline';
            } else {
                addBtn.style.display = 'inline'; // Domy≈õlnie zostawiamy w≈ÇƒÖczony
            }


            viewMap[viewName]();
            currentView = viewName;
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                if (localStorage.getItem('access_token')) {
                    loadView(item.dataset.view);
                }
            });
        });

        function checkAuthentication() {
            const accessToken = localStorage.getItem('access_token');
            const userRole = localStorage.getItem('user_role');

            if (accessToken && userRole) {
                loginContainer.style.display = 'none';
                mainApp.style.display = 'flex';
                userRoleDisplay.textContent = userRole;
                loadView('vehicles');
            } else {
                loginContainer.style.display = 'flex';
                mainApp.style.display = 'none';
            }
        }

        checkAuthentication();
    </script>

</body>
</html>