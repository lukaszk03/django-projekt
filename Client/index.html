<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>NAVIFLEET - Pe≈Çny Interfejs Floty</title>
    <style>
        /* CSS dla ca≈Çego uk≈Çadu */
        body {
            display: flex;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            width: 100%;
            height: 100vh;
        }

        /* --- STYLY DLA LOGOWANIA --- */
        .login-container {
            display: none; /* Domy≈õlnie ukryte, JavaScript to poka≈ºe, je≈õli niezalogowany */
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            background-color: #e9ecef;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 350px;
            text-align: center;
        }
        .login-box input[type="text"],
        .login-box input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 8px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .login-box button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }

        /* --- STYLY DLA G≈Å√ìWNEJ APLIKACJI --- */
        .main-app {
            display: none; /* Domy≈õlnie ukryte, JavaScript to poka≈ºe, je≈õli zalogowany */
            width: 100%;
            height: 100vh;
            display: flex; /* Ustawienie flex jest kluczowe dla uk≈Çadu sidebar/content */
        }
        .sidebar { width: 250px; background-color: #ffffff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); padding-top: 20px; min-height: 100vh; overflow-y: auto; }
        .menu-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; color: #333; }
        .menu-item:hover, .menu-item.active { background-color: #e6f7ff; color: #007bff; font-weight: bold; }
        .menu-subitem { padding: 8px 20px 8px 45px; cursor: pointer; color: #555; font-size: 13px; }
        .menu-subitem:hover, .menu-subitem.active { background-color: #f0f8ff; color: #007bff; }
        .content-area { flex-grow: 1; padding: 20px 40px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h1 { margin: 0; font-size: 24px; }
        .btn-add { background-color: #28a745; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .table-container { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .table-header, .table-row { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 1fr 100px; padding: 12px 0; border-bottom: 1px solid #ddd; }
        .table-header { font-weight: bold; background-color: #e9ecef; }
        .table-header-sm, .table-row-sm { display: grid; grid-template-columns: 50px 1.5fr 1fr 1.5fr 1fr; padding: 12px 0; border-bottom: 1px solid #ddd; }
        .table-header-sm { font-weight: bold; background-color: #e9ecef; }
        .error { color: red; text-align: center; padding: 20px; font-size: 1.1em; }

        /* Styl dla przycisku wylogowania */
        #logout-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            width: 100%;
            text-align: left;
            padding: 12px 20px;
        }
        #logout-btn:hover {
            background-color: #ffeaea;
        }
    </style>
</head>
<body>

    <div class="login-container" id="login-container">
        <div class="login-box">
            <h2>Logowanie do NAVIFLEET</h2>
            <p style="color: red; height: 1.5em;" id="login-error"></p>
            <form id="login-form">
                <input type="text" id="username" placeholder="Nazwa u≈ºytkownika" required>
                <input type="password" id="password" placeholder="Has≈Ço" required>
                <input type="password" id="pin_2fa" placeholder="PIN 2FA (tylko Admin)" style="display: none;">
                <button type="submit">Zaloguj</button>
            </form>
        </div>
    </div>

    <div class="main-app" id="main-app">
        <div class="sidebar">
            <div style="padding: 10px 20px; font-size: 1.5em; color: #007bff; font-weight: 900;">NAVIFLEET</div>
            <div class="menu-item active" data-view="vehicles">
                <span>üöó Pojazdy</span>
                <span style="margin-left: auto; background: red; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">2</span>
            </div>
            <div class="menu-item" data-view="users">üë• U≈ºytkownicy</div>
            <div class="menu-item" data-view="handover">‚áå Przekazania</div>
            <div class="menu-item" data-view="inspection">üìú Inspekcje</div>
            <div class="menu-item" data-view="damages">‚ö†Ô∏è Szkody</div>

            <div class="menu-item" data-view="calendar">üìÖ Terminarz</div>
            <div class="menu-subitem" data-view="policies">Polisy</div>
            <div class="menu-subitem" data-view="tech_inspections">Badania techniczne</div>
            <div class="menu-subitem" data-view="reviews">PrzeglƒÖdy</div>
            <div class="menu-subitem" data-view="repairs">Naprawy</div>
            <div class="menu-subitem" data-view="legalization">Legalizacje</div>

            <div class="menu-item" data-view="leasing">üßæ Leasingi</div>
            <div class="menu-item" data-view="hr_docs">üìÑ Dokumenty kadrowe</div>
            <div class="menu-item" data-view="settlements">üí∂ Rozliczenia</div>
            <div class="menu-item" data-view="other">üïí Pozosta≈Çe</div>

            <div class="menu-item" data-view="settings" style="margin-top: 30px;">‚öôÔ∏è Ustawienia</div>
            <button id="logout-btn">Wyloguj (rola: <span id="user-role-display"></span>)</button>
        </div>

        <div class="content-area">
            <div class="header">
                <h1 id="view-title">Pojazdy</h1>
                <button class="btn-add">‚ûï DODAJ</button>
            </div>

            <div class="table-container" id="main-content">
                </div>
        </div>
    </div>

    <script>
        const mainContent = document.getElementById('main-content');
        const viewTitle = document.getElementById('view-title');
        const menuItems = document.querySelectorAll('.menu-item, .menu-subitem');
        const API_BASE = 'http://127.0.0.1:8000/api/';

        // Elementy logowania
        const loginContainer = document.getElementById('login-container');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const pin2faInput = document.getElementById('pin_2fa');
        const loginError = document.getElementById('login-error');
        const userRoleDisplay = document.getElementById('user-role-display');
        const logoutBtn = document.getElementById('logout-btn');

        // --- FUNKCJE POMOCNICZE (TOKENY) ---

        /** Zwraca nag≈Ç√≥wki z tokenem Autoryzacyjnym JWT */
        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        /** Wywo≈Çuje wylogowanie */
        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_role');
            // Prze≈ÇƒÖcz na ekran logowania
            loginContainer.style.display = 'flex';
            mainApp.style.display = 'none';
        }

        logoutBtn.addEventListener('click', handleLogout);


        // --- FUNKCJA LOGOWANIA (KROK 3.2) ---

        async function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = '';

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const pin_2fa = pin2faInput.value;

            try {
                const response = await fetch(API_BASE + 'login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password, pin_2fa }),
                });

                const data = await response.json();

                if (response.ok) {
                    // Sukces logowania
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user_role', data.user_role);

                    // Prze≈ÇƒÖczenie widoku i wczytanie aplikacji
                    loginContainer.style.display = 'none';
                    mainApp.style.display = 'flex';
                    userRoleDisplay.textContent = data.user_role;

                    // Resetowanie formularza
                    loginForm.reset();
                    pin2faInput.style.display = 'none';

                    loadView('vehicles');
                } else {
                    // B≈ÇƒÖd
                    loginError.textContent = data.detail || 'WystƒÖpi≈Ç nieznany b≈ÇƒÖd logowania.';

                    // Je≈õli b≈ÇƒÖd wskazuje na konieczno≈õƒá 2FA (tylko dla Admina), poka≈º pole PIN
                    if (username.toUpperCase().includes('ADMIN') || data.detail.includes('PIN 2FA')) {
                         pin2faInput.style.display = 'block';
                         pin2faInput.focus();
                    } else {
                         pin2faInput.style.display = 'none';
                    }
                }
            } catch (error) {
                loginError.textContent = 'B≈ÇƒÖd sieci. Sprawd≈∫, czy serwer Django dzia≈Ça na porcie 8000.';
            }
        }

        loginForm.addEventListener('submit', handleLogin);


        // --- FUNKCJE RENDERUJƒÑCE WIDOKI (PO≈ÅƒÑCZENIE Z API - TERAZ Z TOKENEM) ---

        // 1. WIDOK POJAZDY
        async function renderVehicles() {
            viewTitle.textContent = 'Pojazdy';
            mainContent.innerHTML = `<div class="table-header"><div>Lp.</div><div>Nr Rej.</div><div>VIN</div><div>Przebieg</div><div>Firma</div><div>Status</div></div><div id="data-list">≈Åadowanie pojazd√≥w...</div>`;
            const dataListDiv = document.getElementById('data-list');
            try {
                // ZABEZPIECZONO: Dodajemy nag≈Ç√≥wek autoryzacyjny
                const response = await fetch(API_BASE + 'vehicles/', {
                    headers: getAuthHeaders()
                });
                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                if (!response.ok) throw new Error(response.statusText);
                const vehicles = await response.json();
                dataListDiv.innerHTML = '';

                vehicles.forEach((vehicle, index) => {
                    const statusColor = vehicle.is_active ? 'green' : '#ffc107';
                    const statusText = vehicle.is_active ? 'Aktywny' : 'Serwis';
                    // company_name jest teraz na DTO
                    const companyName = vehicle.company_name || 'Brak Firmy';

                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.innerHTML = `<div>${index + 1}.</div><div>${vehicle.registration_number}</div><div>${vehicle.vin}</div><div>${vehicle.przebieg ? vehicle.przebieg.toLocaleString() : 'N/A'} km</div><div>${companyName}</div><div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>`;
                    dataListDiv.appendChild(row);
                });
            } catch (error) {
                dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}. Brak danych lub brak autoryzacji.</div>`;
            }
        }

        // 2. WIDOK U≈ªYTKOWNICY (Kierowcy)
        async function renderUsers() {
            viewTitle.textContent = 'U≈ºytkownicy (Kierowcy)';
            mainContent.innerHTML = `<div class="table-header-sm"><div>Lp.</div><div>Nazwa U≈ºytkownika</div><div>Numer Prawa Jazdy</div><div>Wa≈ºno≈õƒá Prawa Jazdy</div><div>Status</div></div><div id="data-list">≈Åadowanie u≈ºytkownik√≥w...</div>`;
            const dataListDiv = document.getElementById('data-list');
            try {
                // ZABEZPIECZONO: Dodajemy nag≈Ç√≥wek autoryzacyjny
                const response = await fetch(API_BASE + 'drivers/', {
                    headers: getAuthHeaders()
                });
                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                if (!response.ok) throw new Error(response.statusText);
                const drivers = await response.json();
                dataListDiv.innerHTML = '';

                drivers.forEach((driver, index) => {
                    const statusColor = driver.aktywny ? 'green' : 'red';
                    const statusText = driver.aktywny ? 'Aktywny' : 'Nieaktywny';

                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.innerHTML = `<div>${index + 1}.</div><div>${driver.user_name}</div><div>${driver.numer_prawa_jazdy}</div><div>${driver.data_waznosci_prawa_jazdy}</div><div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>`;
                    dataListDiv.appendChild(row);
                });
            } catch (error) {
                dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}. Brak danych lub brak autoryzacji.</div>`;
            }
        }

        // 3. WIDOK INSPEKCJE (Serwisy) - U≈ºywa ServiceEvent
        async function renderServiceEvents() {
            viewTitle.textContent = 'Inspekcje, PrzeglƒÖdy i Naprawy';
            mainContent.innerHTML = `<div class="table-header-sm"><div>Lp.</div><div>Pojazd (Nr Rej.)</div><div>Opis Zdarzenia</div><div>Koszt</div><div>Data Serwisu</div></div><div id="data-list">≈Åadowanie zdarze≈Ñ serwisowych...</div>`;
            const dataListDiv = document.getElementById('data-list');
            try {
                // ZABEZPIECZONO: Dodajemy nag≈Ç√≥wek autoryzacyjny
                const response = await fetch(API_BASE + 'service_events/', {
                    headers: getAuthHeaders()
                });
                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                if (!response.ok) throw new Error(response.statusText);
                const events = await response.json();
                dataListDiv.innerHTML = '';

                events.forEach((event, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.innerHTML = `<div>${index + 1}.</div><div>${event.pojazd_nr_rej}</div><div>${event.opis}</div><div>${event.koszt} PLN</div><div>${event.data_serwisu}</div>`;
                    dataListDiv.appendChild(row);
                });
            } catch (error) {
                dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}. Brak danych lub brak autoryzacji.</div>`;
            }
        }


        // --- LOGIKA PRZE≈ÅƒÑCZANIA WIDOK√ìW I AUTORYZACJI ---

        // ... (fragment <script>) ...
        // --- LOGIKA PRZE≈ÅƒÑCZANIA WIDOK√ìW I AUTORYZACJI ---

        const viewMap = {
            'vehicles': renderVehicles,
            'users': renderUsers,
            'inspection': renderServiceEvents,
            'repairs': renderServiceEvents,

            'damages': renderDamageEvents, // UWAGA: Zostawiamy TYLKO to!

            // ... (reszta placeholder√≥w)
            'handover': () => renderPlaceholder('Przekazania'),
            // USUNIƒòTA ZBƒòDNA LINIA: 'damages': () => renderPlaceholder('Szkody (wymaga oddzielnego API/filtra)'),
            'calendar': () => renderPlaceholder('G≈Ç√≥wny Terminarz'),
            'policies': () => renderPlaceholder('Polisy'),
            'tech_inspections': () => renderPlaceholder('Badania Techniczne'),
            'reviews': () => renderPlaceholder('PrzeglƒÖdy'),
            'legalization': () => renderPlaceholder('Legalizacje'),
            'leasing': () => renderPlaceholder('Leasingi'),
            'hr_docs': () => renderPlaceholder('Dokumenty Kadrowe'),
            'settlements': () => renderPlaceholder('Rozliczenia Finansowe'),
            'other': () => renderPlaceholder('Pozosta≈Çe'),
            'settings': () => renderPlaceholder('Ustawienia Systemu'),
        };

        function renderPlaceholder(title) {
            viewTitle.textContent = title;
            mainContent.innerHTML = `<div style="padding: 40px; text-align: center; color: #6c757d;">
                <h2>${title}</h2>
                <p>Ten modu≈Ç wymaga osobnego endpointu API Django, modelu i logiki biznesowej. Front-end jest gotowy!</p>
            </div>`;
        }

        function loadView(viewName) {
            menuItems.forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`[data-view="${viewName}"]`);
            if(activeItem) {
                activeItem.classList.add('active');
            }
            viewMap[viewName]();
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                // Sprawdzanie, czy u≈ºytkownik jest zalogowany przed za≈Çadowaniem widoku
                if (localStorage.getItem('access_token')) {
                    loadView(item.dataset.view);
                }
            });
        });

        // Weryfikacja autentykacji przy ≈Çadowaniu strony
        function checkAuthentication() {
            const accessToken = localStorage.getItem('access_token');
            const userRole = localStorage.getItem('user_role');

            if (accessToken && userRole) {
                // Zalogowany - poka≈º aplikacjƒô
                loginContainer.style.display = 'none';
                mainApp.style.display = 'flex';
                userRoleDisplay.textContent = userRole;
                loadView('vehicles');
            } else {
                // Niezalogowany - poka≈º ekran logowania
                loginContainer.style.display = 'flex';
                mainApp.style.display = 'none';
            }
        }

        // Uruchomienie weryfikacji przy starcie aplikacji
        checkAuthentication();

        // 4. WIDOK SZKODY
async function renderDamageEvents() {
    viewTitle.textContent = 'Zdarzenia Szkodowe i Awarie';
    mainContent.innerHTML = `<div class="table-header-sm"><div>Lp.</div><div>Pojazd (Nr Rej.)</div><div>Data Zdarzenia</div><div>Status Naprawy</div><div>Koszt (Szac.)</div></div><div id="data-list">≈Åadowanie zdarze≈Ñ szkodowych...</div>`;
    const dataListDiv = document.getElementById('data-list');
    try {
        const response = await fetch(API_BASE + 'damage_events/', {
            headers: getAuthHeaders()
        });
        if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
        if (!response.ok) throw new Error(response.statusText);
        const damages = await response.json();
        dataListDiv.innerHTML = '';

        damages.forEach((damage, index) => {
            const statusColorMap = {
                'ZGLOSZONA': '#ffc107',
                'WYCENIANA': 'orange',
                'W_NAPRAWIE': '#007bff',
                'ZAMKNIETA': 'green'
            };
            const statusColor = statusColorMap[damage.status_naprawy] || 'gray';

            const row = document.createElement('div');
            row.className = 'table-row-sm';
            row.innerHTML = `<div>${index + 1}.</div><div>${damage.pojazd_nr_rej}</div><div>${damage.data_zdarzenia}</div><div style="color: ${statusColor}; font-weight: bold;">${damage.status_naprawy}</div><div>${damage.szacowany_koszt} PLN</div>`;
            dataListDiv.appendChild(row);
        });
    } catch (error) {
        dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}. Brak danych lub brak autoryzacji dla zdarze≈Ñ szkodowych.</div>`;
    }
}
    </script>

</body>
</html>