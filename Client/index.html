<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FLEETSYS - Pe≈Çny Interfejs Floty</title>
    <style>
        /* CSS dla ca≈Çego uk≈Çadu */
        body {
            display: flex;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            width: 100%;
            height: 100vh;
        }

        /* --- STYLY DLA LOGOWANIA --- */
        .login-container { display: none; justify-content: center; align-items: center; height: 100vh; width: 100%; background-color: #e9ecef; }
        .login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 350px; text-align: center; }
        .login-box input[type="text"], .login-box input[type="password"], .login-box input[type="email"] { width: 100%; padding: 10px; margin: 8px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .login-box button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; }

        /* --- STYLY DLA G≈Å√ìWNEJ APLIKACJI --- */
        .main-app { display: none; width: 100%; height: 100vh; display: flex; }
        .sidebar {
            width: 250px;
            background-color: #2c3e50; /* Ciemne t≈Ço */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding-top: 0;
            min-height: 100vh;
            overflow-y: auto;
            color: #ecf0f1;
        }

        /* Nag≈Ç√≥wek FLEETSYS */
        .sidebar-header {
            background-color: #1a252f; /* Jeszcze ciemniejszy nag≈Ç√≥wek */
            padding: 20px;
            font-size: 1.5em;
            color: #ffffff;
            font-weight: 900;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

       .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px; /* Odstƒôp ikony od tekstu */
            font-size: 14px;
            color: #bdc3c7; /* Jasnoszary tekst nieaktywny */
            transition: all 0.3s ease;
            border-left: 5px solid transparent; /* Pasek aktywno≈õci (ukryty) */
        }

        .menu-item i {
            width: 20px; /* Sta≈Ça szeroko≈õƒá dla ikon ≈ºeby tekst by≈Ç r√≥wno */
            text-align: center;
        }

        .menu-item:hover {
            background-color: #34495e;
            color: #ffffff;
        }

        /* Aktywny element - Zielony pasek */
        .menu-item.active {
            background-color: #34495e;
            color: #ffffff;
            font-weight: bold;
            border-left: 5px solid #16a085; /* ZIELONY PASEK */
        }

        .menu-subitem {
            padding: 10px 20px 10px 55px; /* Wciƒôcie */
            cursor: pointer;
            color: #bdc3c7; /* TEN SAM KOLOR CO G≈Å√ìWNE MENU */
            font-size: 13px;
            display: flex;
            align-items: center;
            background-color: #2c3e50;
            transition: color 0.3s ease;
        }
        
        .menu-subitem:hover { 
            color: #ffffff; /* Bia≈Çy po najechaniu */
            background-color: #34495e; 
        }
        
        .menu-subitem.active { 
            color: #ffffff; 
            font-weight: bold;
            background-color: #34495e;
        }

        /* Przycisk DODAJ (Zielony, pasujƒÖcy do stylu) */
        .btn-add {
            background-color: #16a085; /* Zielony morski */
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .btn-add:hover { background-color: #1abc9c; }

        .menu-subitem:hover, .menu-subitem.active { background-color: #f0f8ff; color: #007bff; }

        .content-area { flex-grow: 1; padding: 20px 40px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h1 { margin: 0; font-size: 24px; }

        .btn-add { background-color: #28a745; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; }

        .table-container { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .table-header, .table-row { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 1fr 1fr 120px; padding: 12px 0; border-bottom: 1px solid #ddd; }
        .table-header { font-weight: bold; background-color: #e9ecef; }
        .table-header-sm, .table-row-sm { display: grid; grid-template-columns: 50px 1.5fr 1fr 1.5fr 1fr 120px; padding: 12px 0; border-bottom: 1px solid #ddd; }
        .table-header-sm { font-weight: bold; background-color: #e9ecef; }
        .error { color: red; text-align: center; padding: 20px; font-size: 1.1em; }

        /* --- STYLY DLA MODALU --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-content button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        .btn-save { background-color: #007bff; color: white; }
        #delete-btn { background-color: #dc3545; color: white; float: right; }

        /* --- STYLY DLA KOLOROWYCH K√ì≈ÅEK W MENU --- */
        .color-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .dot-policy { background-color: #007bff; }
        .dot-review { background-color: #28a745; }
        .dot-inspection { background-color: #ffc107; }
        .dot-repair { background-color: #dc3545; }

        /* --- STYLY DLA KALENDARZA --- */
        .calendar-view {
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .day-name {
            font-weight: bold;
            padding: 10px 0;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .calendar-day {
            min-height: 100px;
            padding: 5px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: left;
        }
        .calendar-day.current-month { background-color: #ffffff; }
        .calendar-day:hover { background-color: #e6f7ff; }
        .calendar-day-number { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; display: block; color: #333; }

        .event-item {
            font-size: 0.75em;
            padding: 2px 4px;
            margin-top: 2px;
            border-radius: 3px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-review { background-color: #28a745; }
        .event-inspection { background-color: #ffc107; }
        .event-policy { background-color: #007bff; }
        .event-repair { background-color: #dc3545; }

        .day-border-policy { border: 2px solid #007bff !important; }
        .day-border-review { border: 2px solid #28a745 !important; }
        .day-border-inspection { border: 2px solid #ffc107 !important; }
        .day-border-repair { border: 2px solid #dc3545 !important; }

        /* --- STYLY DLA PROFILU U≈ªYTKOWNIKA (PRAWY G√ìRNY R√ìG) --- */
        .user-profile-section {
            position: relative;
            display: inline-block;
            margin-left: 20px;
            border-left: 1px solid #ccc;
            padding-left: 20px;
        }

        .user-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-toggle-btn:hover { color: #007bff; }

        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            background-color: #fff;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 100;
            border-radius: 4px;
            border: 1px solid #eee;
            margin-top: 10px;
        }

        .user-dropdown button {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }

        .user-dropdown button:hover {
            background-color: #f1f1f1;
            color: #dc3545;
        }

        .show-dropdown { display: block; }

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

        <div class="login-container" id="login-container">
            <div class="login-box" id="login-box">
                <h2>Logowanie do FLEETSYS</h2>
                <p style="color: red; height: 1.5em;" id="login-error"></p>
                <form id="login-form">
                    <input type="text" id="username" placeholder="Nazwa u≈ºytkownika" required>
                    <input type="password" id="password" placeholder="Has≈Ço" required>
                    <input type="password" id="pin_2fa" placeholder="PIN 2FA (tylko Admin)" style="display: none;">
                    <button type="submit">Zaloguj</button>
                </form>
                <p style="margin-top: 15px; font-size: 0.9em;">
                    Nie masz konta? <a href="#" onclick="showRegister()">Za≈Ç√≥≈º konto</a>
                </p>
            </div>

            <div class="login-box" id="register-box" style="display: none;">
                <h2>Za≈Ç√≥≈º konto</h2>
                <p style="color: red; height: 1.5em;" id="register-error"></p>
                <input type="text" id="reg_first_name" placeholder="Imiƒô" required>
                <input type="text" id="reg_last_name" placeholder="Nazwisko" required>
                <input type="text" id="reg_username" placeholder="Nowy login" required>
                <input type="email" id="reg_email" placeholder="Adres e-mail" required>
                <input type="password" id="reg_password" placeholder="Nowe has≈Ço" required>
                <select id="reg_role">
                    <option value="EMPLOYEE">Pracownik</option>
                    <option value="DRIVER">Kierowca</option>
                    <option value="MANAGER">Mened≈ºer Floty</option>
                </select>
                <button onclick="handleRegister()" style="width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                    Zarejestruj siƒô
                </button>
                <p style="margin-top: 15px; font-size: 0.9em;">
                    Masz ju≈º konto? <a href="#" onclick="showLogin()">Wr√≥ƒá do logowania</a>
                </p>
            </div>
        </div>
        <div class="main-app" id="main-app" style="display: none;">
            <div class="sidebar">
            <div class="sidebar-header">FLEETSYS</div>

            <div class="menu-item active" data-view="vehicles">
                <i class="fas fa-car-side"></i> <span>Pojazdy</span>
            </div>
            <div class="menu-item" data-view="drivers">
                <i class="fas fa-users"></i> <span>U≈ºytkownicy</span>
            </div>
            <div class="menu-item" data-view="handover">
                <i class="fas fa-key"></i> <span>Przekazania</span>
            </div>
            <div class="menu-item" data-view="damages">
                <i class="fas fa-car-burst"></i> <span>Szkody</span>
            </div>
            <div class="menu-item" data-view="calendar">
                <i class="fas fa-calendar-days"></i> <span>Terminarz</span>
            </div>

            <div class="menu-subitem" data-view="policies"><span class="color-dot dot-policy"></span>Polisy</div>
            <div class="menu-subitem" data-view="tech_inspections"><span class="color-dot dot-inspection"></span>Badania tech.</div>
            <div class="menu-subitem" data-view="reviews"><span class="color-dot dot-review"></span>PrzeglƒÖdy</div>
            <div class="menu-subitem" data-view="repairs"><span class="color-dot dot-repair"></span>Naprawy</div>

         
            <div class="menu-item" data-view="hr_docs">
                <i class="fas fa-folder-open"></i> <span>Dokumenty</span>
            </div>
            <div class="menu-item" data-view="settlements">
                <i class="fas fa-receipt"></i> <span>Rozliczenia</span>
            </div>
            <div class="menu-item" data-view="reservations">
                <i class="fas fa-calendar-check"></i> <span>Rezerwacje</span>
            </div>
            <div class="menu-item" data-view="other">
                <i class="fas fa-ellipsis-h"></i> <span>Pozosta≈Çe</span>
            </div>

            <div style="margin-top: auto;"> <div class="menu-item" data-view="settings" style="border-top: 1px solid #34495e;">
                    <i class="fas fa-sliders-h"></i> <span>Ustawienia</span>
                </div>
            </div>
        </div>

            <div class="content-area">
                <div class="header">
                    <h1 id="view-title">Pojazdy</h1>

                    <div style="display: flex; align-items: center;">
                        <div style="display: flex; gap: 10px; margin-right: 10px;">
                            <input type="text" id="table-search" placeholder="Szukaj..." onkeyup="filterTable()"
                                   style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px;">

                            <button class="btn-add" id="add-btn">‚ûï DODAJ</button>
                        </div>

                        <div class="user-profile-section">
                            <button onclick="toggleUserMenu()" class="user-toggle-btn" id="user-menu-btn">
                                üë§ <span id="header-username">≈Åadowanie...</span> ‚ñº
                            </button>
                            <div id="user-dropdown-content" class="user-dropdown">
                                <div style="padding: 10px; font-size: 0.85em; color: #666; border-bottom: 1px solid #eee;">
                                    Rola: <span id="header-role">---</span>
                                </div>
                                <button onclick="handleLogout()">üö™ Wyloguj siƒô</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="main-content"></div>
            </div>
        </div>

        <div id="data-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h2 id="modal-title">Dodaj nowy rekord</h2>
                <p style="color: red; height: 1.5em;" id="modal-error"></p>
                <form id="modal-form"></form>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn-save" id="save-btn">ZAPISZ</button>
                    <button id="delete-btn" style="display: none; background-color: #dc3545; color: white; border: none; padding: 10px; border-radius: 4px;">USU≈É</button>
                </div>
            </div>
        </div>



    <script>
        const mainContent = document.getElementById('main-content');
        const viewTitle = document.getElementById('view-title');
        const menuItems = document.querySelectorAll('.menu-item, .menu-subitem');
        const API_BASE = 'http://127.0.0.1:8000/api/';

        // Elementy Logowania
        const loginContainer = document.getElementById('login-container');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const pin2faInput = document.getElementById('pin_2fa');
        const loginError = document.getElementById('login-error');
        // USUNIƒòTO: const userRoleDisplay (poniewa≈º ten element usunƒôli≈õmy z HTML sidebar)

        // Elementy Modalu
        const modal = document.getElementById('data-modal');
        const closeModalBtn = document.querySelector('.close-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalForm = document.getElementById('modal-form');
        const modalError = document.getElementById('modal-error');
        const saveBtn = document.getElementById('save-btn');
        saveBtn.onclick = handleSave;
        const deleteBtn = document.getElementById('delete-btn');
        const addBtn = document.getElementById('add-btn');

        let currentView = 'vehicles';
        let currentRecordId = null;

        // --- FUNKCJE POMOCNICZE ---

        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_role');
            localStorage.removeItem('username');

            loginContainer.style.display = 'flex';
            mainApp.style.display = 'none';
        }

        // USUNIƒòTO: logoutBtn.addEventListener (bo przycisku ju≈º nie ma w zmiennych, jest w onclick w HTML)

        // Funkcja aktualizujƒÖca tekst w prawym g√≥rnym rogu
        function updateHeaderUser() {
            const username = localStorage.getItem('username') || 'Go≈õƒá';
            const role = localStorage.getItem('user_role') || '---';

            const headerName = document.getElementById('header-username');
            const headerRole = document.getElementById('header-role');

            if(headerName) headerName.textContent = username;
            if(headerRole) headerRole.textContent = role;
        }

        // Funkcja otwierajƒÖca/zamykajƒÖca menu
        function toggleUserMenu() {
            document.getElementById("user-dropdown-content").classList.toggle("show-dropdown");
        }

        // Zamknij menu, je≈õli u≈ºytkownik kliknie gdziekolwiek indziej
        window.onclick = function(event) {
            if (!event.target.matches('.user-toggle-btn') && !event.target.matches('.user-toggle-btn *')) {
                var dropdowns = document.getElementsByClassName("user-dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show-dropdown')) {
                        openDropdown.classList.remove('show-dropdown');
                    }
                }
            }
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = '';
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const pin_2fa = pin2faInput.value;
            try {
                const response = await fetch(API_BASE + 'login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ username, password, pin_2fa }),
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user_role', data.user_role);

                    // Zapisujemy nazwƒô u≈ºytkownika
                    localStorage.setItem('username', data.username);

                    loginContainer.style.display = 'none';
                    mainApp.style.display = 'flex';

                    // Od≈õwie≈ºamy prawy g√≥rny r√≥g
                    if (typeof updateHeaderUser === 'function') {
                        updateHeaderUser();
                    }

                    loginForm.reset();
                    pin2faInput.style.display = 'none';
                    loadView('vehicles');
                } else {
                    loginError.textContent = data.detail || 'WystƒÖpi≈Ç nieznany b≈ÇƒÖd logowania.';
                    if (username.toUpperCase().includes('ADMIN') || (data.detail && data.detail.includes('PIN 2FA'))) {
                         pin2faInput.style.display = 'block';
                         pin2faInput.focus();
                    } else {
                         pin2faInput.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error(error);
                loginError.textContent = 'B≈ÇƒÖd sieci. Sprawd≈∫, czy serwer Django dzia≈Ça na porcie 8000.';
            }
        }
        loginForm.addEventListener('submit', handleLogin);

        function showRegister() {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('register-box').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('login-box').style.display = 'block';
            document.getElementById('register-box').style.display = 'none';
        }

        async function handleRegister() {
            const username = document.getElementById('reg_username').value;
            const email = document.getElementById('reg_email').value;
            const password = document.getElementById('reg_password').value;
            const rola = document.getElementById('reg_role').value;
            const first_name = document.getElementById('reg_first_name').value;
            const last_name = document.getElementById('reg_last_name').value;
            const errorElem = document.getElementById('register-error');

            errorElem.textContent = "";

            try {
                const response = await fetch('http://127.0.0.1:8000/api/register/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, rola, first_name, last_name })
                });

                const data = await response.json();

                if (response.ok) {
                    alert("Konto utworzone pomy≈õlnie! Teraz mo≈ºesz siƒô zalogowaƒá.");
                    showLogin();
                } else {
                    errorElem.textContent = data.detail || "B≈ÇƒÖd rejestracji";
                }
            } catch (error) {
                errorElem.textContent = "B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.";
            }
        }

        // --- FUNKCJE DLA MODALU ---

        closeModalBtn.onclick = () => { modal.style.display = "none"; };

        const endpointMap = {
            'vehicles': 'vehicles',
            'drivers': 'drivers',
            'damages': 'damage_events',
            'handover': 'handovers',
            'hr_history': 'handovers',
            'inspection': 'service_events',
            'repairs': 'service_events',
            'reviews': 'service_events',
            'tech_inspections': 'service_events',
            'legalization': 'service_events',
            'policies': 'policies',
            'reservations': 'reservations',
            'vehicle_documents': 'vehicles',
            'calendar': null
        };

        addBtn.addEventListener('click', () => openModal(currentView));

        async function fetchVehicles() {
            try {
                const response = await fetch(API_BASE + 'vehicles/', { headers: getAuthHeaders() });
                if (response.status === 401) { handleLogout(); return []; }
                if (!response.ok) throw new Error(response.statusText);
                return await response.json();
            } catch (error) {
                console.error("B≈ÇƒÖd pobierania listy pojazd√≥w:", error);
                return [];
            }
        }

        function updateFormFields(eventType) {
            const container = document.getElementById('dynamic-fields-container');
            let fieldsHtml = '';

            if (eventType === 'POLICY_OC') {
                 fieldsHtml = `
                    <label for="numer_polisy_val">Numer Polisy:</label>
                    <input type="text" id="numer_polisy_val" required>

                    <label for="ubezpieczyciel_val">Ubezpieczyciel:</label>
                    <input type="text" id="ubezpieczyciel_val" placeholder="np. PZU, Warta" required>

                    <label for="data_waznosci_ac_val">Data Wa≈ºno≈õci AC (opcjonalnie):</label>
                    <input type="date" id="data_waznosci_ac_val">
                 `;
            } else {
                 fieldsHtml = `
                    <label for="opis_zdarzenia_val">Opis Zdarzenia:</label>
                    <textarea id="opis_zdarzenia_val" required></textarea>

                    <label for="koszt_val">Koszt (PLN, opcjonalnie):</label>
                    <input type="number" id="koszt_val" step="0.01" value="0">
                 `;
            }
            container.innerHTML = fieldsHtml;
        }
        window.updateFormFields = updateFormFields;


        /** Otwiera modal i ≈Çaduje odpowiedni formularz */
       async function openModal(viewName, recordOrId = null) {
            let record = null;
            modalError.textContent = '';
            modalForm.innerHTML = '≈Åadowanie danych...';

            // Logika pobierania danych (bez zmian)
            if (recordOrId !== null) {
                if (typeof recordOrId === 'object') {
                    record = recordOrId;
                    currentRecordId = record.id;
                } else {
                    currentRecordId = recordOrId;
                    try {
                        const endpoint = endpointMap[viewName] || viewName;
                        const response = await fetch(`${API_BASE}${endpoint}/${currentRecordId}/`, {
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            record = await response.json();
                        } else {
                            throw new Error("Nie uda≈Ço siƒô pobraƒá danych rekordu.");
                        }
                    } catch (error) {
                        modalError.textContent = "B≈ÇƒÖd ≈Çadowania: " + error.message;
                        return;
                    }
                }
            } else {
                currentRecordId = null;
            }

            modalTitle.textContent = currentRecordId ? `Edytuj rekord (${viewName})` : `Dodaj nowy rekord (${viewName})`;
            deleteBtn.style.display = currentRecordId ? 'inline' : 'none';

            let formHtml = '';
            const isCalendarEventView = ['calendar', 'policies', 'tech_inspections', 'reviews', 'repairs', 'legalization', 'inspection'].includes(viewName);

            // 1. DODAWANIE NOWEGO TERMINU (DLA WIDOK√ìW KALENDARZOWYCH)
            if (isCalendarEventView && !currentRecordId) {
                modalTitle.textContent = `Dodaj Nowy Termin/Zdarzenie`;
                const vehicles = await fetchVehicles();
                const vehicleOptions = vehicles.map(v => `<option value="${v.id}">${v.registration_number} (ID: ${v.id})</option>`).join('');

                formHtml = `
                    <label for="event_type_selector">Rodzaj Zdarzenia:</label>
                    <select id="event_type_selector" required onchange="updateFormFields(this.value)">
                        <option value="" disabled selected>-- Wybierz rodzaj --</option>
                        <option value="BADANIE_TECH">Badanie Techniczne</option>
                        <option value="PRZEGLAD">PrzeglƒÖd Okresowy</option>
                        <option value="NAPRAWA">Naprawa</option>
                        <option value="POLICY_OC">Polisa OC/AC</option>
                    </select>
                    <label for="pojazd_id_selector">Pojazd:</label>
                    <select id="pojazd_id_selector" required>${vehicleOptions}</select>
                    <div id="dynamic-fields-container"></div>
                    <label for="data_terminu">Data Terminu:</label>
                    <input type="date" id="data_terminu" required>
                `;
            }
            // 2. POJAZDY
            else if (viewName === 'vehicles') {
                const sel = (f, v) => (record && record[f] === v) ? 'selected' : '';

                // Funkcja pomocnicza generujƒÖca pole pliku z opcjƒÖ usuwania
                const fileInputRow = (label, fileId, removeId, dbField) => {
                    let html = `<label style="margin-top:10px;">${label}:</label><input type="file" id="${fileId}">`;

                    // Je≈õli rekord istnieje i ma wgrany plik w danym polu
                    if (record && record[dbField]) {
                        html += `
                            <div style="background: #fff3cd; padding: 5px; border: 1px solid #ffeeba; border-radius: 4px; display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <span style="color: green; font-weight: bold; font-size: 0.9em;">‚úÖ Plik jest wgrany</span>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="${removeId}" style="width: auto; margin: 0;">
                                    <label for="${removeId}" style="color: #dc3545; font-weight: bold; font-size: 0.85em; margin: 0; cursor: pointer;">Usu≈Ñ plik</label>
                                </div>
                            </div>
                        `;
                    }
                    return html;
                };

                formHtml = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><label>Marka:</label><input type="text" id="v_marka" value="${record?.marka || ''}"></div>
                        <div><label>Model:</label><input type="text" id="v_model" value="${record?.model || ''}"></div>
                    </div>

                    <label>Nr Rej:</label><input type="text" id="reg_num" value="${record?.registration_number || ''}" required>
                    <label>VIN:</label><input type="text" id="vin_num" value="${record?.vin || ''}" required>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>Typ:</label>
                            <select id="v_type">
                                <option value="OSOBOWE" ${sel('typ_pojazdu', 'OSOBOWE')}>Osobowe</option>
                                <option value="CIEZAROWE" ${sel('typ_pojazdu', 'CIEZAROWE')}>Ciƒô≈ºarowe</option>
                                <option value="AUTOBUSY" ${sel('typ_pojazdu', 'AUTOBUSY')}>Autobusy</option>
                            </select>
                        </div>
                        <div>
                            <label>Paliwo:</label>
                            <select id="fuel_type_input">
                                <option value="DIESEL" ${sel('fuel_type', 'DIESEL')}>Diesel</option>
                                <option value="BENZYNA" ${sel('fuel_type', 'BENZYNA')}>Benzyna</option>
                            </select>
                        </div>
                    </div>

                    <label>Przebieg:</label><input type="number" id="przebieg_val" value="${record?.przebieg || ''}">
                    <label>Status:</label>
                    <select id="v_status">
                        <option value="SPRAWNY" ${sel('status', 'SPRAWNY')}>Sprawny</option>
                        <option value="NIESPRAWNY" ${sel('status', 'NIESPRAWNY')}>Niesprawny</option>
                    </select>

                    <input type="hidden" id="company_id" value="${record?.company || ''}">
                    <input type="hidden" id="v_assigned_user" value="${record?.assigned_user || ''}">

                    <label>Uwagi:</label><textarea id="v_uwagi">${record?.uwagi || ''}</textarea>

                    <h3 style="margin-top:20px; border-bottom:2px solid #007bff; padding-bottom:5px; color:#007bff;">Dokumenty (Dodaj / Usu≈Ñ)</h3>

                    ${fileInputRow('Skan Dowodu Rej.', 'v_scan_registration', 'rm_scan_registration', 'scan_registration_card')}
                    ${fileInputRow('Polisa OC', 'v_scan_oc', 'rm_scan_oc', 'scan_policy_oc')}
                    ${fileInputRow('Polisa AC', 'v_scan_ac', 'rm_scan_ac', 'scan_policy_ac')}
                    ${fileInputRow('Badanie Techniczne', 'v_scan_tech', 'rm_scan_tech', 'scan_tech_inspection')}
                    ${fileInputRow('KsiƒÖ≈ºka Serwisowa', 'v_scan_service', 'rm_scan_service', 'scan_service_book')}
                    ${fileInputRow('Faktura Zakupu', 'v_scan_invoice', 'rm_scan_invoice', 'scan_purchase_invoice')}
                `;
            }
            // 3. KIEROWCY
            else if (viewName === 'drivers') {
                formHtml = `
                    <label>User ID:</label><input type="number" id="d_user_id" value="${record?.user || ''}" ${currentRecordId ? 'disabled' : ''}>
                    <label>Firma ID:</label><input type="number" id="d_company_id" value="${record?.company || ''}">
                    <label>Nr Prawa Jazdy:</label><input type="text" id="prawa_jazdy_num" value="${record?.numer_prawa_jazdy || ''}">
                    <label>Kategorie:</label><input type="text" id="kat_prawa_jazdy" value="${record?.kategorie_prawa_jazdy || 'B'}">
                    <label>Wa≈ºno≈õƒá PJ:</label><input type="date" id="data_waznosci_pj_val" value="${record?.data_waznosci_prawa_jazdy || ''}" required>
                    <label>Badania lek:</label><input type="date" id="data_badan_val" value="${record?.data_waznosci_badan || ''}">
                `;
            }
            // 4. PRZEKAZANIA (ZAKTUALIZOWANE O PLIKI)
            else if (viewName === 'handover') {

                const fileInputRow = (label, fileId, removeId, dbField) => {
                    let html = `<div style="margin-top:10px;"><label style="font-weight:bold; font-size:0.9em;">${label}:</label><br><input type="file" id="${fileId}"></div>`;
                    if (record && record[dbField]) {
                        html += `
                            <div style="background: #e2e3e5; padding: 5px; border-radius: 4px; display: flex; align-items: center; gap: 10px; margin-top: 2px;">
                                <a href="${record[dbField]}" target="_blank" style="color: blue; text-decoration: none; font-size:0.85em;">üìÑ Zobacz obecny</a>
                                <div style="display: flex; align-items: center; gap: 5px; margin-left:auto;">
                                    <input type="checkbox" id="${removeId}" style="width: auto; margin: 0;">
                                    <label for="${removeId}" style="color: #dc3545; font-size: 0.85em; margin: 0; cursor: pointer;">Usu≈Ñ</label>
                                </div>
                            </div>`;
                    }
                    return html;
                };

                const fuelOptions = (selected) => {
                    const opts = {'0':'Rezerwa', '25':'1/4', '50':'1/2', '75':'3/4', '100':'Pe≈Çny'};
                    return Object.entries(opts).map(([k, v]) =>
                        `<option value="${k}" ${String(selected) === k ? 'selected' : ''}>${v}</option>`
                    ).join('');
                };

                // Obliczanie "na ≈ºywo" w formularzu (JavaScript)
                window.calculateRentCost = () => {
                    const start = parseInt(document.getElementById('h_przebieg_start').value) || 0;
                    const stop = parseInt(document.getElementById('h_przebieg_stop').value) || 0;
                    const stawka = parseFloat(document.getElementById('h_stawka').value) || 0;
                    const doplata = parseFloat(document.getElementById('h_doplata').value) || 0;

                    if (stop > start) {
                        const dist = stop - start;
                        const total = (dist * stawka) + doplata;
                        document.getElementById('calc_dystans').innerText = dist + ' km';
                        document.getElementById('calc_total').innerText = total.toFixed(2) + ' PLN';
                    }
                };

                formHtml = `
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;"><label>Pojazd:</label><input type="number" id="h_pojazd_id" value="${record?.pojazd || ''}" required></div>
                        <div style="flex:1;"><label>Kierowca:</label><input type="number" id="h_kierowca_id" value="${record?.kierowca || ''}" required></div>
                    </div>

                    <div style="background:#e9ecef; padding:10px; border-radius:5px; margin-top:10px;">
                        <strong style="color:#007bff;">1. WYDANIE POJAZDU</strong>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <div style="flex:1;"><label>Data Wydania:</label><input type="date" id="h_data_wydania" value="${record?.data_wydania || ''}" required></div>
                            <div style="flex:1;"><label>Przebieg Start (km):</label><input type="number" id="h_przebieg_start" value="${record?.przebieg_start || 0}" oninput="calculateRentCost()"></div>
                            <div style="flex:1;"><label>Paliwo Start:</label><select id="h_paliwo_start">${fuelOptions(record?.paliwo_start || '100')}</select></div>
                        </div>
                    </div>

                    <div style="background:#d4edda; padding:10px; border-radius:5px; margin-top:10px; border:1px solid #c3e6cb;">
                        <strong style="color:#155724;">2. ZWROT I ROZLICZENIE</strong>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <div style="flex:1;"><label>Data Zwrotu:</label><input type="date" id="h_data_zwrotu" value="${record?.data_zwrotu || ''}"></div>
                            <div style="flex:1;"><label>Przebieg Koniec (km):</label><input type="number" id="h_przebieg_stop" value="${record?.przebieg_stop || ''}" oninput="calculateRentCost()"></div>
                            <div style="flex:1;"><label>Paliwo Koniec:</label><select id="h_paliwo_stop">${fuelOptions(record?.paliwo_stop || '')}</select></div>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
                            <div style="flex:1;"><label>Stawka za km (PLN):</label><input type="number" step="0.01" id="h_stawka" value="${record?.stawka_za_km || '0.50'}" oninput="calculateRentCost()"></div>
                            <div style="flex:1;"><label>Dop≈Çata Paliwo (PLN):</label><input type="number" step="0.01" id="h_doplata" value="${record?.koszt_brakujacego_paliwa || '0'}" oninput="calculateRentCost()"></div>
                        </div>

                        <div style="margin-top:10px; font-weight:bold; text-align:right; font-size:1.1em;">
                            Dystans: <span id="calc_dystans" style="color:#007bff;">0 km</span> |
                            SUMA: <span id="calc_total" style="color:#28a745;">0.00 PLN</span>
                        </div>
                    </div>

                    <label style="margin-top:10px;">Uwagi:</label><textarea id="h_uwagi" rows="2">${record?.uwagi || ''}</textarea>

                    `;

                // Wywo≈Çaj kalkulacjƒô po za≈Çadowaniu (je≈õli edytujemy)
                setTimeout(window.calculateRentCost, 500);
            }

            // 5. SZKODY
            else if (viewName === 'damages') {
                const sel = (val) => (record?.status_naprawy === val ? 'selected' : '');
                formHtml = `
                    <label>ID Pojazdu:</label><input type="number" id="pojazd_id" value="${record?.pojazd || ''}" required>
                    <label>Data:</label><input type="date" id="data_zdarzenia_val" value="${record?.data_zdarzenia || ''}" required>
                    <label>Status:</label>
                    <select id="status_naprawy_val">
                        <option value="ZGLOSZONA" ${sel('ZGLOSZONA')}>Zg≈Çoszona</option>
                        <option value="W_NAPRAWIE" ${sel('W_NAPRAWIE')}>W naprawie</option>
                        <option value="ZAMKNIETA" ${sel('ZAMKNIETA')}>Zamkniƒôta</option>
                    </select>
                    <label>Opis:</label><textarea id="opis_szkody">${record?.opis || ''}</textarea>
                `;
            }
            // ... (wcze≈õniejszy kod openModal) ...

            // 6. REZERWACJE (PODMIE≈É CA≈ÅY TEN BLOK)
            else if (viewName === 'reservations') {
                // 1. POBIERANIE LISTY POJAZD√ìW
                let vehicleOptions = '<option value="">-- Brak / Dowolny --</option>';
                try {
                    const vehicles = await fetchVehicles();
                    vehicleOptions += vehicles.map(v => {
                        const isSelected = (record && record.assigned_vehicle === v.id) ? 'selected' : '';
                        return `<option value="${v.id}" ${isSelected}>${v.registration_number} (${v.marka} ${v.model})</option>`;
                    }).join('');
                } catch (e) { console.error(e); }

                // 2. NOWE: POBIERANIE LISTY KIEROWC√ìW (Driver√≥w z kontami)
                // To jest kluczowe - bez tego handleSave wyrzuci b≈ÇƒÖd!
                let driverOptions = '<option value="">-- Wybierz Kierowcƒô z Systemu --</option>';
                try {
                    // Upewnij siƒô, ≈ºe masz funkcjƒô fetchDrivers(), je≈õli nie - dodaj jƒÖ (kod poni≈ºej)
                    const response = await fetch(API_BASE + 'drivers/', { headers: getAuthHeaders() });
                    if (response.ok) {
                        const drivers = await response.json();
                        drivers.forEach(d => {
                            const name = (d.first_name || d.last_name) ? `${d.first_name} ${d.last_name}` : d.user_name;
                            const isSel = (record && record.driver === d.id) ? 'selected' : '';
                            driverOptions += `<option value="${d.id}" ${isSel}>${name}</option>`;
                        });
                    }
                } catch(e) { console.error(e); }

                const sel = (val) => (record?.vehicle_type === val ? 'selected' : '');
                const stSel = (val) => (record?.status === val ? 'selected' : '');

                let attachmentsHtml = '';
                if (record && record.attachments && record.attachments.length > 0) {
                    attachmentsHtml = '<div style="margin-top: 5px; background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 4px;"><strong>Za≈ÇƒÖczone pliki:</strong><ul style="list-style: none; padding-left: 0; margin-top: 5px;">';
                    record.attachments.forEach(file => {
                        const fileName = file.file.split('/').pop();
                        attachmentsHtml += `
                            <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #eee;">
                                <a href="${file.file}" target="_blank" style="color: blue; text-decoration: none;">üìÑ ${fileName}</a>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" class="remove-attachment-cb" value="${file.id}" id="remove_file_${file.id}">
                                    <label for="remove_file_${file.id}" style="color: #dc3545; font-size: 0.85em; cursor: pointer;">Usu≈Ñ</label>
                                </div>
                            </li>`;
                    });
                    attachmentsHtml += '</ul></div>';
                }

                // TUTAJ JEST ZMIANA - DODANO POLA, KT√ìRYCH BRAKOWA≈ÅO
                formHtml = `
                    <div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <small style="color:#666; font-weight:bold;">DANE WNIOSKODAWCY (Tylko tekst):</small>
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1;"><label>Imiƒô:</label> <input type="text" id="r_first_name" value="${record?.first_name || ''}" required></div>
                            <div style="flex:1;"><label>Nazwisko:</label> <input type="text" id="r_last_name" value="${record?.last_name || ''}" required></div>
                        </div>
                        <label>Firma:</label> <input type="text" id="r_company" value="${record?.company || ''}" required>
                    </div>

                    <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #c3e6cb;">
                        <small style="color:#155724; font-weight:bold;">WERYFIKACJA ADMINISTRATORA:</small>

                        <label style="color: #155724;">Wybierz Kierowcƒô (Wymagane do Przekazania):</label>
                        <select id="r_driver_id" style="border: 1px solid #28a745; background: white;">${driverOptions}</select>

                        <label style="color: #007bff; margin-top:5px;">Przypisz pojazd:</label>
                        <select id="r_assigned_vehicle" style="border: 1px solid #007bff; background:#f0f8ff;"> ${vehicleOptions} </select>

                        <label style="margin-top:5px;">Status:</label>
                        <select id="r_status" style="font-weight:bold;">
                            <option value="OCZEKUJACE" ${stSel('OCZEKUJACE')}>OczekujƒÖce</option>
                            <option value="PRZYJETE" ${stSel('PRZYJETE')}>Przyjƒôte</option>
                            <option value="ZATWIERDZONE" ${stSel('ZATWIERDZONE')}>‚úÖ ZATWIERDZONE (Generuje wydanie)</option>
                            <option value="ODRZUCONE" ${stSel('ODRZUCONE')}>Odrzucone</option>
                        </select>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;"> <label>Data Od:</label> <input type="date" id="r_date_from" value="${record?.date_from || ''}" required> </div>
                        <div style="flex:1;"> <label>Data Do:</label> <input type="date" id="r_date_to" value="${record?.date_to || ''}" required> </div>
                    </div>

                    <label>Preferowany Typ:</label>
                    <select id="r_vehicle_type">
                        <option value="OSOBOWE" ${sel('OSOBOWE')}>Osobowe</option>
                        <option value="CIEZAROWE" ${sel('CIEZAROWE')}>Ciƒô≈ºarowe</option>
                        <option value="AUTOBUSY" ${sel('AUTOBUSY')}>Autobusy</option>
                        <option value="SUV" ${sel('SUV')}>SUV</option>
                        <option value="KOMBI" ${sel('KOMBI')}>Kombi</option>
                    </select>

                    <label style="margin-top: 10px;">Dodatkowe informacje:</label>
                    <textarea id="r_additional_info" rows="2">${record?.additional_info || ''}</textarea>

                    <label style="margin-top: 15px; font-weight:bold; color: #28a745;">Dodaj pliki:</label>
                    <input type="file" id="r_new_files" multiple accept="application/pdf,image/*">

                    ${attachmentsHtml}
                `;
            }
            // 7. EDYCJA ISTNIEJƒÑCYCH ZDARZE≈É (POLISY, BADANIA, NAPRAWY)
            else if (isCalendarEventView && currentRecordId) {
                 const endpointForType = endpointMap[viewName];

                 if (endpointForType === 'service_events') {
                      formHtml = `
                        <input type="hidden" id="typ_zdarzenia_val" value="${record.typ_zdarzenia}">
                        <label>ID Pojazdu:</label>
                        <input type="number" id="pojazd_id" value="${record.pojazd}" required>
                        <label>Opis:</label>
                        <textarea id="opis_serwisu" required>${record.opis}</textarea>
                        <label>Koszt (PLN):</label>
                        <input type="number" id="koszt_val" step="0.01" value="${record.koszt}" required>
                        <label>Data Zdarzenia/Badania:</label>
                        <input type="date" id="data_serwisu_val" value="${record.data_serwisu}" required>
                    `;
                 } else if (endpointForType === 'policies') {
                      formHtml = `
                            <label>ID Pojazdu:</label>
                            <input type="number" id="pojazd_id" value="${record.pojazd}" required>
                            <label>Numer Polisy:</label>
                            <input type="text" id="numer_polisy" value="${record.numer_polisy}" required>
                            <label>Ubezpieczyciel:</label> <input type="text" id="ubezpieczyciel_val" value="${record.ubezpieczyciel || ''}" required>
                            <label>Data Wa≈ºno≈õci OC:</label>
                            <input type="date" id="data_waznosci_oc" value="${record.data_waznosci_oc}" required>
                            <label>Data Wa≈ºno≈õci AC:</label>
                            <input type="date" id="data_waznosci_ac" value="${record.data_waznosci_ac || ''}">
                        `;
                 }
            }

            // 8. NOWE DOKUMENTY POJAZDU (UPLOAD)
            else if (viewName === 'vehicle_documents') {
                modalTitle.textContent = "Dodaj Dokument Pojazdu";

                const vehicles = await fetchVehicles();
                const vehicleOptions = vehicles.map(v => `<option value="${v.id}">${v.registration_number}</option>`).join('');

                formHtml = `
                    <label>Pojazd:</label>
                    <select id="doc_vehicle_id" required>
                        ${vehicleOptions}
                    </select>

                    <label>Tytu≈Ç Dokumentu:</label>
                    <input type="text" id="doc_title" placeholder="np. Dow√≥d Rejestracyjny, Ubezpieczenie 2026" required>

                    <label>Plik (PDF/JPG):</label>
                    <input type="file" id="doc_file" required>

                    <label>Opis (opcjonalnie):</label>
                    <textarea id="doc_desc" rows="2"></textarea>
                `;
            }

            modalForm.innerHTML = formHtml;
            modal.style.display = "block";
        }


        async function handleSave(event) {
            if (event && event.preventDefault) event.preventDefault();

            const modalError = document.getElementById('modal-error');
            if (modalError) modalError.textContent = '';

            const eventTypeSelector = document.getElementById('event_type_selector');
            let data = {};
            let endpoint = endpointMap[currentView] || currentView;
            let method = currentRecordId ? 'PUT' : 'POST';
            let url = currentRecordId ? `${API_BASE}${endpoint}/${currentRecordId}/` : `${API_BASE}${endpoint}/`;

            console.log(`Pr√≥ba zapisu: ${method} na ${url} (Widok: ${currentView})`);

            try {
                // 1. DODAWANIE NOWEGO TERMINU (KALENDARZ)
                if (eventTypeSelector && !currentRecordId) {
                    const selectedType = eventTypeSelector.value;
                    const pojazdId = document.getElementById('pojazd_id_selector').value;
                    const dataTerminu = document.getElementById('data_terminu').value;

                    if (selectedType === 'POLICY_OC') {
                        data = {
                            pojazd: parseInt(pojazdId),
                            numer_polisy: document.getElementById('numer_polisy_val').value,
                            ubezpieczyciel: document.getElementById('ubezpieczyciel_val').value,
                            data_waznosci_oc: dataTerminu,
                            data_waznosci_ac: document.getElementById('data_waznosci_ac_val').value || null
                        };
                        endpoint = 'policies';
                    } else {
                        data = {
                            pojazd: parseInt(pojazdId),
                            opis: document.getElementById('opis_zdarzenia_val').value,
                            koszt: parseFloat(document.getElementById('koszt_val').value) || 0,
                            data_serwisu: dataTerminu,
                            typ_zdarzenia: selectedType
                        };
                        endpoint = 'service_events';
                    }
                    url = `${API_BASE}${endpoint}/`;
                    method = 'POST';
                }
                // 2. POJAZDY
                else if (currentView === 'vehicles' || currentView === 'vehicle_documents') {
                    const formData = new FormData();
                    // Pola tekstowe
                    formData.append('registration_number', document.getElementById('reg_num').value);
                    formData.append('vin', document.getElementById('vin_num').value);
                    formData.append('fuel_type', document.getElementById('fuel_type_input').value);
                    formData.append('przebieg', document.getElementById('przebieg_val').value || 0);
                    formData.append('is_active', 'true');
                    formData.append('marka', document.getElementById('v_marka').value);
                    formData.append('model', document.getElementById('v_model').value);
                    formData.append('status', document.getElementById('v_status').value);
                    formData.append('typ_pojazdu', document.getElementById('v_type').value);
                    formData.append('uwagi', document.getElementById('v_uwagi').value);

                    const compId = document.getElementById('company_id').value;
                    if(compId) formData.append('company', parseInt(compId));

                    const userId = document.getElementById('v_assigned_user').value;
                    if(userId) formData.append('assigned_user', parseInt(userId));

                    // --- FUNKCJA POMOCNICZA DO PLIK√ìW I USUWANIA ---
                    const appendFileOrRemove = (fileInputId, removeCheckboxId, backendFileField, backendRemoveFlag) => {
                        // 1. Czy u≈ºytkownik chce usunƒÖƒá plik?
                        const removeCb = document.getElementById(removeCheckboxId);
                        if (removeCb && removeCb.checked) {
                            formData.append(backendRemoveFlag, 'true');
                        }

                        // 2. Czy u≈ºytkownik doda≈Ç nowy plik? (To nadpisze usuniƒôcie, je≈õli zaznaczono oba, co jest ok)
                        const fileInput = document.getElementById(fileInputId);
                        if (fileInput && fileInput.files[0]) {
                            formData.append(backendFileField, fileInput.files[0]);
                        }
                    };

                    appendFileOrRemove('v_scan_registration', 'rm_scan_registration', 'scan_registration_card', 'remove_scan_registration_card');
                    appendFileOrRemove('v_scan_oc', 'rm_scan_oc', 'scan_policy_oc', 'remove_scan_policy_oc');
                    appendFileOrRemove('v_scan_ac', 'rm_scan_ac', 'scan_policy_ac', 'remove_scan_policy_ac');
                    appendFileOrRemove('v_scan_tech', 'rm_scan_tech', 'scan_tech_inspection', 'remove_scan_tech_inspection');
                    appendFileOrRemove('v_scan_service', 'rm_scan_service', 'scan_service_book', 'remove_scan_service_book');
                    appendFileOrRemove('v_scan_invoice', 'rm_scan_invoice', 'scan_purchase_invoice', 'remove_scan_purchase_invoice');

                    data = formData;
                }
                // 3. SZKODY
                else if (currentView === 'damages') {
                    data = {
                        pojazd: parseInt(document.getElementById('pojazd_id').value),
                        opis: document.getElementById('opis_szkody').value,
                        data_zdarzenia: document.getElementById('data_zdarzenia_val').value,
                        status_naprawy: document.getElementById('status_naprawy_val').value,
                        szacowany_koszt: 0
                    };
                }
                // 4. KIEROWCY
                else if (currentView === 'drivers') {
                    const userIdInput = document.getElementById('d_user_id');
                    const userId = userIdInput ? userIdInput.value : null;
                    if (!userId && !currentRecordId) { alert("ID u≈ºytkownika wymagane!"); return; }

                    data = {
                        ...(userId && { user: parseInt(userId) }),
                        numer_prawa_jazdy: document.getElementById('prawa_jazdy_num').value,
                        kategorie_prawa_jazdy: document.getElementById('kat_prawa_jazdy').value,
                        data_waznosci_prawa_jazdy: document.getElementById('data_waznosci_pj_val').value || null,
                        company: parseInt(document.getElementById('d_company_id').value) || null,
                        data_waznosci_badan: document.getElementById('data_badan_val').value || null
                    };
                }
                // 5. PRZEKAZANIA (ZMIANA NA FormData ABY WYSY≈ÅAƒÜ PLIKI)
                else if (currentView === 'handover' || currentView === 'hr_history') {
                    const formData = new FormData();
                    formData.append('pojazd', parseInt(document.getElementById('h_pojazd_id').value));
                    formData.append('kierowca', parseInt(document.getElementById('h_kierowca_id').value));
                    formData.append('data_wydania', document.getElementById('h_data_wydania').value);

                    formData.append('przebieg_start', document.getElementById('h_przebieg_start').value);
                    formData.append('przebieg_stop', document.getElementById('h_przebieg_stop').value || '');
                    formData.append('paliwo_start', document.getElementById('h_paliwo_start').value);
                    formData.append('paliwo_stop', document.getElementById('h_paliwo_stop').value || '');
                    formData.append('stawka_za_km', document.getElementById('h_stawka').value);
                    formData.append('koszt_brakujacego_paliwa', document.getElementById('h_doplata').value);

                    const zwrot = document.getElementById('h_data_zwrotu').value;
                    if (zwrot) formData.append('data_zwrotu', zwrot);
                    else formData.append('data_zwrotu', '');

                    formData.append('uwagi', document.getElementById('h_uwagi').value);

                    const appendFile = (fileId, removeId, fieldName, removeFlag) => {
                        const fileInput = document.getElementById(fileId);
                        if (fileInput && fileInput.files[0]) {
                            formData.append(fieldName, fileInput.files[0]);
                        }
                        const removeCb = document.getElementById(removeId);
                        if (removeCb && removeCb.checked) {
                            formData.append(removeFlag, 'true');
                        }
                    };

                    appendFile('h_scan_agreement', 'rm_h_agreement', 'scan_agreement', 'remove_scan_agreement');
                    appendFile('h_scan_handover', 'rm_h_handover', 'scan_handover_protocol', 'remove_scan_handover_protocol');
                    appendFile('h_scan_return', 'rm_h_return', 'scan_return_protocol', 'remove_scan_return_protocol');

                    data = formData;
                }
                // 6. REZERWACJE (Poprawiona logika FormData)
                else if (currentView === 'reservations') {
                        const formData = new FormData();

                        formData.append('first_name', document.getElementById('r_first_name').value);
                        formData.append('last_name', document.getElementById('r_last_name').value);
                        formData.append('company', document.getElementById('r_company').value);
                        formData.append('date_from', document.getElementById('r_date_from').value);
                        formData.append('date_to', document.getElementById('r_date_to').value);
                        formData.append('vehicle_type', document.getElementById('r_vehicle_type').value);
                        formData.append('status', document.getElementById('r_status').value);
                        formData.append('additional_info', document.getElementById('r_additional_info').value);

                        const assignedVal = document.getElementById('r_assigned_vehicle').value;
                        if (assignedVal) {
                            formData.append('assigned_vehicle', parseInt(assignedVal));
                        }

                        const driverVal = document.getElementById('r_driver_id').value;
                        if (driverVal) formData.append('driver', parseInt(driverVal));

                        // 1. OBS≈ÅUGA NOWYCH PLIK√ìW (MULTIPLE)
                        const fileInput = document.getElementById('r_new_files');
                        if (fileInput && fileInput.files.length > 0) {
                            for (let i = 0; i < fileInput.files.length; i++) {
                                // Appendujemy ka≈ºdy plik pod tym samym kluczem 'new_files'
                                // Django API potraktuje to jako listƒô
                                formData.append('new_files', fileInput.files[i]);
                            }
                        }

                        // 2. OBS≈ÅUGA USUWANIA PLIK√ìW
                        // Szukamy wszystkich zaznaczonych checkbox√≥w z klasƒÖ .remove-attachment-cb
                        const checkboxes = document.querySelectorAll('.remove-attachment-cb:checked');
                        checkboxes.forEach(cb => {
                            formData.append('remove_attachment_ids', parseInt(cb.value));
                        });

                        data = formData;
                }
                // 7. EDYCJA ISTNIEJƒÑCYCH (POLISY I SERWIS)
                else if (currentRecordId) {
                    const resolvedEndpoint = endpointMap[currentView] || currentView;

                    if (resolvedEndpoint === 'service_events') {
                        data = {
                            pojazd: parseInt(document.getElementById('pojazd_id').value),
                            opis: document.getElementById('opis_serwisu').value,
                            koszt: parseFloat(document.getElementById('koszt_val').value) || 0,
                            data_serwisu: document.getElementById('data_serwisu_val').value,
                            typ_zdarzenia: document.getElementById('typ_zdarzenia_val').value
                        };
                    } else if (resolvedEndpoint === 'policies') {
                        data = {
                            pojazd: parseInt(document.getElementById('pojazd_id').value),
                            numer_polisy: document.getElementById('numer_polisy').value,
                            ubezpieczyciel: document.getElementById('ubezpieczyciel_val').value,
                            data_waznosci_oc: document.getElementById('data_waznosci_oc').value,
                            data_waznosci_ac: document.getElementById('data_waznosci_ac').value || null
                        };
                    }
                }

                // 8. ZAPIS DOKUMENTU POJAZDU
                else if (currentView === 'vehicle_documents') {
                    const formData = new FormData();
                    formData.append('vehicle', document.getElementById('doc_vehicle_id').value);
                    formData.append('title', document.getElementById('doc_title').value);
                    formData.append('description', document.getElementById('doc_desc').value);

                    const fileInput = document.getElementById('doc_file');
                    if (fileInput.files[0]) {
                        formData.append('file', fileInput.files[0]);
                    }

                    data = formData;
                    // endpoint jest pobierany automatycznie z endpointMap
                }


                // --- WYSY≈ÅANIE ≈ªƒÑDANIA ---
                const headers = getAuthHeaders();

                // WA≈ªNE: Je≈õli wysy≈Çamy FormData (plik), usuwamy Content-Type (przeglƒÖdarka ustawi go sama)
                if (data instanceof FormData) {
                    delete headers['Content-Type'];
                }

                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: (data instanceof FormData) ? data : JSON.stringify(data)
                });

                if (response.status === 401) { handleLogout(); return; }

                if (response.ok) {
                    console.log("Zapis zako≈Ñczony sukcesem!");
                    document.getElementById('data-modal').style.display = "none";
                    loadView(currentView);
                } else {
                    const errorData = await response.json();
                    modalError.textContent = `B≈ÇƒÖd: ${JSON.stringify(errorData)}`;
                }
            } catch (error) {
                console.error("B≈ÇƒÖd handleSave:", error);
                if (modalError) modalError.textContent = "WystƒÖpi≈Ç b≈ÇƒÖd po stronie przeglƒÖdarki.";
            }
        }


        async function handleDelete() {
            if (!currentRecordId || !confirm(`Czy na pewno chcesz usunƒÖƒá rekord o ID: ${currentRecordId}?`)) {
                return;
            }

            const endpoint = endpointMap[currentView] || currentView;
            const url = `${API_BASE}${endpoint}/${currentRecordId}/`;

            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }

                if (response.status === 204) {
                    modal.style.display = "none";
                    loadView(currentView);
                } else {
                    modalError.textContent = `B≈ÇƒÖd usuwania (Status: ${response.status}).`;
                }

            } catch (error) {
                modalError.textContent = `B≈ÇƒÖd sieci podczas usuwania: ${error.message}`;
            }
        }

        deleteBtn.onclick = handleDelete;

        async function deleteRecord(viewName, id) {
            currentView = viewName;
            currentRecordId = id;
            await handleDelete();
        }

        function getActionButtons(record, viewName) {
            const id = record.id;
            return `
                <div class="action-buttons" style="display: flex; gap: 8px; justify-content: center;">
                    <button class="btn-edit"
                            onclick="openModal('${viewName}', ${id})"
                            style="cursor: pointer; padding: 5px 12px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px;">
                        Edytuj
                    </button>
                    <button class="btn-delete"
                            onclick="deleteRecord('${viewName}', ${id})"
                            style="cursor: pointer; padding: 5px 12px; background-color: #ff4d4d; color: white; border: none; border-radius: 4px;">
                        Usu≈Ñ
                    </button>
                </div>
            `;
        }

        async function renderVehicleDocsList() {
            const contentDiv = document.getElementById('docs-content');

            // Grid: Lp, Marka, Model, Rej, Dow√≥d, OC, AC, Badanie, KsiƒÖ≈ºka, Faktura
            const gridLayout = "40px 100px 100px 100px 1fr 1fr 1fr 1fr 1fr 1fr";

            // Style dla nag≈Ç√≥wka
            const headerStyle = `display: grid; grid-template-columns: ${gridLayout}; gap: 5px; font-weight: bold; padding: 10px; background: #fff3cd; border-bottom: 2px solid #ccc; font-size: 0.8em; text-align: center; align-items: center;`;

            contentDiv.innerHTML = `
                <div class="table-header-sm" style="${headerStyle}">
                    <div>Lp.</div>
                    <div>Marka</div>
                    <div>Model</div>
                    <div>Nr Rej.</div>
                    <div>Dow√≥d Rej.</div>
                    <div>Polisa OC</div>
                    <div>Polisa AC</div>
                    <div>Badanie Tech.</div>
                    <div>Ks. Serwisowa</div>
                    <div>Faktura Zakupu</div>
                </div>
                <div id="docs-list-items">≈Åadowanie danych...</div>
            `;

            const listDiv = document.getElementById('docs-list-items');

            try {
                // Pobieramy POJAZDY, bo to one teraz trzymajƒÖ te pliki
                const response = await fetch(API_BASE + 'vehicles/', { headers: getAuthHeaders() });
                const vehicles = await response.json();

                listDiv.innerHTML = '';
                if (vehicles.length === 0) {
                    listDiv.innerHTML = '<div style="padding:20px;">Brak pojazd√≥w w bazie.</div>';
                    return;
                }

                // Funkcja pomocnicza do generowania linku lub "Brak"
                const fileLink = (url, label) => {
                    if (url) {
                        return `<a href="${url}" target="_blank" style="display:block; background:#28a745; color:white; padding:4px; border-radius:4px; text-decoration:none; font-size:0.75em; text-align:center;">‚¨á ${label}</a>`;
                    }
                    return `<span style="color:#ccc; font-size:0.75em;">- brak -</span>`;
                };

                vehicles.forEach((v, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '5px';
                    row.style.padding = '8px 5px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';
                    row.style.textAlign = 'center';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div style="font-weight:bold;">${v.marka || '-'}</div>
                        <div>${v.model || '-'}</div>
                        <div style="color:#007bff; font-weight:bold;">${v.registration_number}</div>

                        <div>${fileLink(v.scan_registration_card, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_policy_oc, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_policy_ac, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_tech_inspection, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_service_book, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_purchase_invoice, 'Pobierz')}</div>
                    `;

                    // Opcjonalnie: Mo≈ºemy dodaƒá, ≈ºe klikniƒôcie w wiersz otwiera edycjƒô pojazdu, aby wgraƒá plik
                    row.style.cursor = "pointer";
                    row.title = "Kliknij, aby edytowaƒá pojazd i dodaƒá pliki";
                    row.onclick = (e) => {
                        // Nie otwieraj je≈õli klikniƒôto w link pobierania
                        if(e.target.tagName !== 'A') openModal('vehicles', v.id);
                    };

                    listDiv.appendChild(row);
                });

            } catch (e) {
                listDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${e.message}</div>`;
            }
        }

         async function renderServiceEvents(filterType = null) {
            const filterMap = {
                'inspection': {title: 'Inspekcje', type: 'INSPEKCJA'},
                'repairs': {title: 'Naprawy', type: 'NAPRAWA'},
                'reviews': {title: 'PrzeglƒÖdy Okresowe', type: 'PRZEGLAD'},
                'tech_inspections': {title: 'Badania Techniczne', type: 'BADANIE_TECH'},
            };

            const currentFilter = filterMap[filterType] || {title: 'Zdarzenia Serwisowe', type: null};
            currentView = filterType || 'service_events';
            viewTitle.textContent = currentFilter.title;

            // Sprawdzamy, czy to widok z VINem (PrzeglƒÖdy lub Badania)
            const showVinLayout = ['reviews', 'tech_inspections'].includes(filterType);

            let gridLayout = "";
            let headerHtml = "";

            if (showVinLayout) {
                // --- UK≈ÅAD DLA PRZEGLƒÑD√ìW I BADA≈É (Z VIN, OPISEM i KOSZTEM) ---

                // Dynamiczna nazwa nag≈Ç√≥wka daty
                let dateHeader = "Termin";
                if (filterType === 'reviews') dateHeader = "Termin przeglƒÖdu";
                if (filterType === 'tech_inspections') dateHeader = "Termin badania technicznego";

                // Grid: Lp(50), Rej(120), VIN(160), Opis(1fr - reszta miejsca), Koszt(100), Termin(140), Akcje(120)
                gridLayout = "50px 120px 160px 1fr 100px 140px 120px";

                headerHtml = `
                    <div>Lp.</div>
                    <div>Pojazd (Nr Rej.)</div>
                    <div>Nr VIN</div>
                    <div>Opis</div> <div>Koszt</div>
                    <div>${dateHeader}</div>
                    <div style="text-align: center;">Akcje</div>
                `;
            } else {
                // --- UK≈ÅAD DLA NAPRAW (STANDARDOWY) ---
                // Lp, Rej, Opis, Koszt, Data, Akcje
                gridLayout = "50px 120px 1fr 100px 120px 120px";
                headerHtml = `
                    <div>Lp.</div>
                    <div>Pojazd (Nr Rej.)</div>
                    <div>Opis Zdarzenia</div>
                    <div>Koszt</div>
                    <div>Data</div>
                    <div style="text-align: center;">Akcje</div>
                `;
            }

            mainContent.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #ebedef; border-bottom: 2px solid #ccc; align-items: center;">
                    ${headerHtml}
                </div>
                <div id="data-list">≈Åadowanie zdarze≈Ñ...</div>
            `;

            const dataListDiv = document.getElementById('data-list');

            try {
                const response = await fetch(API_BASE + 'service_events/', { headers: getAuthHeaders() });

                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                if (!response.ok) throw new Error(response.statusText);

                let events = await response.json();

                if (currentFilter.type) {
                     events = events.filter(e => e.typ_zdarzenia === currentFilter.type);
                }

                dataListDiv.innerHTML = '';

                if (events.length === 0) {
                    dataListDiv.innerHTML = '<div style="padding: 20px;">Brak wpis√≥w w tej kategorii.</div>';
                    return;
                }

                events.forEach((event, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';

                    if (showVinLayout) {
                        // Wiersz dla PrzeglƒÖd√≥w/Bada≈Ñ (z VIN, Opisem i Kosztem)
                        row.innerHTML = `
                            <div>${index + 1}.</div>
                            <div style="font-weight: bold;">${event.pojazd_nr_rej || '---'}</div>
                            <div style="font-family: monospace; font-size: 0.9em; color: #555;">${event.pojazd_vin || '---'}</div>

                            <div style="font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${event.opis}">
                                ${event.opis || '---'}
                            </div>

                            <div>${event.koszt} PLN</div>
                            <div>${event.data_serwisu}</div>
                            <div style="text-align: center;">${getActionButtons(event, currentView)}</div>
                        `;
                    } else {
                        // Wiersz dla Napraw
                        row.innerHTML = `
                            <div>${index + 1}.</div>
                            <div style="font-weight: bold;">${event.pojazd_nr_rej || '---'}</div>
                            <div style="font-size: 0.9em;">${event.opis}</div>
                            <div>${event.koszt} PLN</div>
                            <div>${event.data_serwisu}</div>
                            <div style="text-align: center;">${getActionButtons(event, currentView)}</div>
                        `;
                    }
                    dataListDiv.appendChild(row);
                });
            } catch (error) {
                dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}</div>`;
            }
        }

        async function renderPolicies() {
             currentView = 'policies';
             viewTitle.textContent = 'Polisy Ubezpieczeniowe';

             // ROZSZERZONY UK≈ÅAD KOLUMN:
             // Lp(40px), Rej(110px), VIN(160px), Ubezpieczyciel(1fr - elastyczny), Nr Polisy(130px), Koszt(90px), OC(100px), AC(100px), Akcje(100px)
             const gridLayout = "40px 110px 160px 1fr 130px 90px 100px 100px 100px";

             mainContent.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #ebedef; border-bottom: 2px solid #ccc; align-items: center;">
                    <div>Lp.</div>
                    <div>Nr Rej.</div>
                    <div>VIN</div> <div>Ubezpieczyciel</div>
                    <div>Nr Polisy</div>
                    <div>Koszt</div> <div title="Wa≈ºno≈õƒá OC">Wa≈ºno≈õƒá OC</div>
                    <div title="Wa≈ºno≈õƒá AC">Wa≈ºno≈õƒá AC</div>
                    <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie danych polis...</div>
             `;

             const dataListDiv = document.getElementById('data-list');
             try {
                 const response = await fetch(API_BASE + 'policies/', { headers: getAuthHeaders() });
                 if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                 if (!response.ok) throw new Error(response.statusText);

                 const policies = await response.json();
                 dataListDiv.innerHTML = '';

                 if (policies.length === 0) {
                    dataListDiv.innerHTML = '<div style="padding: 20px;">Brak polis. Kliknij DODAJ, aby utworzyƒá nowƒÖ.</div>';
                    return;
                 }

                 policies.forEach((policy, index) => {
                     const row = document.createElement('div');
                     row.className = 'table-row-sm';
                     row.style.display = 'grid';
                     row.style.gridTemplateColumns = gridLayout;
                     row.style.gap = '10px';
                     row.style.padding = '10px';
                     row.style.borderBottom = '1px solid #eee';
                     row.style.alignItems = 'center';

                     // Kolorowanie daty OC (czerwony je≈õli brak lub minƒô≈Ça - opcjonalnie mo≈ºna rozbudowaƒá)
                     const ocColor = policy.data_waznosci_oc ? 'black' : 'red';

                     row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div style="font-weight: bold;">${policy.pojazd_nr_rej || '---'}</div>

                        <div style="font-family: monospace; font-size: 0.9em; color: #555;">${policy.pojazd_vin || '---'}</div>

                        <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${policy.ubezpieczyciel}">
                            ${policy.ubezpieczyciel || '---'}
                        </div>

                        <div style="font-family: monospace; font-size: 0.9em;">${policy.numer_polisy}</div>
                        <div>${policy.koszt} PLN</div>

                        <div style="color: ${ocColor}; font-weight: bold;">${policy.data_waznosci_oc}</div>
                        <div style="font-size: 0.9em; color: #666;">${policy.data_waznosci_ac || '-'}</div>

                        <div style="text-align: center;">${getActionButtons(policy, 'policies')}</div>
                     `;
                     dataListDiv.appendChild(row);
                 });
             } catch (error) {
                 dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}. <br>Pamiƒôtaj o restarcie serwera po zmianie serializers.py!</div>`;
             }
         }

        async function renderDrivers() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            currentView = 'drivers';
            viewTitle.textContent = 'U≈ºytkownicy (Kierowcy)';

            const gridLayout = "40px 150px 1fr 120px 120px 60px 110px 100px";

            mainContent.innerHTML = `
                <div class="table-header" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; padding: 10px; background: #ebedef; font-weight: bold; border-bottom: 2px solid #ccc;">
                    <div>Lp.</div>
                    <div>Kierowca</div>
                    <div>Email</div>
                    <div>Firma</div>
                    <div>Nr Pr. Jazdy</div>
                    <div>Kat.</div>
                    <div>Badania lek.</div>
                    <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie...</div>
            `;

            const dataList = document.getElementById('data-list');

            try {
                const response = await fetch(`${API_BASE}drivers/`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                dataList.innerHTML = '';
                data.forEach((driver, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.alignItems = 'center';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';

                    const fName = driver.first_name || '';
                    const lName = driver.last_name || '';
                    const fullName = `${fName} ${lName}`.trim();

                    const displayName = fullName !== '' ? fullName : (driver.user_name || '---');

                    const dataBadan = driver.data_waznosci_badan || '---';
                    const kolorBadan = (dataBadan !== '---') ? 'green' : '#666';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div style="font-weight: bold;">${displayName}</div>
                        <div style="font-size: 0.9em; overflow: hidden; text-overflow: ellipsis;">${driver.email || '---'}</div>
                        <div>${driver.company_name || '<span style="color: #ccc;">Brak</span>'}</div>
                        <div style="font-family: monospace;">${driver.numer_prawa_jazdy || '---'}</div>
                        <div style="text-align: center;">${driver.kategorie_prawa_jazdy || '---'}</div>
                        <div style="color: ${kolorBadan}; font-weight: bold; font-size: 0.85em;">${dataBadan}</div>
                        <div style="text-align: center;">${getActionButtons(driver, 'drivers')}</div>
                    `;
                    dataList.appendChild(row);
                });
            } catch (error) {
                console.error("B≈ÇƒÖd ≈Çadowania kierowc√≥w:", error);
                dataList.innerHTML = '<div style="color: red; padding: 10px;">B≈ÇƒÖd ≈Çadowania danych.</div>';
            }
        }

        async function renderHandovers() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            currentView = 'handover';
            viewTitle.textContent = 'Przekazania Pojazd√≥w';

            // NOWA SIATKA (GRID):
            // Zdefiniowa≈Çem szeroko≈õci tak, aby dane siƒô mie≈õci≈Çy,
            // a "1fr" przy "Uwagi" sprawia, ≈ºe tabela zajmuje 100% szeroko≈õci.
            // Lp(40px), Imie(100px), Nazwisko(110px), Firma(100px), Marka(100px), Model(100px), Rej(100px), Wydanie(110px), Zwrot(110px), UWAGI(1fr - reszta), Akcje(100px)
            const gridLayout = "40px 100px 110px 100px 100px 100px 100px 110px 110px 1fr 100px";

            mainContent.innerHTML = `
                <div class="table-header" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; padding: 10px; background: #ebedef; font-weight: bold; border-bottom: 2px solid #ccc; font-size: 0.85em; align-items: center;">
                    <div>Lp.</div>
                    <div>Imiƒô</div>
                    <div>Nazwisko</div>
                    <div>Firma</div>
                    <div>Marka</div>
                    <div>Model</div>
                    <div>Rejestracja</div>
                    <div>Data Przyp.</div>
                    <div>Data Oddania</div>
                    <div>Uwagi</div> <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie danych...</div>
            `;

            const dataList = document.getElementById('data-list');

            try {
                const response = await fetch(`${API_BASE}handovers/`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) { handleLogout(); return; }
                if (!response.ok) throw new Error("B≈ÇƒÖd API: " + response.status);

                const handovers = await response.json();
                dataList.innerHTML = '';

                if (handovers.length === 0) {
                    dataList.innerHTML = '<div style="padding: 20px; text-align: center;">Brak danych w bazie. Kliknij DODAJ, aby stworzyƒá pierwsze przekazanie.</div>';
                    return;
                }

                handovers.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row';

                    // Stylizacja wiersza
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.fontSize = '0.85em';
                    row.style.alignItems = 'center';

                    // Logika koloru dla daty zwrotu
                    const zwrotText = item.data_zwrotu || '<span style="color: green; font-weight: bold;">W u≈ºytku</span>';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div>${item.imie || '-'}</div>
                        <div style="font-weight: bold;">${item.nazwisko || '-'}</div>
                        <div>${item.firma || '-'}</div>
                        <div>${item.marka || '-'}</div>
                        <div>${item.model || '-'}</div>
                        <div>${item.rejestracja || '-'}</div>
                        <div>${item.data_wydania}</div>
                        <div>${zwrotText}</div>

                        <div style="color: #555; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.uwagi || ''}">
                            ${item.uwagi || '-'}
                        </div>

                        <div style="text-align: center;">${getActionButtons(item, 'handover')}</div>
                    `;
                    dataList.appendChild(row);
                });
            } catch (error) {
                dataList.innerHTML = `<div style="color:red; padding:10px;">B≈ÇƒÖd po≈ÇƒÖczenia z serwerem: ${error.message}</div>`;
            }
        }

        async function renderVehicles() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            currentView = 'vehicles';
            viewTitle.textContent = 'Pojazdy';

            // Grid: Lp, Marka, Model, Typ, Rej, VIN, Paliwo, Przebieg, Firma, U≈ºytkownik, Status, Uwagi, Akcje
            const gridLayout = "40px 100px 100px 100px 100px 150px 100px 100px 100px 120px 100px 1fr 120px";

            mainContent.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #ebedef; border-bottom: 2px solid #ccc; align-items: center; font-size: 0.85em;">
                    <div>Lp.</div>
                    <div>Marka</div>
                    <div>Model</div>
                    <div>Typ</div>
                    <div>Nr Rej.</div>
                    <div>VIN</div>
                    <div>Paliwo</div>
                    <div>Przebieg</div>
                    <div>Firma</div>
                    <div>U≈ºytkownik</div>
                    <div>Status</div>
                    <div>Uwagi</div>
                    <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie pojazd√≥w...</div>
            `;

            const dataList = document.getElementById('data-list');

            try {
                const response = await fetch(API_BASE + 'vehicles/', { headers: getAuthHeaders() });
                if (response.status === 401) { handleLogout(); return; }
                const vehicles = await response.json();

                dataList.innerHTML = '';
                if (vehicles.length === 0) {
                    dataList.innerHTML = '<div style="padding: 20px;">Brak pojazd√≥w. Kliknij DODAJ.</div>';
                    return;
                }

                vehicles.forEach((v, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';
                    row.style.fontSize = '0.85em';

                    const statusColor = v.status === 'SPRAWNY' ? 'green' : 'red';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div style="font-weight:bold;">${v.marka || '-'}</div>
                        <div>${v.model || '-'}</div>
                        <div>${v.typ_display || v.typ_pojazdu}</div>
                        <div style="color:#007bff; font-weight:bold;">${v.registration_number}</div>
                        <div style="font-family:monospace;">${v.vin}</div>
                        <div>${v.fuel_type_display || v.fuel_type}</div>
                        <div>${v.przebieg} km</div>
                        <div>${v.company_name || '-'}</div>
                        <div>${v.assigned_user_name || '-'}</div>
                        <div style="color:${statusColor}; font-weight:bold;">${v.status_display || v.status}</div>
                        <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${v.uwagi || ''}">${v.uwagi || '-'}</div>
                        <div style="text-align: center;">${getActionButtons(v, 'vehicles')}</div>
                    `;
                    dataList.appendChild(row);
                });
            } catch (error) {
                dataList.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}</div>`;
            }
        }


        async function renderReservations() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            currentView = 'reservations';
            viewTitle.textContent = 'Rezerwacje Pojazd√≥w';

            // Grid: Lp, Imiƒô, Nazwisko, Firma, Typ, Pojazd, Termin, Status, INFO, Akcje
            const gridLayout = "40px 100px 100px 120px 100px 120px 140px 130px 1fr 100px";

            mainContent.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #ebedef; border-bottom: 2px solid #ccc; align-items: center;">
                    <div>Lp.</div>
                    <div>Imiƒô</div>
                    <div>Nazwisko</div>
                    <div>Firma</div>
                    <div>Typ</div>
                    <div>Pojazd</div>
                    <div>Termin</div>
                    <div>Status</div>
                    <div>Info</div>
                    <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie rezerwacji...</div>
            `;

            const dataList = document.getElementById('data-list');

            try {
                const response = await fetch(API_BASE + 'reservations/', { headers: getAuthHeaders() });
                if (response.status === 401) { handleLogout(); return; }

                const data = await response.json();
                dataList.innerHTML = '';

                if (data.length === 0) {
                    dataList.innerHTML = '<div style="padding: 20px;">Brak rezerwacji. Kliknij DODAJ, aby z≈Ço≈ºyƒá zam√≥wienie.</div>';
                    return;
                }

                data.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';

                    let statusColor = '#333';
                    let statusBg = '#f0f0f0';
                    if (item.status === 'OCZEKUJACE') { statusColor = '#856404'; statusBg = '#fff3cd'; }
                    if (item.status === 'PRZYJETE') { statusColor = '#004085'; statusBg = '#cce5ff'; }
                    if (item.status === 'ZATWIERDZONE') { statusColor = '#155724'; statusBg = '#d4edda'; }
                    if (item.status === 'ODRZUCONE') { statusColor = '#721c24'; statusBg = '#f8d7da'; }

                    const dOd = item.date_from || '<span style="color:#ccc">---</span>';
                    const dDo = item.date_to || '<span style="color:#ccc">---</span>';
                    const terminHtml = `<div style="font-size:0.85em; line-height:1.4em;">Od: <b>${dOd}</b><br>Do: <b>${dDo}</b></div>`;

                    const typHtml = `<span class="badge" style="background:#e6f7ff; padding: 2px 5px; border-radius:4px; font-size:0.9em;">${item.vehicle_type}</span>`;

                    let pojazdHtml = '<span style="color: #ccc;">---</span>';
                    if (item.assigned_vehicle_display) {
                        pojazdHtml = `<strong style="color: #007bff;">${item.assigned_vehicle_display}</strong>`;
                    }

                    // --- OBS≈ÅUGA KOLUMNY INFO (Notatka + Link do PDF) ---
                    let infoContent = '';
                    if (item.additional_info) {
                        infoContent += `<div style="font-style:italic; color:#555; margin-bottom:4px;">${item.additional_info}</div>`;
                    }

                    // Sprawdzamy, czy sƒÖ za≈ÇƒÖczniki w nowym modelu
                    if (item.attachments && item.attachments.length > 0) {
                        infoContent += `<div style="display:flex; flex-wrap:wrap; gap:5px;">`;
                        item.attachments.forEach(att => {
                            // Skr√≥cona nazwa pliku (np. ostatnie 10 znak√≥w) lub ikonka
                            infoContent += `
                                <a href="${att.file}" target="_blank" title="Pobierz plik"
                                   style="text-decoration:none; background:#eee; padding:2px 6px; border-radius:4px; font-size:0.8em; color:#333; border:1px solid #ccc;">
                                   üìÑ PDF
                                </a>
                            `;
                        });
                        infoContent += `</div>`;
                    }
                    else if (item.scan_agreement) {
                        // Wsparcie dla starego pola (je≈õli jeszcze jakie≈õ dane tam zosta≈Çy)
                        infoContent += `<div><a href="${item.scan_agreement}" target="_blank" style="color:blue;">üìÑ Stary plik</a></div>`;
                    }

                    if (!infoContent) infoContent = '<span style="color:#ccc;">-</span>';
                    // ----------------------------------------------------

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div>${item.first_name}</div>
                        <div style="font-weight: bold;">${item.last_name}</div>
                        <div>${item.company}</div>
                        <div>${typHtml}</div>
                        <div>${pojazdHtml}</div>
                        <div>${terminHtml}</div>
                        <div>
                            <span style="background-color: ${statusBg}; color: ${statusColor}; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85em;">
                                ${item.status}
                            </span>
                        </div>
                        <div style="font-size: 0.85em; overflow: hidden;">${infoContent}</div>

                        <div style="text-align: center;">${getActionButtons(item, 'reservations')}</div>
                    `;
                    dataList.appendChild(row);
                });
            } catch (error) {
                dataList.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}</div>`;
            }
        }

        async function renderRentalHistoryList() {
            const contentDiv = document.getElementById('docs-content');

            // Grid bez ID Rezerwacji
            const gridLayout = "40px 100px 100px 120px 100px 100px 100px 1fr 60px";

            let html = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #d4edda; border-bottom: 2px solid #ccc; font-size: 0.8em; align-items: center;">
                    <div>Lp.</div>
                    <div>Imiƒô</div>
                    <div>Nazwisko</div>
                    <div>Firma</div>
                    <div>Nr Rej.</div>
                    <div>Wydano</div>
                    <div>Zwr√≥cono</div>
                    <div style="text-align:center;">Dokumenty (Umowa / Wydanie / Zwrot)</div>
                    <div style="text-align:center;">Edycja</div>
                </div>
                <div id="history-list-items">≈Åadowanie...</div>
            `;
            contentDiv.innerHTML = html;

            const listDiv = document.getElementById('history-list-items');

            try {
                const response = await fetch(API_BASE + 'handovers/', { headers: getAuthHeaders() });
                const data = await response.json();

                data.sort((a, b) => new Date(b.data_wydania) - new Date(a.data_wydania));

                listDiv.innerHTML = '';
                if (data.length === 0) {
                    listDiv.innerHTML = '<div style="padding:20px;">Brak historii najmu.</div>';
                    return;
                }

                // Helper do przycisk√≥w
                const fileBtn = (url, label, color) => {
                    if(!url) return `<span style="color:#ccc; font-size:0.8em; margin-right:5px; opacity:0.5;">${label}</span>`;
                    return `<a href="${url}" target="_blank" style="background:${color}; color:white; padding:3px 6px; border-radius:4px; text-decoration:none; font-size:0.75em; margin-right:5px;">‚¨á ${label}</a>`;
                };

                data.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '8px 10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';
                    row.style.fontSize = '0.85em';

                    const zwrot = item.data_zwrotu || '<span style="color:green; font-weight:bold;">W TRAKCIE</span>';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div>${item.imie || '-'}</div>
                        <div>${item.nazwisko || '-'}</div>
                        <div>${item.firma || '-'}</div>
                        <div style="color:#007bff; font-weight:bold;">${item.rejestracja}</div>
                        <div>${item.data_wydania}</div>
                        <div>${zwrot}</div>
                        <div style="display:flex; justify-content:center; align-items:center;">
                            ${fileBtn(item.scan_agreement, 'Umowa', '#007bff')}
                            ${fileBtn(item.scan_handover_protocol, 'Wydanie', '#28a745')}
                            ${fileBtn(item.scan_return_protocol, 'Zwrot', '#dc3545')}
                        </div>
                        <div style="text-align:center;">
                            <button onclick="openModal('handover', ${item.id})" style="cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:4px; padding:2px 6px;">‚úèÔ∏è</button>
                        </div>
                    `;
                    listDiv.appendChild(row);
                });

            } catch (e) {
                listDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${e.message}</div>`;
            }
        }


        async function renderHrDocs(activeTab = 'documents') {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            viewTitle.textContent = 'Dokumentacja i Historia';

            // 1. Pasek zak≈Çadek
            const navHtml = `
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
                    <button onclick="renderHrDocs('documents')"
                        style="padding: 10px 20px; cursor: pointer; border: none; background: ${activeTab === 'documents' ? '#007bff' : '#e9ecef'}; color: ${activeTab === 'documents' ? 'white' : 'black'}; border-radius: 4px; font-weight: bold;">
                        üìÇ Dokumenty Pojazdu
                    </button>
                    <button onclick="renderHrDocs('history')"
                        style="padding: 10px 20px; cursor: pointer; border: none; background: ${activeTab === 'history' ? '#007bff' : '#e9ecef'}; color: ${activeTab === 'history' ? 'white' : 'black'}; border-radius: 4px; font-weight: bold;">
                        üìú Historia Najmu
                    </button>
                </div>
                <div id="docs-content">≈Åadowanie...</div>
            `;

            mainContent.innerHTML = navHtml;

            const addBtn = document.getElementById('add-btn');

            // 2. Logika widoczno≈õci i kontekstu przycisku
            if (activeTab === 'documents') {
                // Ustawiamy currentView na 'vehicle_documents', ≈ºeby przycisk DODAJ wiedzia≈Ç co robiƒá
                currentView = 'vehicle_documents';
                addBtn.style.display = 'none';

                // WA≈ªNE: Tutaj usunƒÖ≈Çem linijkƒô "addBtn.onclick = ...",
                // poniewa≈º loadView i tak ustawi domy≈õlne dzia≈Çanie openModal(currentView)

                await renderVehicleDocsList();
            } else {
                currentView = 'hr_history';
                addBtn.style.display = 'none';
                await renderRentalHistoryList();
            }
        }

        async function fetchDrivers() {
            try {
                const response = await fetch(API_BASE + 'drivers/', { headers: getAuthHeaders() });
                if (!response.ok) return [];
                return await response.json();
            } catch (e) { return []; }
        }

        async function renderDamageEvents() {
            viewTitle.textContent = 'Zdarzenia Szkodowe i Awarie';
            const token = localStorage.getItem('access_token');
            mainContent.innerHTML = `
                <div class="table-header" style="grid-template-columns: 50px 120px 1fr 150px 150px 120px;">
                    <div>Lp.</div>
                    <div>Nr Rej.</div>
                    <div>Opis Szkody</div>
                    <div>Data</div>
                    <div>Status</div>
                    <div>Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie szk√≥d...</div>
            `;

            const dataListDiv = document.getElementById('data-list');

            try {
                const response = await fetch('http://127.0.0.1:8000/api/damage_events/', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const damages = await response.json();

                dataListDiv.innerHTML = '';
                damages.forEach((damage, index) => {
                    const statusMap = {
                        'ZGLOSZONA': { txt: 'Zg≈Çoszona', col: '#ffc107' },
                        'W_NAPRAWIE': { txt: 'W naprawie', col: '#17a2b8' },
                        'ZAMKNIETA': { txt: 'Zamkniƒôta', col: '#28a745' }
                    };
                    const status = statusMap[damage.status_naprawy] || { txt: damage.status_naprawy, col: '#6c757d' };

                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.style.gridTemplateColumns = "50px 120px 1fr 150px 150px 120px";
                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div>${damage.pojazd_nr_rej}</div>
                        <div>${damage.opis}</div>
                        <div>${damage.data_zdarzenia}</div>
                        <div style="color: ${status.col}; font-weight: bold;">${status.txt}</div>
                        <div>${getActionButtons(damage, 'damages')}</div>
                    `;
                    dataListDiv.appendChild(row);
                });
            } catch (err) {
                dataListDiv.innerHTML = `<p style="color:red;">B≈ÇƒÖd: ${err.message}</p>`;
            }
        }
         function renderPlaceholder(title) {
             currentView = title;
             viewTitle.textContent = title;
             mainContent.innerHTML = `<div style="padding: 40px; text-align: center; color: #6c757d;">
                 <h2>${title}</h2>
                 <p>Ten modu≈Ç wymaga osobnego endpointu API Django, modelu i logiki biznesowej. Front-end jest gotowy!</p>
             </div>`;
         }


        // --- NOWA LOGIKA DLA KALENDARZA ---

        let currentDate = new Date();

        async function fetchCalendarEvents() {
            const headers = getAuthHeaders();
            let events = [];

            try {
                const serviceResponse = await fetch(API_BASE + 'service_events/', { headers });
                if (serviceResponse.ok) {
                    const serviceEvents = await serviceResponse.json();
                    serviceEvents.forEach(e => {
                        if (e.data_serwisu) {
                            let type;
                            if (e.typ_zdarzenia.toLowerCase().includes('przeglad')) {
                                type = 'review';
                            } else if (e.typ_zdarzenia.toLowerCase().includes('naprawa')) {
                                type = 'repair';
                            } else {
                                type = 'inspection';
                            }
                            events.push({
                                date: e.data_serwisu,
                                title: `${e.pojazd_nr_rej} - ${e.typ_zdarzenia}`,
                                type: type,
                                record: e
                            });
                        }
                    });
                }

                const policyResponse = await fetch(API_BASE + 'policies/', { headers });
                if (policyResponse.ok) {
                    const policies = await policyResponse.json();
                    policies.forEach(p => {
                        if (p.data_waznosci_oc) {
                            events.push({
                                date: p.data_waznosci_oc,
                                title: `${p.pojazd_nr_rej} - Wa≈ºno≈õƒá OC`,
                                type: 'policy',
                                record: p
                            });
                        }
                        if (p.data_waznosci_ac && p.data_waznosci_ac !== 'Brak') {
                             events.push({
                                date: p.data_waznosci_ac,
                                title: `${p.pojazd_nr_rej} - Wa≈ºno≈õƒá AC`,
                                type: 'policy',
                                record: p
                            });
                        }
                    });
                }

            } catch (error) {
                console.error("B≈ÇƒÖd ≈Çadowania zdarze≈Ñ do kalendarza:", error);
            }

            return events;
        }

        function filterTable() {
            const input = document.getElementById('table-search');
            if (!input) return;

            const filter = input.value.toLowerCase();
            const rows = document.querySelectorAll('.table-row');

            rows.forEach(row => {
                const text = row.textContent || row.innerText;
                row.style.display = text.toLowerCase().includes(filter) ? "grid" : "none";
            });
        }

        async function renderCalendar() {
            currentView = 'calendar';
            viewTitle.textContent = 'Terminarz Floty';

            const allEvents = await fetchCalendarEvents();
            generateCalendarHTML(allEvents, currentDate);
        }

        function generateCalendarHTML(events, displayDate) {
            mainContent.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'calendar-view';

            const year = displayDate.getFullYear();
            const month = displayDate.getMonth();

            const monthNames = ["Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec",
                                "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"];

            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.innerHTML = `
                <button onclick="changeMonth(-1)">&#9664; Poprzedni</button>
                <span>${monthNames[month]} ${year}</span>
                <button onclick="changeMonth(1)">Nastƒôpny &#9654;</button>
            `;
            container.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'calendar-grid';

            const dayNames = ["Pon", "Wto", "≈öro", "Czw", "PiƒÖ", "Sob", "Nie"];
            dayNames.forEach(day => {
                const dayNameDiv = document.createElement('div');
                dayNameDiv.className = 'day-name';
                dayNameDiv.textContent = day;
                grid.appendChild(dayNameDiv);
            });

            const firstDayOfMonth = new Date(year, month, 1);
            const dayOfWeek = (firstDayOfMonth.getDay() === 0) ? 6 : firstDayOfMonth.getDay() - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < dayOfWeek; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day current-month';
                dayDiv.setAttribute('data-date', dateString);

                dayDiv.innerHTML = `<span class="calendar-day-number">${day}</span>`;

                const dayEvents = events.filter(e => e.date === dateString);

                const borderClasses = new Set();

                dayEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    let borderClass = '';

                    if (event.type === 'policy') {
                        eventDiv.className = `event-item event-policy`;
                        borderClass = 'day-border-policy';
                    } else if (event.type === 'review') {
                        eventDiv.className = `event-item event-review`;
                        borderClass = 'day-border-review';
                    } else if (event.type === 'inspection') {
                        eventDiv.className = `event-item event-inspection`;
                        borderClass = 'day-border-inspection';
                    } else if (event.type === 'repair') {
                        eventDiv.className = `event-item event-repair`;
                        borderClass = 'day-border-repair';
                    } else {
                        eventDiv.className = `event-item`;
                    }

                    eventDiv.title = event.title;
                    eventDiv.textContent = event.title;
                    dayDiv.appendChild(eventDiv);

                    if (borderClass) {
                        borderClasses.add(borderClass);
                    }
                });

                borderClasses.forEach(className => dayDiv.classList.add(className));

                grid.appendChild(dayDiv);
            }

            container.appendChild(grid);
            mainContent.appendChild(container);
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }
        window.changeMonth = changeMonth;


        // --- LOGIKA PRZE≈ÅƒÑCZANIA WIDOK√ìW I AUTORYZACJI ---

        const viewMap = {
            'vehicles': renderVehicles,
            'drivers': renderDrivers,
            'damages': renderDamageEvents,
            'handover': renderHandovers,
            'calendar': renderCalendar,
            'policies': renderPolicies,
            'reservations': renderReservations,

            // --- NAPRAWIONE ZAK≈ÅADKI SERWISOWE ---
            // Teraz wywo≈ÇujƒÖ funkcjƒô renderServiceEvents z odpowiednim filtrem
            'reviews': () => renderServiceEvents('reviews'),
            'repairs': () => renderServiceEvents('repairs'),
            'tech_inspections': () => renderServiceEvents('tech_inspections'),
            'inspection': () => renderServiceEvents('inspection'),

            // --- BRAKUJƒÑCE ZAK≈ÅADKI (ZABEZPIECZENIE PRZED B≈ÅƒòDEM) ---
            // Dziƒôki temu klikniƒôcie nie spowoduje b≈Çƒôdu w konsoli
            'hr_docs': () => renderHrDocs('documents'),
            'settlements': () => renderPlaceholder('Rozliczenia'),
            'other': () => renderPlaceholder('Pozosta≈Çe'),
            'settings': () => renderPlaceholder('Ustawienia')
        };

        function loadView(viewName) {
            menuItems.forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`[data-view="${viewName}"]`);
            if(activeItem) {
                activeItem.classList.add('active');
            }

            const parentView = activeItem ? activeItem.closest('.menu-item') : null;
            if (parentView) {
                parentView.classList.add('active');
            }

            currentView = viewName;

            addBtn.onclick = () => openModal(currentView);

            const isCalendarRelated = ['calendar', 'policies', 'tech_inspections', 'reviews', 'repairs', 'legalization', 'inspection'].includes(viewName);

            if (viewName === 'calendar' || viewName === 'settings' || viewName === 'settlements') {
                 // Tu mo≈ºesz ukryƒá przycisk dla widok√≥w, gdzie nie ma dodawania
                 // addBtn.style.display = 'none';
                 // Ale zostawmy 'inline' dla sp√≥jno≈õci, chyba ≈ºe wolisz ukrywaƒá
                 addBtn.style.display = 'inline';
            } else {
                addBtn.style.display = 'inline';
            }

            viewMap[viewName]();
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                if (localStorage.getItem('access_token')) {
                    loadView(item.dataset.view);
                }
            });
        });

        function checkAuthentication() {
            const accessToken = localStorage.getItem('access_token');
            const userRole = localStorage.getItem('user_role');

            if (accessToken && userRole) {
                loginContainer.style.display = 'none';
                mainApp.style.display = 'flex';
                updateHeaderUser();
                loadView('vehicles');
            } else {
                loginContainer.style.display = 'flex';
                mainApp.style.display = 'none';
            }
        }

        checkAuthentication();
    </script>

</body>
</html>