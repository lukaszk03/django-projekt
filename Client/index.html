<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FLEETSYS - Pe≈Çny Interfejs Floty</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöõ</text></svg>">
    <style>
        /* CSS dla ca≈Çego uk≈Çadu */
        body {
            display: flex;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            width: 100%;
            height: 100vh;
        }

        /* --- STYLY DLA LOGOWANIA (NOWY MOTYW) --- */
        .login-container {
            display: none; /* Domy≈õlnie ukryte, JS to w≈ÇƒÖcza */
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            /* Gradient pasujƒÖcy do Sidebaru (#2c3e50) */
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); /* G≈Çadszy cie≈Ñ */
            width: 350px;
            text-align: center;
            position: relative;
        }

        /* Logo/Ikona nad formularzem */
        .login-logo {
            font-size: 3em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .login-box h2 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-box p {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .login-box input[type="text"],
        .login-box input[type="password"],
        .login-box input[type="email"],
        .login-box select {
            width: 100%;
            padding: 12px;
            margin: 8px 0 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            background-color: #f9f9f9;
        }

        .login-box input:focus, .login-box select:focus {
            border-color: #16a085; /* Zielony akcent przy pisaniu */
            outline: none;
            background-color: #fff;
        }

        .login-box button {
            background-color: #16a085; /* ZIELONY (jak w menu) */
            color: white;
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .login-box button:hover {
            background-color: #1abc9c; /* Ja≈õniejszy zielony po najechaniu */
        }

        .login-box a {
            color: #16a085;
            text-decoration: none;
            font-weight: bold;
        }
        .login-box a:hover {
            text-decoration: underline;
        }

        /* --- STYLY DLA G≈Å√ìWNEJ APLIKACJI --- */
        .main-app { display: none; width: 100%; height: 100vh; display: flex; overflow: hidden;}
        .sidebar {
            width: 250px;
            background-color: #2c3e50; /* Ciemne t≈Ço */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding-top: 0;
            min-height: 100vh;
            overflow-y: auto;
            color: #ecf0f1;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .text-ellipsis {
            white-space: nowrap;      /* Nie zawijaj tekstu do nowej linii */
            overflow: hidden;         /* Ukryj to, co wystaje */
            text-overflow: ellipsis;  /* Dodaj trzy kropki (...) na ko≈Ñcu */
            display: block;           /* Wa≈ºne dla poprawnego dzia≈Çania wewnƒÖtrz Grid */
            max-width: 100%;          /* Nie przekraczaj szeroko≈õci kom√≥rki */
        }

        /* Nag≈Ç√≥wek FLEETSYS */
        .sidebar-header {
            background-color: #1a252f; /* Jeszcze ciemniejszy nag≈Ç√≥wek */
            padding: 20px;
            font-size: 1.5em;
            color: #ffffff;
            font-weight: 900;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

       .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px; /* Odstƒôp ikony od tekstu */
            font-size: 14px;
            color: #bdc3c7; /* Jasnoszary tekst nieaktywny */
            transition: all 0.3s ease;
            border-left: 5px solid transparent; /* Pasek aktywno≈õci (ukryty) */
        }

        .menu-item i {
            width: 20px; /* Sta≈Ça szeroko≈õƒá dla ikon ≈ºeby tekst by≈Ç r√≥wno */
            text-align: center;
        }

        .menu-item:hover {
            background-color: #34495e;
            color: #ffffff;
        }

        /* Aktywny element - Zielony pasek */
        .menu-item.active {
            background-color: #34495e;
            color: #ffffff;
            font-weight: bold;
            border-left: 5px solid #16a085; /* ZIELONY PASEK */
        }

        .menu-subitem {
            padding: 10px 20px 10px 55px; /* Wciƒôcie */
            cursor: pointer;
            color: #bdc3c7; /* TEN SAM KOLOR CO G≈Å√ìWNE MENU */
            font-size: 13px;
            display: flex;
            align-items: center;
            background-color: #2c3e50;
            transition: color 0.3s ease;
        }
        
        .menu-subitem:hover { 
            color: #ffffff; /* Bia≈Çy po najechaniu */
            background-color: #34495e; 
        }
        
        .menu-subitem.active { 
            color: #ffffff; 
            font-weight: bold;
            background-color: #34495e;
        }

        /* Przycisk DODAJ (Zielony, pasujƒÖcy do stylu) */
        .btn-add {
            background-color: #16a085; /* Zielony morski */
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        /* --- STYLY DLA POWIADOMIE≈É --- */
        .btn-notif {
            background: none;
            border: none;
            font-size: 1.4em;
            cursor: pointer;
            position: relative;
            color: #555;
            margin-right: 15px; /* Odstƒôp od wyszukiwarki */
            transition: color 0.3s;
        }
        .btn-notif:hover { color: #007bff; }

        /* Czerwona kropka z licznikiem */
        .notif-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #dc3545; /* Czerwony */
            color: white;
            font-size: 0.6em;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 50%;
            min-width: 15px;
            display: none; /* Domy≈õlnie ukryte, poka≈ºemy jak bƒôdƒÖ alerty */
        }

        /* Styl kafelka powiadomienia na li≈õcie */
        .alert-card {
            background: white;
            border-left: 5px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alert-critical { border-left-color: #dc3545; background-color: #fff5f5; } /* Przeterminowane */
        .alert-warning { border-left-color: #ffc107; background-color: #fffbf0; } /* Zbli≈ºajƒÖce siƒô */


        .btn-add:hover { background-color: #1abc9c; }

        .menu-subitem:hover, .menu-subitem.active { background-color: #f0f8ff; color: #007bff; }

        .content-area { flex-grow: 1; padding: 20px 40px; overflow-y: auto; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h1 { margin: 0; font-size: 24px; }

        .btn-add { background-color: #28a745; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; }

        .table-container { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .table-header, .table-row { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 1fr 1fr 120px; padding: 12px 0; border-bottom: 1px solid #ddd; }
        .table-header { font-weight: bold; background-color: #e9ecef; }
        .table-header-sm, .table-row-sm { display: grid; grid-template-columns: 50px 1.5fr 1fr 1.5fr 1fr 120px; padding: 12px 0; border-bottom: 1px solid #ddd; }
        .table-header-sm { font-weight: bold; background-color: #e9ecef; }
        .error { color: red; text-align: center; padding: 20px; font-size: 1.1em; }

        /* --- STYLY DLA MODALU --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-content button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        .btn-save { background-color: #007bff; color: white; }
        #delete-btn { background-color: #dc3545; color: white; float: right; }

        /* --- STYLY DLA KOLOROWYCH K√ì≈ÅEK W MENU --- */
        .color-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .dot-policy { background-color: #007bff; }
        .dot-review { background-color: #28a745; }
        .dot-inspection { background-color: #ffc107; }
        .dot-repair { background-color: #dc3545; }

        /* --- STYLY DLA KALENDARZA --- */
        .calendar-view {
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .day-name {
            font-weight: bold;
            padding: 10px 0;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .calendar-day {
            min-height: 100px;
            padding: 5px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: left;
        }
        .calendar-day.current-month { background-color: #ffffff; }
        .calendar-day:hover { background-color: #e6f7ff; }
        .calendar-day-number { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; display: block; color: #333; }

        .event-item {
            font-size: 0.75em;
            padding: 2px 4px;
            margin-top: 2px;
            border-radius: 3px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-review { background-color: #28a745; }
        .event-inspection { background-color: #ffc107; }
        .event-policy { background-color: #007bff; }
        .event-repair { background-color: #dc3545; }

        .day-border-policy { border: 2px solid #007bff !important; }
        .day-border-review { border: 2px solid #28a745 !important; }
        .day-border-inspection { border: 2px solid #ffc107 !important; }
        .day-border-repair { border: 2px solid #dc3545 !important; }

        /* --- STYLY DLA PROFILU U≈ªYTKOWNIKA (PRAWY G√ìRNY R√ìG) --- */
        .user-profile-section {
            position: relative;
            display: inline-block;
            margin-left: 20px;
            border-left: 1px solid #ccc;
            padding-left: 20px;
        }

        .user-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-toggle-btn:hover { color: #007bff; }

        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            background-color: #fff;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 100;
            border-radius: 4px;
            border: 1px solid #eee;
            margin-top: 10px;
        }

        .user-dropdown button {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }

        .user-dropdown button:hover {
            background-color: #f1f1f1;
            color: #dc3545;
        }

        .show-dropdown { display: block; }

        .vehicle-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 20px; }
        .vehicle-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border-top: 4px solid #007bff; }
        .vehicle-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .vehicle-card h3 { margin: 0 0 10px 0; color: #333; }
        .vehicle-card p { margin: 5px 0; color: #666; font-size: 0.9em; }

        .timeline-container { max-width: 800px; margin: 0 auto; position: relative; padding: 20px 0; }
        .timeline-container::after { content: ''; position: absolute; width: 4px; background-color: #e9ecef; top: 0; bottom: 0; left: 50px; margin-left: -2px; }

        .timeline-item { padding: 10px 40px; position: relative; background-color: inherit; width: 100%; box-sizing: border-box; }
        .timeline-icon { position: absolute; left: 34px; width: 32px; height: 32px; right: auto; top: 15px; border-radius: 50%; z-index: 1; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 0 4px white; }
        .timeline-date { position: absolute; left: -120px; top: 20px; width: 120px; text-align: right; font-weight: bold; color: #555; font-size: 0.85em; white-space: nowrap; }

        .timeline-content { padding: 15px; background-color: white; position: relative; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-left: 60px; border-left: 4px solid #ccc; }
        .timeline-content h4 { margin: 0 0 5px 0; font-size: 1.1em; }
        .timeline-content p { margin: 0; font-size: 0.9em; color: #666; }

        /* --- STYLY DLA SORTOWANIA --- */
        .sort-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }
        .sort-header:hover {
            color: #007bff; /* Niebieski po najechaniu */
            background-color: rgba(0,0,0,0.05); /* Lekkie t≈Ço */
        }

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

        <div class="login-container" id="login-container">
            <div class="login-box" id="login-box">
                <div class="login-logo"><i class="fas fa-shipping-fast"></i></div>
                <h2>FLEETSYS</h2>
                <p>Zaloguj siƒô do systemu zarzƒÖdzania flotƒÖ</p>

                <p style="color: #e74c3c; min-height: 1.2em; font-weight: bold;" id="login-error"></p>

                <form id="login-form">
                    <input type="text" id="username" placeholder="Nazwa u≈ºytkownika" required>
                    <input type="password" id="password" placeholder="Has≈Ço" required>
                    <input type="password" id="pin_2fa" placeholder="PIN 2FA (tylko Admin)" style="display: none;">
                    <button type="submit">ZALOGUJ SIƒò</button>
                </form>

                <p style="margin-top: 20px; font-size: 0.85em;">
                    Nie masz konta? <a href="#" onclick="showRegister()">Za≈Ç√≥≈º konto</a>
                </p>
            </div>

            <div class="login-box" id="register-box" style="display: none;">
                <div class="login-logo"><i class="fas fa-user-plus"></i></div>
                <h2>Rejestracja</h2>
                <p>Utw√≥rz nowe konto u≈ºytkownika</p>

                <p style="color: #e74c3c; min-height: 1.2em; font-weight: bold;" id="register-error"></p>

                <input type="text" id="reg_first_name" placeholder="Imiƒô" required>
                <input type="text" id="reg_last_name" placeholder="Nazwisko" required>
                <input type="text" id="reg_company_name" placeholder="Nazwa Firmy" required>
                <input type="text" id="reg_username" placeholder="Login" required>
                <input type="email" id="reg_email" placeholder="E-mail" required>
                <input type="password" id="reg_password" placeholder="Has≈Ço" required>
                <input type="password" id="reg_password_confirm" placeholder="Powt√≥rz has≈Ço" required>


                <button onclick="handleRegister()">ZAREJESTRUJ SIƒò</button>

                <p style="margin-top: 20px; font-size: 0.85em;">
                    Masz ju≈º konto? <a href="#" onclick="showLogin()">Wr√≥ƒá do logowania</a>
                </p>
            </div>
        </div>
        <div class="main-app" id="main-app" style="display: none;">
            <div class="sidebar">
            <div class="sidebar-header">FLEETSYS</div>

            <div class="menu-item active" data-view="vehicles">
                <i class="fas fa-car-side"></i> <span>Pojazdy</span>
            </div>
            <div class="menu-item" data-view="drivers">
                <i class="fas fa-users"></i> <span>U≈ºytkownicy</span>
            </div>
            <div class="menu-item" data-view="handover">
                <i class="fas fa-key"></i> <span>Przekazania</span>
            </div>
            <div class="menu-item" data-view="damages">
                <i class="fas fa-car-burst"></i> <span>Szkody</span>
            </div>
            <div class="menu-item" data-view="calendar">
                <i class="fas fa-calendar-days"></i> <span>Terminarz</span>
            </div>

            <div class="menu-subitem" data-view="policies"><span class="color-dot dot-policy"></span>Polisy</div>
            <div class="menu-subitem" data-view="tech_inspections"><span class="color-dot dot-inspection"></span>Badania tech.</div>
            <div class="menu-subitem" data-view="reviews"><span class="color-dot dot-review"></span>PrzeglƒÖdy</div>
            <div class="menu-subitem" data-view="repairs"><span class="color-dot dot-repair"></span>Naprawy</div>

         
            <div class="menu-item" data-view="hr_docs">
                <i class="fas fa-folder-open"></i> <span>Dokumenty</span>
            </div>
            <div class="menu-item" data-view="settlements">
                <i class="fas fa-receipt"></i> <span>Rozliczenia</span>
            </div>
            <div class="menu-item" data-view="reservations">
                <i class="fas fa-calendar-check"></i> <span>Rezerwacje</span>
            </div>
            <div class="menu-item" data-view="vehicle_history">
                <i class="fas fa-history"></i> <span>Historia Pojazdu</span>
            </div>

            <div class="menu-item" data-view="settings">
                <i class="fas fa-sliders-h"></i> <span>Ustawienia</span>
            </div>

            <div style="margin-top: auto;">

                <div style="padding: 20px 15px; font-size: 0.75em; color: #7f8c8d; background-color: #233140; text-align: center; line-height: 1.5em; border-top: 1px solid #1a252f;">

                    <div style="margin-bottom: 10px;">
                        <strong style="color: #ecf0f1;">FleetSys Sp. z o.o.</strong><br>
                        Wersja systemu: 1.0.2
                    </div>

                    <div style="border-top: 1px solid #34495e; padding-top: 10px; margin-top: 10px;">
                        <i class="fas fa-headset" style="color: #16a085; margin-bottom: 5px;"></i><br>
                        Masz problem z aplikacjƒÖ?
                        <br>
                        <a href="mailto:support@fleetsys.pl" style="color: #16a085; text-decoration: none; font-weight: bold; display: block; margin-top: 3px;">
                            support@fleetsys.pl
                        </a>
                        <span style="display:block; margin-top:2px;">tel. +48 123 456 789</span>
                    </div>

                </div>
            </div>

        </div>

            <div class="content-area">
                <div class="header">
                    <h1 id="view-title">Pojazdy</h1>

                    <div style="display: flex; align-items: center;">

                        <button class="btn-notif" onclick="renderNotifications()" title="Powiadomienia">
                            <i class="fas fa-bell"></i>
                            <span id="notif-badge-count" class="notif-badge">0</span>
                        </button>
                        <div style="display: flex; gap: 10px; margin-right: 10px;">
                            <input type="text" id="table-search" placeholder="Szukaj..."
                                style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px;">

                            <button class="btn-add" id="add-btn">‚ûï DODAJ</button>
                        </div>

                        <div class="user-profile-section">
                            <button onclick="toggleUserMenu()" class="user-toggle-btn" id="user-menu-btn">
                                üë§ <span id="header-username">≈Åadowanie...</span> ‚ñº
                            </button>
                            <div id="user-dropdown-content" class="user-dropdown">
                                <div style="padding: 10px; font-size: 0.85em; color: #666; border-bottom: 1px solid #eee;">
                                    Rola: <span id="header-role">---</span>
                                </div>
                                <button onclick="handleLogout()">üö™ Wyloguj siƒô</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="main-content"></div>
            </div>
        </div>

        <div id="data-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h2 id="modal-title">Dodaj nowy rekord</h2>
                <p style="color: red; height: 1.5em;" id="modal-error"></p>
                <form id="modal-form"></form>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn-save" id="save-btn">ZAPISZ</button>
                    <button id="delete-btn" style="display: none; background-color: #dc3545; color: white; border: none; padding: 10px; border-radius: 4px;">USU≈É</button>
                </div>
            </div>
        </div>



    <script>
        const mainContent = document.getElementById('main-content');
        const viewTitle = document.getElementById('view-title');
        const menuItems = document.querySelectorAll('.menu-item, .menu-subitem');
        const API_BASE = 'http://127.0.0.1:8000/api/';

        // Elementy Logowania
        const loginContainer = document.getElementById('login-container');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const pin2faInput = document.getElementById('pin_2fa');
        const loginError = document.getElementById('login-error');
        // USUNIƒòTO: const userRoleDisplay (poniewa≈º ten element usunƒôli≈õmy z HTML sidebar)

        // Elementy Modalu
        const modal = document.getElementById('data-modal');
        const closeModalBtn = document.querySelector('.close-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalForm = document.getElementById('modal-form');
        const modalError = document.getElementById('modal-error');
        const saveBtn = document.getElementById('save-btn');
        saveBtn.onclick = handleSave;
        const deleteBtn = document.getElementById('delete-btn');
        const addBtn = document.getElementById('add-btn');

        let currentView = 'vehicles';
        let currentRecordId = null;

        // --- LOGIKA SORTOWANIA ---
        let sortState = {
            column: null,
            asc: true
        };

        // Resetowanie sortowania przy zmianie zak≈Çadki
        const originalLoadView = loadView;
        loadView = function(viewName) {
            // Resetujemy sortowanie tylko je≈õli zmieniamy na inny widok
            if (currentView !== viewName) {
                sortState = { column: null, asc: true };
            }
            originalLoadView(viewName);
        };

        // Funkcja obs≈ÇugujƒÖca klikniƒôcie w nag≈Ç√≥wek
        function handleSort(column) {
            if (sortState.column === column) {
                sortState.asc = !sortState.asc; // Odwr√≥ƒá kolejno≈õƒá
            } else {
                sortState.column = column;
                sortState.asc = true; // Domy≈õlnie rosnƒÖco
            }
            // Prze≈Çaduj aktualny widok, aby zastosowaƒá sortowanie
            if (currentView === 'vehicles') renderVehicles();
            else if (currentView === 'drivers') renderDrivers();
            else if (currentView === 'handover') renderHandovers();
            else if (currentView === 'damages') renderDamageEvents();
            else if (currentView === 'reservations') renderReservations();
            else if (currentView === 'settlements') renderSettlements();
            else if (currentView === 'vehicle_documents') renderVehicleDocsList();

            // Dla widok√≥w serwisowych (przeglƒÖdy, naprawy itp.)
            else if (['reviews', 'repairs', 'tech_inspections', 'inspection'].includes(currentView)) {
                renderServiceEvents(currentView);
            }
        }

        // Funkcja sortujƒÖca tablicƒô danych
        function applySort(data) {
            if (!sortState.column) return data;

            return data.sort((a, b) => {
                let valA = a[sortState.column];
                let valB = b[sortState.column];

                // Obs≈Çuga null/undefined
                if (valA == null) valA = "";
                if (valB == null) valB = "";

                // Je≈õli liczby
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return sortState.asc ? valA - valB : valB - valA;
                }

                // Je≈õli tekst
                valA = valA.toString().toLowerCase();
                valB = valB.toString().toLowerCase();

                if (valA < valB) return sortState.asc ? -1 : 1;
                if (valA > valB) return sortState.asc ? 1 : -1;
                return 0;
            });
        }

        // Helper generujƒÖcy HTML nag≈Ç√≥wka z strza≈ÇkƒÖ
        function getSortHeader(label, columnKey) {
            let icon = '';
            if (sortState.column === columnKey) {
                icon = sortState.asc ? '‚ñ≤' : '‚ñº';
            } else {
                icon = '<span style="opacity:0.3; font-size:0.8em;">‚áÖ</span>';
            }
            // Zwracamy HTML z obs≈ÇugƒÖ onclick
            return `<div class="sort-header" onclick="handleSort('${columnKey}')">${label} ${icon}</div>`;
        }

        // --- FUNKCJE POMOCNICZE ---

        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_role');
            localStorage.removeItem('username');

            loginContainer.style.display = 'flex';
            mainApp.style.display = 'none';
        }

        // USUNIƒòTO: logoutBtn.addEventListener (bo przycisku ju≈º nie ma w zmiennych, jest w onclick w HTML)

        // Funkcja aktualizujƒÖca tekst w prawym g√≥rnym rogu
        function updateHeaderUser() {
            const username = localStorage.getItem('username') || 'Go≈õƒá';
            const role = localStorage.getItem('user_role') || '---';

            const headerName = document.getElementById('header-username');
            const headerRole = document.getElementById('header-role');

            if(headerName) headerName.textContent = username;
            if(headerRole) headerRole.textContent = role;
        }

        // Funkcja otwierajƒÖca/zamykajƒÖca menu
        function toggleUserMenu() {
            document.getElementById("user-dropdown-content").classList.toggle("show-dropdown");
        }

        // Zamknij menu, je≈õli u≈ºytkownik kliknie gdziekolwiek indziej
        window.onclick = function(event) {
            if (!event.target.matches('.user-toggle-btn') && !event.target.matches('.user-toggle-btn *')) {
                var dropdowns = document.getElementsByClassName("user-dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show-dropdown')) {
                        openDropdown.classList.remove('show-dropdown');
                    }
                }
            }
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = '';
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const pin_2fa = pin2faInput.value;
            try {
                const response = await fetch(API_BASE + 'login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ username, password, pin_2fa }),
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user_role', data.user_role);

                    // Zapisujemy nazwƒô u≈ºytkownika
                    localStorage.setItem('username', data.username);

                    loginContainer.style.display = 'none';
                    mainApp.style.display = 'flex';

                    // Od≈õwie≈ºamy prawy g√≥rny r√≥g
                    if (typeof updateHeaderUser === 'function') {
                        updateHeaderUser();
                    }

                    loginForm.reset();
                    pin2faInput.style.display = 'none';
                    loadView('vehicles');
                } else {
                    loginError.textContent = data.detail || 'WystƒÖpi≈Ç nieznany b≈ÇƒÖd logowania.';
                    if (username.toUpperCase().includes('ADMIN') || (data.detail && data.detail.includes('PIN 2FA'))) {
                         pin2faInput.style.display = 'block';
                         pin2faInput.focus();
                    } else {
                         pin2faInput.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error(error);
                loginError.textContent = 'B≈ÇƒÖd sieci. Sprawd≈∫, czy serwer Django dzia≈Ça na porcie 8000.';
            }
        }
        loginForm.addEventListener('submit', handleLogin);

        function showRegister() {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('register-box').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('login-box').style.display = 'block';
            document.getElementById('register-box').style.display = 'none';
        }

        async function renderSettings() {
            currentView = 'settings';
            viewTitle.textContent = 'Konfiguracja Systemu';
            document.getElementById('add-btn').style.display = 'none';

            const contentDiv = document.getElementById('main-content');
            contentDiv.innerHTML = '≈Åadowanie ustawie≈Ñ...';

            try {
                // Pobieramy ustawienia (GET)
                const response = await fetch(API_BASE + 'settings/', { headers: getAuthHeaders() });
                const settings = await response.json();

                contentDiv.innerHTML = `
                    <div style="max-width: 600px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">

                        <h3 style="color:#2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;">üè¢ Dane Firmy (do wydruk√≥w)</h3>
                        <label style="display:block; margin-top:10px;">Nazwa Firmy:</label>
                        <input type="text" id="set_company_name" value="${settings.company_name}" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">

                        <label style="display:block; margin-top:10px;">Adres:</label>
                        <input type="text" id="set_company_address" value="${settings.company_address}" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">

                        <label style="display:block; margin-top:10px;">NIP:</label>
                        <input type="text" id="set_company_nip" value="${settings.company_nip}" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">

                        <h3 style="color:#27ae60; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px;">üí∞ Domy≈õlne Finanse</h3>
                        <div style="display:flex; gap:20px;">
                            <div style="flex:1;">
                                <label style="display:block; margin-top:10px;">Stawka za km (PLN):</label>
                                <input type="number" step="0.01" id="set_rate_km" value="${settings.default_rate_km}" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                            <div style="flex:1;">
                                <label style="display:block; margin-top:10px;">Op≈Çata za paliwo (PLN):</label>
                                <input type="number" step="0.01" id="set_fuel_penalty" value="${settings.default_fuel_penalty}" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                        </div>

                        <h3 style="color:#c0392b; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px;">üîî Alerty i Powiadomienia</h3>
                        <label style="display:block; margin-top:10px;">Przypomnienie przed terminem (dni):</label>
                        <input type="number" id="set_alert_days" value="${settings.alert_days}" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">

                        <button onclick="saveSettings()" style="margin-top: 30px; width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            üíæ ZAPISZ USTAWIENIA
                        </button>
                        <div id="settings-msg" style="margin-top:10px; text-align:center; height:20px;"></div>
                    </div>
                `;

            } catch (e) {
                contentDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${e.message}</div>`;
            }
        }

        async function saveSettings() {
            const data = {
                company_name: document.getElementById('set_company_name').value,
                company_address: document.getElementById('set_company_address').value,
                company_nip: document.getElementById('set_company_nip').value,
                default_rate_km: document.getElementById('set_rate_km').value,
                default_fuel_penalty: document.getElementById('set_fuel_penalty').value,
                alert_days: document.getElementById('set_alert_days').value
            };

            const msgDiv = document.getElementById('settings-msg');
            msgDiv.textContent = "Zapisywanie...";
            msgDiv.style.color = "blue";

            try {
                const response = await fetch(API_BASE + 'settings/', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    msgDiv.textContent = "‚úÖ Ustawienia zosta≈Çy zaktualizowane!";
                    msgDiv.style.color = "green";
                } else {
                    msgDiv.textContent = "‚ùå B≈ÇƒÖd zapisu.";
                    msgDiv.style.color = "red";
                }
            } catch (e) {
                msgDiv.textContent = "‚ùå B≈ÇƒÖd sieci.";
            }
        }

        async function handleRegister() {
            const username = document.getElementById('reg_username').value;
            const email = document.getElementById('reg_email').value;
            const password = document.getElementById('reg_password').value;

            // 1. Pobieramy powt√≥rzone has≈Ço
            const passwordConfirm = document.getElementById('reg_password_confirm').value;

            const first_name = document.getElementById('reg_first_name').value;
            const last_name = document.getElementById('reg_last_name').value;

            // --- BRAKOWA≈ÅO TEJ LINIJKI ---
            const company_name = document.getElementById('reg_company_name').value;
            // -----------------------------

            const errorElem = document.getElementById('register-error');

            errorElem.textContent = "";

            // 2. SPRAWDZAMY ZGODNO≈öƒÜ HASE≈Å
            if (password !== passwordConfirm) {
                errorElem.textContent = "Has≈Ça muszƒÖ byƒá identyczne!";
                return;
            }

            try {
                const response = await fetch('http://127.0.0.1:8000/api/register/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Teraz zmienna company_name jest ju≈º zdefiniowana i zadzia≈Ça:
                    body: JSON.stringify({ username, email, password, first_name, last_name, company_name })
                });

                const data = await response.json();

                if (response.ok) {
                    alert("Konto utworzone pomy≈õlnie! Teraz mo≈ºesz siƒô zalogowaƒá.");
                    showLogin();
                } else {
                    errorElem.textContent = data.detail || "B≈ÇƒÖd rejestracji";
                }
            } catch (error) {
                console.error(error); // Dodano logowanie b≈Çƒôdu do konsoli, ≈ºeby ≈Çatwiej diagnozowaƒá
                errorElem.textContent = "B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.";
            }
        }

        // --- FUNKCJE DLA MODALU ---

        closeModalBtn.onclick = () => { modal.style.display = "none"; };

        const endpointMap = {
            'vehicles': 'vehicles',
            'drivers': 'drivers',
            'damages': 'damage_events',
            'handover': 'handovers',
            'hr_history': 'handovers',
            'inspection': 'service_events',
            'repairs': 'service_events',
            'reviews': 'service_events',
            'tech_inspections': 'service_events',
            'legalization': 'service_events',
            'policies': 'policies',
            'reservations': 'reservations',
            'vehicle_documents': 'vehicles',
            'calendar': null
        };

        addBtn.addEventListener('click', () => openModal(currentView));

        async function fetchVehicles() {
            try {
                const response = await fetch(API_BASE + 'vehicles/', { headers: getAuthHeaders() });
                if (response.status === 401) { handleLogout(); return []; }
                if (!response.ok) throw new Error(response.statusText);
                return await response.json();
            } catch (error) {
                console.error("B≈ÇƒÖd pobierania listy pojazd√≥w:", error);
                return [];
            }
        }

        function updateFormFields(eventType) {
            const container = document.getElementById('dynamic-fields-container');
            let fieldsHtml = '';

            if (eventType === 'POLICY_OC') {
                 fieldsHtml = `
                    <label for="numer_polisy_val">Numer Polisy:</label>
                    <input type="text" id="numer_polisy_val" required>

                    <label for="ubezpieczyciel_val">Ubezpieczyciel:</label>
                    <input type="text" id="ubezpieczyciel_val" placeholder="np. PZU, Warta" required>

                    <label for="koszt_polisy_val">Koszt Polisy (PLN):</label>
                    <input type="number" id="koszt_polisy_val" step="0.01" placeholder="0.00" required>

                    <label for="data_waznosci_ac_val">Data Wa≈ºno≈õci AC (opcjonalnie):</label>
                    <input type="date" id="data_waznosci_ac_val">
                 `;
            } else {
                 fieldsHtml = `
                    <label for="opis_zdarzenia_val">Opis Zdarzenia:</label>
                    <textarea id="opis_zdarzenia_val" required></textarea>

                    <label for="koszt_val">Koszt (PLN, opcjonalnie):</label>
                    <input type="number" id="koszt_val" step="0.01" value="0">
                 `;
            }
            container.innerHTML = fieldsHtml;
        }
        window.updateFormFields = updateFormFields;

        async function updateVehicleAvailability() {
            // 1. Pobieramy daty z formularza
            const start = document.getElementById('r_date_from').value;
            const end = document.getElementById('r_date_to').value;
            const vehicleSelect = document.getElementById('r_assigned_vehicle');

            // Pobieramy ID aktualnie wybranego pojazdu (≈ºeby go przywr√≥ciƒá po od≈õwie≈ºeniu listy)
            const currentSelectedValue = vehicleSelect.value;

            // Je≈õli brakuje dat, nie robimy nic lub resetujemy
            if (!start || !end) return;

            // Wy≈õwietl informacjƒô "Sprawdzam..." w selectcie
            vehicleSelect.innerHTML = '<option>üîÑ Sprawdzam dostƒôpno≈õƒá...</option>';

            try {
                // Dodajemy ID edytowanej rezerwacji (currentRecordId), ≈ºeby nie blokowa≈Ça samej siebie
                let url = `${API_BASE}vehicles/availability/?start=${start}&end=${end}`;
                if (currentRecordId && currentView === 'reservations') {
                    url += `&exclude_id=${currentRecordId}`;
                }

                const response = await fetch(url, { headers: getAuthHeaders() });
                const vehicles = await response.json();

                // Budujemy nowƒÖ listƒô opcji
                let optionsHtml = '<option value="">-- Wybierz Pojazd --</option>';

                vehicles.forEach(v => {
                    let icon = '‚úÖ';
                    let textInfo = '';
                    let isDisabled = false;
                    let styleColor = 'black';

                    // 1. Sprawdzamy stan techniczny
                    if (v.status === 'NIESPRAWNY') {
                        icon = '‚ùå';
                        textInfo = '(NIESPRAWNY)';
                        isDisabled = true; // Blokujemy wyb√≥r
                        styleColor = '#dc3545'; // Czerwony
                    }
                    // 2. Sprawdzamy dostƒôpno≈õƒá w terminie
                    else if (!v.is_available) {
                        icon = '‚õî';
                        textInfo = `(ZAJƒòTY: ${v.busy_info})`; // Info z serwera kiedy zajƒôty
                        isDisabled = true; // Blokujemy wyb√≥r
                        styleColor = '#e67e22'; // Pomara≈Ñczowy
                    }

                    // Czy ten pojazd by≈Ç wcze≈õniej wybrany?
                    const isSelected = (String(v.id) === String(currentSelectedValue)) ? 'selected' : '';

                    optionsHtml += `
                        <option value="${v.id}" ${isSelected} ${isDisabled ? 'disabled' : ''} style="color:${styleColor}; font-weight:${isDisabled ? 'bold' : 'normal'};">
                            ${icon} ${v.registration_number} (${v.marka} ${v.model}) ${textInfo}
                        </option>
                    `;
                });

                vehicleSelect.innerHTML = optionsHtml;

            } catch (e) {
                console.error("B≈ÇƒÖd sprawdzania dostƒôpno≈õci:", e);
                vehicleSelect.innerHTML = '<option value="">‚ö†Ô∏è B≈ÇƒÖd sprawdzania dostƒôpno≈õci</option>';
            }
        }


        /** Otwiera modal i ≈Çaduje odpowiedni formularz */
       async function openModal(viewName, recordOrId = null) {
            let record = null;
            modalError.textContent = '';
            modalForm.innerHTML = '≈Åadowanie danych...';

            // Logika pobierania danych (bez zmian)
            if (recordOrId !== null) {
                if (typeof recordOrId === 'object') {
                    record = recordOrId;
                    currentRecordId = record.id;
                } else {
                    currentRecordId = recordOrId;
                    try {
                        const endpoint = endpointMap[viewName] || viewName;
                        const response = await fetch(`${API_BASE}${endpoint}/${currentRecordId}/`, {
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            record = await response.json();
                        } else {
                            throw new Error("Nie uda≈Ço siƒô pobraƒá danych rekordu.");
                        }
                    } catch (error) {
                        modalError.textContent = "B≈ÇƒÖd ≈Çadowania: " + error.message;
                        return;
                    }
                }
            } else {
                currentRecordId = null;
            }

            modalTitle.textContent = currentRecordId ? `Edytuj rekord (${viewName})` : `Dodaj nowy rekord (${viewName})`;
            deleteBtn.style.display = currentRecordId ? 'inline' : 'none';

            let formHtml = '';
            const isCalendarEventView = ['calendar', 'policies', 'tech_inspections', 'reviews', 'repairs', 'legalization', 'inspection'].includes(viewName);

            // 1. DODAWANIE NOWEGO TERMINU (DLA WIDOK√ìW KALENDARZOWYCH)
            if (isCalendarEventView && !currentRecordId) {
                modalTitle.textContent = `Dodaj Nowy Termin/Zdarzenie`;
                const vehicles = await fetchVehicles();
                const vehicleOptions = vehicles.map(v => `<option value="${v.id}">${v.registration_number} (ID: ${v.id})</option>`).join('');

                formHtml = `
                    <label for="event_type_selector">Rodzaj Zdarzenia:</label>
                    <select id="event_type_selector" required onchange="updateFormFields(this.value)">
                        <option value="" disabled selected>-- Wybierz rodzaj --</option>
                        <option value="BADANIE_TECH">Badanie Techniczne</option>
                        <option value="PRZEGLAD">PrzeglƒÖd Okresowy</option>
                        <option value="NAPRAWA">Naprawa</option>
                        <option value="POLICY_OC">Polisa OC/AC</option>
                    </select>
                    <label for="pojazd_id_selector">Pojazd:</label>
                    <select id="pojazd_id_selector" required>${vehicleOptions}</select>
                    <div id="dynamic-fields-container"></div>
                    <label for="data_terminu">Data Terminu:</label>
                    <input type="date" id="data_terminu" required>
                `;
            }
            // 2. POJAZDY
            else if (viewName === 'vehicles') {
                const sel = (f, v) => (record && record[f] === v) ? 'selected' : '';

                // Funkcja pomocnicza generujƒÖca pole pliku z opcjƒÖ usuwania
                const fileInputRow = (label, fileId, removeId, dbField) => {
                    let html = `<label style="margin-top:10px;">${label}:</label><input type="file" id="${fileId}">`;

                    // Je≈õli rekord istnieje i ma wgrany plik w danym polu
                    if (record && record[dbField]) {
                        html += `
                            <div style="background: #fff3cd; padding: 5px; border: 1px solid #ffeeba; border-radius: 4px; display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <span style="color: green; font-weight: bold; font-size: 0.9em;">‚úÖ Plik jest wgrany</span>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="${removeId}" style="width: auto; margin: 0;">
                                    <label for="${removeId}" style="color: #dc3545; font-weight: bold; font-size: 0.85em; margin: 0; cursor: pointer;">Usu≈Ñ plik</label>
                                </div>
                            </div>
                        `;
                    }
                    return html;
                };

                formHtml = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><label>Marka:</label><input type="text" id="v_marka" value="${record?.marka || ''}"></div>
                        <div><label>Model:</label><input type="text" id="v_model" value="${record?.model || ''}"></div>
                    </div>

                    <label>Nr Rej:</label><input type="text" id="reg_num" value="${record?.registration_number || ''}" required>
                    <label>VIN:</label><input type="text" id="vin_num" value="${record?.vin || ''}" required>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>Typ:</label>
                            <select id="v_type">
                                <option value="OSOBOWE" ${sel('typ_pojazdu', 'OSOBOWE')}>Osobowe</option>
                                <option value="CIEZAROWE" ${sel('typ_pojazdu', 'CIEZAROWE')}>Ciƒô≈ºarowe</option>
                                <option value="AUTOBUSY" ${sel('typ_pojazdu', 'AUTOBUSY')}>Autobusy</option>
                            </select>
                        </div>
                        <div>
                            <label>Paliwo:</label>
                            <select id="fuel_type_input">
                                <option value="DIESEL" ${sel('fuel_type', 'DIESEL')}>Diesel</option>
                                <option value="BENZYNA" ${sel('fuel_type', 'BENZYNA')}>Benzyna</option>
                                <option value="LPG" ${sel('fuel_type', 'LPG')}>LPG + Benzyna</option>
                                <option value="HYBRID" ${sel('fuel_type', 'HYBRID')}>Hybryda (HEV)</option>
                                <option value="PHEV" ${sel('fuel_type', 'PHEV')}>Hybryda Plug-in (PHEV)</option>
                                <option value="ELECTRIC" ${sel('fuel_type', 'ELECTRIC')}>Elektryczny (EV)</option>
                                <option value="CNG" ${sel('fuel_type', 'CNG')}>CNG</option>
                                <option value="HYDROGEN" ${sel('fuel_type', 'HYDROGEN')}>Wodorowy</option>
                            </select>
                        </div>
                    </div>

                    <label>Przebieg:</label><input type="number" id="przebieg_val" value="${record?.przebieg || ''}">
                    <label>Status:</label>
                    <select id="v_status">
                        <option value="SPRAWNY" ${sel('status', 'SPRAWNY')}>Sprawny</option>
                        <option value="NIESPRAWNY" ${sel('status', 'NIESPRAWNY')}>Niesprawny</option>
                    </select>

                    <input type="hidden" id="company_id" value="${record?.company || ''}">
                    <input type="hidden" id="v_assigned_user" value="${record?.assigned_user || ''}">

                    <label>Uwagi:</label><textarea id="v_uwagi">${record?.uwagi || ''}</textarea>

                    <h3 style="margin-top:20px; border-bottom:2px solid #007bff; padding-bottom:5px; color:#007bff;">Dokumenty (Dodaj / Usu≈Ñ)</h3>

                    ${fileInputRow('Skan Dowodu Rej.', 'v_scan_registration', 'rm_scan_registration', 'scan_registration_card')}
                    ${fileInputRow('Polisa OC', 'v_scan_oc', 'rm_scan_oc', 'scan_policy_oc')}
                    ${fileInputRow('Polisa AC', 'v_scan_ac', 'rm_scan_ac', 'scan_policy_ac')}
                    ${fileInputRow('Badanie Techniczne', 'v_scan_tech', 'rm_scan_tech', 'scan_tech_inspection')}
                    ${fileInputRow('KsiƒÖ≈ºka Serwisowa', 'v_scan_service', 'rm_scan_service', 'scan_service_book')}
                    ${fileInputRow('Faktura Zakupu', 'v_scan_invoice', 'rm_scan_invoice', 'scan_purchase_invoice')}
                `;
            }
            // 3. KIEROWCY
            else if (viewName === 'drivers') {
                formHtml = `
                    <label>User ID:</label><input type="number" id="d_user_id" value="${record?.user || ''}" ${currentRecordId ? 'disabled' : ''}>
                    <label>Firma ID:</label><input type="number" id="d_company_id" value="${record?.company || ''}">
                    <label>Nr Prawa Jazdy:</label><input type="text" id="prawa_jazdy_num" value="${record?.numer_prawa_jazdy || ''}">
                    <label>Kategorie:</label><input type="text" id="kat_prawa_jazdy" value="${record?.kategorie_prawa_jazdy || 'B'}">
                    <label>Wa≈ºno≈õƒá PJ:</label><input type="date" id="data_waznosci_pj_val" value="${record?.data_waznosci_prawa_jazdy || ''}" required>
                    <label>Badania lek:</label><input type="date" id="data_badan_val" value="${record?.data_waznosci_badan || ''}">
                `;
            }
            // 4. PRZEKAZANIA (ZAKTUALIZOWANE O PLIKI)
            else if (viewName === 'handover') {

                const fileInputRow = (label, fileId, removeId, dbField) => {
                    let html = `<div style="margin-top:10px;"><label style="font-weight:bold; font-size:0.9em;">${label}:</label><br><input type="file" id="${fileId}"></div>`;
                    if (record && record[dbField]) {
                        html += `
                            <div style="background: #e2e3e5; padding: 5px; border-radius: 4px; display: flex; align-items: center; gap: 10px; margin-top: 2px;">
                                <a href="${record[dbField]}" target="_blank" style="color: blue; text-decoration: none; font-size:0.85em;">üìÑ Zobacz obecny</a>
                                <div style="display: flex; align-items: center; gap: 5px; margin-left:auto;">
                                    <input type="checkbox" id="${removeId}" style="width: auto; margin: 0;">
                                    <label for="${removeId}" style="color: #dc3545; font-size: 0.85em; margin: 0; cursor: pointer;">Usu≈Ñ</label>
                                </div>
                            </div>`;
                    }
                    return html;
                };

                const fuelOptions = (selected) => {
                    const opts = {'0':'Rezerwa', '25':'1/4', '50':'1/2', '75':'3/4', '100':'Pe≈Çny'};
                    return Object.entries(opts).map(([k, v]) =>
                        `<option value="${k}" ${String(selected) === k ? 'selected' : ''}>${v}</option>`
                    ).join('');
                };

                // Obliczanie "na ≈ºywo" w formularzu (JavaScript)
                window.calculateRentCost = () => {
                    const start = parseInt(document.getElementById('h_przebieg_start').value) || 0;
                    const stop = parseInt(document.getElementById('h_przebieg_stop').value) || 0;
                    const stawka = parseFloat(document.getElementById('h_stawka').value) || 0;
                    const doplata = parseFloat(document.getElementById('h_doplata').value) || 0;

                    if (stop > start) {
                        const dist = stop - start;
                        const total = (dist * stawka) + doplata;
                        document.getElementById('calc_dystans').innerText = dist + ' km';
                        document.getElementById('calc_total').innerText = total.toFixed(2) + ' PLN';
                    }
                };

                formHtml = `
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;"><label>Pojazd:</label><input type="number" id="h_pojazd_id" value="${record?.pojazd || ''}" required></div>
                        <div style="flex:1;"><label>Kierowca:</label><input type="number" id="h_kierowca_id" value="${record?.kierowca || ''}" required></div>
                    </div>

                    <div style="background:#e9ecef; padding:10px; border-radius:5px; margin-top:10px;">
                        <strong style="color:#007bff;">1. WYDANIE POJAZDU</strong>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <div style="flex:1;"><label>Data Wydania:</label><input type="date" id="h_data_wydania" value="${record?.data_wydania || ''}" required></div>
                            <div style="flex:1;"><label>Przebieg Start (km):</label><input type="number" id="h_przebieg_start" value="${record?.przebieg_start || 0}" oninput="calculateRentCost()"></div>
                            <div style="flex:1;"><label>Paliwo Start:</label><select id="h_paliwo_start">${fuelOptions(record?.paliwo_start || '100')}</select></div>
                        </div>
                    </div>

                    <div style="background:#d4edda; padding:10px; border-radius:5px; margin-top:10px; border:1px solid #c3e6cb;">
                        <strong style="color:#155724;">2. ZWROT I ROZLICZENIE</strong>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <div style="flex:1;"><label>Data Zwrotu:</label><input type="date" id="h_data_zwrotu" value="${record?.data_zwrotu || ''}"></div>
                            <div style="flex:1;"><label>Przebieg Koniec (km):</label><input type="number" id="h_przebieg_stop" value="${record?.przebieg_stop || ''}" oninput="calculateRentCost()"></div>
                            <div style="flex:1;"><label>Paliwo Koniec:</label><select id="h_paliwo_stop">${fuelOptions(record?.paliwo_stop || '')}</select></div>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
                            <div style="flex:1;"><label>Stawka za km (PLN):</label><input type="number" step="0.01" id="h_stawka" value="${record?.stawka_za_km || '0.50'}" oninput="calculateRentCost()"></div>
                            <div style="flex:1;"><label>Dop≈Çata Paliwo (PLN):</label><input type="number" step="0.01" id="h_doplata" value="${record?.koszt_brakujacego_paliwa || '0'}" oninput="calculateRentCost()"></div>
                        </div>

                        <div style="margin-top:10px; font-weight:bold; text-align:right; font-size:1.1em;">
                            Dystans: <span id="calc_dystans" style="color:#007bff;">0 km</span> |
                            SUMA: <span id="calc_total" style="color:#28a745;">0.00 PLN</span>
                        </div>
                    </div>

                    <label style="margin-top:10px;">Uwagi:</label><textarea id="h_uwagi" rows="2">${record?.uwagi || ''}</textarea>

                    `;

                // Wywo≈Çaj kalkulacjƒô po za≈Çadowaniu (je≈õli edytujemy)
                setTimeout(window.calculateRentCost, 500);
            }

            // 5. SZKODY
            else if (viewName === 'damages') {
                const sel = (val) => (record?.status_naprawy === val ? 'selected' : '');
                formHtml = `
                    <label>ID Pojazdu:</label><input type="number" id="pojazd_id" value="${record?.pojazd || ''}" required>
                    <label>Data:</label><input type="date" id="data_zdarzenia_val" value="${record?.data_zdarzenia || ''}" required>
                    <label>Status:</label>
                    <select id="status_naprawy_val">
                        <option value="ZGLOSZONA" ${sel('ZGLOSZONA')}>Zg≈Çoszona</option>
                        <option value="W_NAPRAWIE" ${sel('W_NAPRAWIE')}>W naprawie</option>
                        <option value="ZAMKNIETA" ${sel('ZAMKNIETA')}>Zamkniƒôta</option>
                    </select>
                    <label>Opis:</label><textarea id="opis_szkody">${record?.opis || ''}</textarea>
                `;
            }
            // ... (wcze≈õniejszy kod openModal) ...

            // 6. REZERWACJE (POPRAWIONE)
            else if (viewName === 'reservations') {
                // 1. POBIERANIE LISTY POJAZD√ìW
                let vehicleOptions = '<option value="">-- Brak / Dowolny --</option>';
                try {
                    const vehicles = await fetchVehicles();
                    vehicleOptions += vehicles.map(v => {
                        const isSelected = (record && record.assigned_vehicle === v.id) ? 'selected' : '';
                        let statusIcon = '‚ùì';
                        if (v.status === 'SPRAWNY') statusIcon = '‚úÖ';
                        else if (v.status === 'NIESPRAWNY') statusIcon = '‚ùå';

                        return `<option value="${v.id}" ${isSelected}>
                            ${v.registration_number} (${v.marka} ${v.model}) ‚Äî ${statusIcon} ${v.status}
                        </option>`;
                    }).join('');
                } catch (e) { console.error(e); }

                // 2. POBIERANIE LISTY KIEROWC√ìW
                let driverOptions = '<option value="">-- Wybierz Kierowcƒô z Systemu --</option>';
                try {
                    const response = await fetch(API_BASE + 'drivers/', { headers: getAuthHeaders() });
                    if (response.ok) {
                        const drivers = await response.json();
                        drivers.forEach(d => {
                            const name = (d.first_name || d.last_name) ? `${d.first_name} ${d.last_name}` : d.user_name;
                            const isSel = (record && record.driver === d.id) ? 'selected' : '';
                            driverOptions += `<option value="${d.id}" ${isSel}>${name}</option>`;
                        });
                    }
                } catch(e) { console.error(e); }

                const sel = (val) => (record?.vehicle_type === val ? 'selected' : '');
                const stSel = (val) => (record?.status === val ? 'selected' : '');

                let attachmentsHtml = '';
                if (record && record.attachments && record.attachments.length > 0) {
                    attachmentsHtml = '<div style="margin-top: 5px; background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 4px;"><strong>Za≈ÇƒÖczone pliki:</strong><ul style="list-style: none; padding-left: 0; margin-top: 5px;">';
                    record.attachments.forEach(file => {
                        const fileName = file.file.split('/').pop();
                        attachmentsHtml += `
                            <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #eee;">
                                <a href="${file.file}" target="_blank" style="color: blue; text-decoration: none;">üìÑ ${fileName}</a>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" class="remove-attachment-cb" value="${file.id}" id="remove_file_${file.id}">
                                    <label for="remove_file_${file.id}" style="color: #dc3545; font-size: 0.85em; cursor: pointer;">Usu≈Ñ</label>
                                </div>
                            </li>`;
                    });
                    attachmentsHtml += '</ul></div>';
                }

                formHtml = `
                    <div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <small style="color:#666; font-weight:bold;">DANE WNIOSKODAWCY (Tylko tekst):</small>
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1;"><label>Imiƒô:</label> <input type="text" id="r_first_name" value="${record?.first_name || ''}" required></div>
                            <div style="flex:1;"><label>Nazwisko:</label> <input type="text" id="r_last_name" value="${record?.last_name || ''}" required></div>
                        </div>
                        <label>Firma:</label> <input type="text" id="r_company" value="${record?.company || ''}" required>
                    </div>

                    <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #c3e6cb;">
                        <small style="color:#155724; font-weight:bold;">WERYFIKACJA ADMINISTRATORA:</small>

                        <label style="color: #155724;">Wybierz Kierowcƒô (Wymagane do Przekazania):</label>
                        <select id="r_driver_id" style="border: 1px solid #28a745; background: white;">${driverOptions}</select>

                        <label style="color: #007bff; margin-top:5px;">Przypisz pojazd:</label>
                        <select id="r_assigned_vehicle" style="border: 1px solid #007bff; background:#f0f8ff;"> ${vehicleOptions} </select>

                        <label style="margin-top:5px;">Status:</label>
                        <select id="r_status" style="font-weight:bold;">
                            <option value="OCZEKUJACE" ${stSel('OCZEKUJACE')}>OczekujƒÖce</option>
                            <option value="PRZYJETE" ${stSel('PRZYJETE')}>Przyjƒôte</option>
                            <option value="ZATWIERDZONE" ${stSel('ZATWIERDZONE')}>‚úÖ ZATWIERDZONE (Generuje wydanie)</option>
                            <option value="ODRZUCONE" ${stSel('ODRZUCONE')}>Odrzucone</option>
                        </select>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;">
                            <label>Data Od:</label>
                            <input type="date" id="r_date_from" value="${record?.date_from || ''}" required onchange="updateVehicleAvailability()">
                        </div>
                        <div style="flex:1;">
                            <label>Data Do:</label>
                            <input type="date" id="r_date_to" value="${record?.date_to || ''}" required onchange="updateVehicleAvailability()">
                        </div>
                    </div>

                    <label>Preferowany Typ:</label>
                    <select id="r_vehicle_type">
                        <option value="OSOBOWE" ${sel('OSOBOWE')}>Osobowe</option>
                        <option value="CIEZAROWE" ${sel('CIEZAROWE')}>Ciƒô≈ºarowe</option>
                        <option value="AUTOBUSY" ${sel('AUTOBUSY')}>Autobusy</option>
                        <option value="SUV" ${sel('SUV')}>SUV</option>
                        <option value="KOMBI" ${sel('KOMBI')}>Kombi</option>
                    </select>

                    <label style="margin-top: 10px;">Dodatkowe informacje:</label>
                    <textarea id="r_additional_info" rows="2">${record?.additional_info || ''}</textarea>

                    <label style="margin-top: 15px; font-weight:bold; color: #28a745;">Dodaj pliki:</label>
                    <input type="file" id="r_new_files" multiple accept="application/pdf,image/*">

                    ${attachmentsHtml}
                `;

                if (record && record.date_from && record.date_to) {
                    setTimeout(updateVehicleAvailability, 200);
                }
            }
            // 7. EDYCJA ISTNIEJƒÑCYCH ZDARZE≈É (POLISY, BADANIA, NAPRAWY)
            else if (isCalendarEventView && currentRecordId) {
                 const endpointForType = endpointMap[viewName];

                 if (endpointForType === 'service_events') {
                      formHtml = `
                        <input type="hidden" id="typ_zdarzenia_val" value="${record.typ_zdarzenia}">
                        <label>ID Pojazdu:</label>
                        <input type="number" id="pojazd_id" value="${record.pojazd}" required>
                        <label>Opis:</label>
                        <textarea id="opis_serwisu" required>${record.opis}</textarea>
                        <label>Koszt (PLN):</label>
                        <input type="number" id="koszt_val" step="0.01" value="${record.koszt}" required>
                        <label>Data Zdarzenia/Badania:</label>
                        <input type="date" id="data_serwisu_val" value="${record.data_serwisu}" required>
                    `;
                } else if (endpointForType === 'policies') {
                      formHtml = `
                            <label>ID Pojazdu:</label>
                            <input type="number" id="pojazd_id" value="${record.pojazd}" required>
                            <label>Numer Polisy:</label>
                            <input type="text" id="numer_polisy" value="${record.numer_polisy}" required>
                            <label>Ubezpieczyciel:</label> <input type="text" id="ubezpieczyciel_val" value="${record.ubezpieczyciel || ''}" required>

                            <label>Koszt (PLN):</label>
                            <input type="number" id="koszt_val" step="0.01" value="${record.koszt || 0}">

                            <label>Data Wa≈ºno≈õci OC:</label>
                            <input type="date" id="data_waznosci_oc" value="${record.data_waznosci_oc}" required>
                            <label>Data Wa≈ºno≈õci AC:</label>
                            <input type="date" id="data_waznosci_ac" value="${record.data_waznosci_ac || ''}">
                        `;
                 }
            }

            // 8. NOWE DOKUMENTY POJAZDU (UPLOAD)
            else if (viewName === 'vehicle_documents') {
                modalTitle.textContent = "Dodaj Dokument Pojazdu";

                const vehicles = await fetchVehicles();
                const vehicleOptions = vehicles.map(v => `<option value="${v.id}">${v.registration_number}</option>`).join('');

                formHtml = `
                    <label>Pojazd:</label>
                    <select id="doc_vehicle_id" required>
                        ${vehicleOptions}
                    </select>

                    <label>Tytu≈Ç Dokumentu:</label>
                    <input type="text" id="doc_title" placeholder="np. Dow√≥d Rejestracyjny, Ubezpieczenie 2026" required>

                    <label>Plik (PDF/JPG):</label>
                    <input type="file" id="doc_file" required>

                    <label>Opis (opcjonalnie):</label>
                    <textarea id="doc_desc" rows="2"></textarea>
                `;
            }

            modalForm.innerHTML = formHtml;
            modal.style.display = "block";
        }


        async function handleSave(event) {
            if (event && event.preventDefault) event.preventDefault();

            const modalError = document.getElementById('modal-error');
            if (modalError) modalError.textContent = '';

            const eventTypeSelector = document.getElementById('event_type_selector');
            let data = {};
            let endpoint = endpointMap[currentView] || currentView;
            let method = currentRecordId ? 'PUT' : 'POST';
            let url = currentRecordId ? `${API_BASE}${endpoint}/${currentRecordId}/` : `${API_BASE}${endpoint}/`;

            console.log(`Pr√≥ba zapisu: ${method} na ${url} (Widok: ${currentView})`);

            try {
                // 1. DODAWANIE NOWEGO TERMINU (KALENDARZ)
                if (eventTypeSelector && !currentRecordId) {
                    const selectedType = eventTypeSelector.value;
                    const pojazdId = document.getElementById('pojazd_id_selector').value;
                    const dataTerminu = document.getElementById('data_terminu').value;

                    if (selectedType === 'POLICY_OC') {
                        data = {
                            pojazd: parseInt(pojazdId),
                            numer_polisy: document.getElementById('numer_polisy_val').value,
                            ubezpieczyciel: document.getElementById('ubezpieczyciel_val').value,
                            data_waznosci_oc: dataTerminu,
                            data_waznosci_ac: document.getElementById('data_waznosci_ac_val').value || null
                        };
                        endpoint = 'policies';
                    } else {
                        data = {
                            pojazd: parseInt(pojazdId),
                            opis: document.getElementById('opis_zdarzenia_val').value,
                            koszt: parseFloat(document.getElementById('koszt_val').value) || 0,
                            data_serwisu: dataTerminu,
                            typ_zdarzenia: selectedType
                        };
                        endpoint = 'service_events';
                    }
                    url = `${API_BASE}${endpoint}/`;
                    method = 'POST';
                }
                // 2. POJAZDY
                else if (currentView === 'vehicles' || currentView === 'vehicle_documents') {
                    const formData = new FormData();
                    // Pola tekstowe
                    formData.append('registration_number', document.getElementById('reg_num').value);
                    formData.append('vin', document.getElementById('vin_num').value);
                    formData.append('fuel_type', document.getElementById('fuel_type_input').value);
                    formData.append('przebieg', document.getElementById('przebieg_val').value || 0);
                    formData.append('is_active', 'true');
                    formData.append('marka', document.getElementById('v_marka').value);
                    formData.append('model', document.getElementById('v_model').value);
                    formData.append('status', document.getElementById('v_status').value);
                    formData.append('typ_pojazdu', document.getElementById('v_type').value);
                    formData.append('uwagi', document.getElementById('v_uwagi').value);

                    const compId = document.getElementById('company_id').value;
                    if(compId) formData.append('company', parseInt(compId));

                    const userId = document.getElementById('v_assigned_user').value;
                    if(userId) formData.append('assigned_user', parseInt(userId));

                    // --- FUNKCJA POMOCNICZA DO PLIK√ìW I USUWANIA ---
                    const appendFileOrRemove = (fileInputId, removeCheckboxId, backendFileField, backendRemoveFlag) => {
                        // 1. Czy u≈ºytkownik chce usunƒÖƒá plik?
                        const removeCb = document.getElementById(removeCheckboxId);
                        if (removeCb && removeCb.checked) {
                            formData.append(backendRemoveFlag, 'true');
                        }

                        // 2. Czy u≈ºytkownik doda≈Ç nowy plik? (To nadpisze usuniƒôcie, je≈õli zaznaczono oba, co jest ok)
                        const fileInput = document.getElementById(fileInputId);
                        if (fileInput && fileInput.files[0]) {
                            formData.append(backendFileField, fileInput.files[0]);
                        }
                    };

                    appendFileOrRemove('v_scan_registration', 'rm_scan_registration', 'scan_registration_card', 'remove_scan_registration_card');
                    appendFileOrRemove('v_scan_oc', 'rm_scan_oc', 'scan_policy_oc', 'remove_scan_policy_oc');
                    appendFileOrRemove('v_scan_ac', 'rm_scan_ac', 'scan_policy_ac', 'remove_scan_policy_ac');
                    appendFileOrRemove('v_scan_tech', 'rm_scan_tech', 'scan_tech_inspection', 'remove_scan_tech_inspection');
                    appendFileOrRemove('v_scan_service', 'rm_scan_service', 'scan_service_book', 'remove_scan_service_book');
                    appendFileOrRemove('v_scan_invoice', 'rm_scan_invoice', 'scan_purchase_invoice', 'remove_scan_purchase_invoice');

                    data = formData;
                }
                // 3. SZKODY
                else if (currentView === 'damages') {
                    data = {
                        pojazd: parseInt(document.getElementById('pojazd_id').value),
                        opis: document.getElementById('opis_szkody').value,
                        data_zdarzenia: document.getElementById('data_zdarzenia_val').value,
                        status_naprawy: document.getElementById('status_naprawy_val').value,
                        szacowany_koszt: 0
                    };
                }
                // 4. KIEROWCY
                else if (currentView === 'drivers') {
                    const userIdInput = document.getElementById('d_user_id');
                    const userId = userIdInput ? userIdInput.value : null;
                    if (!userId && !currentRecordId) { alert("ID u≈ºytkownika wymagane!"); return; }

                    data = {
                        ...(userId && { user: parseInt(userId) }),
                        numer_prawa_jazdy: document.getElementById('prawa_jazdy_num').value,
                        kategorie_prawa_jazdy: document.getElementById('kat_prawa_jazdy').value,
                        data_waznosci_prawa_jazdy: document.getElementById('data_waznosci_pj_val').value || null,
                        company: parseInt(document.getElementById('d_company_id').value) || null,
                        data_waznosci_badan: document.getElementById('data_badan_val').value || null
                    };
                }
                // 5. PRZEKAZANIA (ZMIANA NA FormData ABY WYSY≈ÅAƒÜ PLIKI)
                else if (currentView === 'handover' || currentView === 'hr_history') {
                    const formData = new FormData();
                    formData.append('pojazd', parseInt(document.getElementById('h_pojazd_id').value));
                    formData.append('kierowca', parseInt(document.getElementById('h_kierowca_id').value));
                    formData.append('data_wydania', document.getElementById('h_data_wydania').value);

                    formData.append('przebieg_start', document.getElementById('h_przebieg_start').value);
                    formData.append('przebieg_stop', document.getElementById('h_przebieg_stop').value || '');
                    formData.append('paliwo_start', document.getElementById('h_paliwo_start').value);
                    formData.append('paliwo_stop', document.getElementById('h_paliwo_stop').value || '');
                    formData.append('stawka_za_km', document.getElementById('h_stawka').value);
                    formData.append('koszt_brakujacego_paliwa', document.getElementById('h_doplata').value);

                    const zwrot = document.getElementById('h_data_zwrotu').value;
                    if (zwrot) formData.append('data_zwrotu', zwrot);
                    else formData.append('data_zwrotu', '');

                    formData.append('uwagi', document.getElementById('h_uwagi').value);

                    const appendFile = (fileId, removeId, fieldName, removeFlag) => {
                        const fileInput = document.getElementById(fileId);
                        if (fileInput && fileInput.files[0]) {
                            formData.append(fieldName, fileInput.files[0]);
                        }
                        const removeCb = document.getElementById(removeId);
                        if (removeCb && removeCb.checked) {
                            formData.append(removeFlag, 'true');
                        }
                    };

                    appendFile('h_scan_agreement', 'rm_h_agreement', 'scan_agreement', 'remove_scan_agreement');
                    appendFile('h_scan_handover', 'rm_h_handover', 'scan_handover_protocol', 'remove_scan_handover_protocol');
                    appendFile('h_scan_return', 'rm_h_return', 'scan_return_protocol', 'remove_scan_return_protocol');

                    data = formData;
                }
                // 6. REZERWACJE (Poprawiona logika FormData)
                else if (currentView === 'reservations') {
                        const formData = new FormData();

                        formData.append('first_name', document.getElementById('r_first_name').value);
                        formData.append('last_name', document.getElementById('r_last_name').value);
                        formData.append('company', document.getElementById('r_company').value);
                        formData.append('date_from', document.getElementById('r_date_from').value);
                        formData.append('date_to', document.getElementById('r_date_to').value);
                        formData.append('vehicle_type', document.getElementById('r_vehicle_type').value);
                        formData.append('status', document.getElementById('r_status').value);
                        formData.append('additional_info', document.getElementById('r_additional_info').value);

                        const assignedVal = document.getElementById('r_assigned_vehicle').value;
                        if (assignedVal) {
                            formData.append('assigned_vehicle', parseInt(assignedVal));
                        }

                        const driverVal = document.getElementById('r_driver_id').value;
                        if (driverVal) formData.append('driver', parseInt(driverVal));

                        // 1. OBS≈ÅUGA NOWYCH PLIK√ìW (MULTIPLE)
                        const fileInput = document.getElementById('r_new_files');
                        if (fileInput && fileInput.files.length > 0) {
                            for (let i = 0; i < fileInput.files.length; i++) {
                                // Appendujemy ka≈ºdy plik pod tym samym kluczem 'new_files'
                                // Django API potraktuje to jako listƒô
                                formData.append('new_files', fileInput.files[i]);
                            }
                        }

                        // 2. OBS≈ÅUGA USUWANIA PLIK√ìW
                        // Szukamy wszystkich zaznaczonych checkbox√≥w z klasƒÖ .remove-attachment-cb
                        const checkboxes = document.querySelectorAll('.remove-attachment-cb:checked');
                        checkboxes.forEach(cb => {
                            formData.append('remove_attachment_ids', parseInt(cb.value));
                        });

                        data = formData;
                }
                // 7. EDYCJA ISTNIEJƒÑCYCH (POLISY I SERWIS)
                else if (currentRecordId) {
                    const resolvedEndpoint = endpointMap[currentView] || currentView;

                    if (resolvedEndpoint === 'service_events') {
                        data = {
                            pojazd: parseInt(document.getElementById('pojazd_id').value),
                            opis: document.getElementById('opis_serwisu').value,
                            koszt: parseFloat(document.getElementById('koszt_val').value) || 0,
                            data_serwisu: document.getElementById('data_serwisu_val').value,
                            typ_zdarzenia: document.getElementById('typ_zdarzenia_val').value
                        };
                    } else if (resolvedEndpoint === 'policies') {
                        data = {
                            pojazd: parseInt(document.getElementById('pojazd_id').value),
                            numer_polisy: document.getElementById('numer_polisy').value,
                            ubezpieczyciel: document.getElementById('ubezpieczyciel_val').value,
                            // TUTAJ TE≈ª DODAJEMY KOSZT (je≈õli edytujesz polisƒô w kalendarzu, to pole mo≈ºe mieƒá inne ID, sprawd≈∫ funkcjƒô openModal poni≈ºej)
                            koszt: parseFloat(document.getElementById('koszt_val') ? document.getElementById('koszt_val').value : 0),
                            data_waznosci_oc: document.getElementById('data_waznosci_oc').value,
                            data_waznosci_ac: document.getElementById('data_waznosci_ac').value || null
                        };
                    }
                }

                // 8. ZAPIS DOKUMENTU POJAZDU
                else if (currentView === 'vehicle_documents') {
                    const formData = new FormData();
                    formData.append('vehicle', document.getElementById('doc_vehicle_id').value);
                    formData.append('title', document.getElementById('doc_title').value);
                    formData.append('description', document.getElementById('doc_desc').value);

                    const fileInput = document.getElementById('doc_file');
                    if (fileInput.files[0]) {
                        formData.append('file', fileInput.files[0]);
                    }

                    data = formData;
                    // endpoint jest pobierany automatycznie z endpointMap
                }


                // --- WYSY≈ÅANIE ≈ªƒÑDANIA ---
                const headers = getAuthHeaders();

                // WA≈ªNE: Je≈õli wysy≈Çamy FormData (plik), usuwamy Content-Type (przeglƒÖdarka ustawi go sama)
                if (data instanceof FormData) {
                    delete headers['Content-Type'];
                }

                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: (data instanceof FormData) ? data : JSON.stringify(data)
                });

                if (response.status === 401) { handleLogout(); return; }

                if (response.ok) {
                    console.log("Zapis zako≈Ñczony sukcesem!");
                    document.getElementById('data-modal').style.display = "none";
                    loadView(currentView);
                } else {
                    const errorData = await response.json();

                    // --- FORMATOWANIE B≈ÅƒòD√ìW ---
                    let readableError = "";

                    // 1. Sprawdzamy b≈Çƒôdy og√≥lne (np. konflikt rezerwacji)
                    if (errorData.non_field_errors) {
                        readableError = errorData.non_field_errors.join('<br>');
                    }
                    // 2. Sprawdzamy b≈Çƒôdy konkretnego pola (np. brak daty)
                    else {
                        // Tworzymy listƒô b≈Çƒôd√≥w dla p√≥l
                        readableError = Object.entries(errorData).map(([key, msgs]) => {
                            // T≈Çumaczenie nazw p√≥l na czytelniejsze (opcjonalne)
                            let fieldLabel = key;
                            if(key === 'date_from') fieldLabel = 'Data Od';
                            if(key === 'date_to') fieldLabel = 'Data Do';
                            if(key === 'assigned_vehicle') fieldLabel = 'Pojazd';
                            if(key === 'driver') fieldLabel = 'Kierowca';
                            if(key === 'detail') return msgs; // B≈ÇƒÖd og√≥lny (np. brak uprawnie≈Ñ)

                            const msgText = Array.isArray(msgs) ? msgs.join(', ') : msgs;
                            return `<strong>${fieldLabel}:</strong> ${msgText}`;
                        }).join('<br>');
                    }

                    // Wy≈õwietlamy ≈Çadny komunikat (czerwona ramka)
                    modalError.style.height = 'auto'; // Resetujemy sta≈ÇƒÖ wysoko≈õƒá, ≈ºeby zmie≈õci≈Ç siƒô tekst
                    modalError.style.color = 'inherit'; // Resetujemy kolor tekstu (stylujemy divem ni≈ºej)

                    modalError.innerHTML = `
                        <div style="background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px; font-size: 0.9em; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 1.2em;"></i>
                            <div>${readableError}</div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error("B≈ÇƒÖd handleSave:", error);
                if (modalError) modalError.textContent = "WystƒÖpi≈Ç b≈ÇƒÖd po stronie przeglƒÖdarki.";
            }
        }


        async function handleDelete() {
            if (!currentRecordId || !confirm(`Czy na pewno chcesz usunƒÖƒá rekord o ID: ${currentRecordId}?`)) {
                return;
            }

            const endpoint = endpointMap[currentView] || currentView;
            const url = `${API_BASE}${endpoint}/${currentRecordId}/`;

            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }

                if (response.status === 204) {
                    modal.style.display = "none";
                    loadView(currentView);
                } else {
                    modalError.textContent = `B≈ÇƒÖd usuwania (Status: ${response.status}).`;
                }

            } catch (error) {
                modalError.textContent = `B≈ÇƒÖd sieci podczas usuwania: ${error.message}`;
            }
        }

        deleteBtn.onclick = handleDelete;

        async function deleteRecord(viewName, id) {
            currentView = viewName;
            currentRecordId = id;
            await handleDelete();
        }

        function getActionButtons(record, viewName) {
            const id = record.id;
            return `
                <div class="action-buttons" style="display: flex; gap: 8px; justify-content: center;">
                    <button class="btn-edit"
                            onclick="openModal('${viewName}', ${id})"
                            style="cursor: pointer; padding: 5px 12px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px;">
                        Edytuj
                    </button>
                    <button class="btn-delete"
                            onclick="deleteRecord('${viewName}', ${id})"
                            style="cursor: pointer; padding: 5px 12px; background-color: #ff4d4d; color: white; border: none; border-radius: 4px;">
                        Usu≈Ñ
                    </button>
                </div>
            `;
        }

        async function renderSettlements() {
            currentView = 'settlements';
            viewTitle.textContent = 'Rozliczenia i Raporty Finansowe';

            const contentDiv = document.getElementById('main-content');
            contentDiv.innerHTML = '<div style="text-align:center; padding:20px;">Pobieranie danych...</div>';
            document.getElementById('add-btn').style.display = 'none';

            try {
                // 1. POBIERANIE DANYCH
                const headers = getAuthHeaders();
                const [vehicles, services, policies, handovers, damages] = await Promise.all([
                    fetch(API_BASE + 'vehicles/', { headers }).then(r => r.json()),
                    fetch(API_BASE + 'service_events/', { headers }).then(r => r.json()),
                    fetch(API_BASE + 'policies/', { headers }).then(r => r.json()),
                    fetch(API_BASE + 'handovers/', { headers }).then(r => r.json()),
                    fetch(API_BASE + 'damage_events/', { headers }).then(r => r.json())
                ]);

                // 2. PRZYGOTOWANIE UI FILTR√ìW
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();

                const htmlFilters = `
                    <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:20px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                        <div style="display:flex; flex-direction:column;">
                            <label style="font-size:0.8em; font-weight:bold; color:#555;">Rodzaj raportu:</label>
                            <select id="filter_mode" style="padding:5px; border:1px solid #ccc; border-radius:4px;">
                                <option value="ALL">Ca≈Ço≈õciowy (Wszystko)</option>
                                <option value="YEAR">Roczny</option>
                                <option value="MONTH">Miesiƒôczny</option>
                            </select>
                        </div>

                        <div id="filter_year_container" style="display:none; flex-direction:column;">
                            <label style="font-size:0.8em; font-weight:bold; color:#555;">Rok:</label>
                            <input type="number" id="filter_year" value="${currentYear}" style="padding:5px; border:1px solid #ccc; border-radius:4px; width:80px;">
                        </div>

                        <div id="filter_month_container" style="display:none; flex-direction:column;">
                            <label style="font-size:0.8em; font-weight:bold; color:#555;">MiesiƒÖc:</label>
                            <select id="filter_month" style="padding:5px; border:1px solid #ccc; border-radius:4px;">
                                <option value="0" ${currentMonth === 0 ? 'selected' : ''}>Stycze≈Ñ</option>
                                <option value="1" ${currentMonth === 1 ? 'selected' : ''}>Luty</option>
                                <option value="2" ${currentMonth === 2 ? 'selected' : ''}>Marzec</option>
                                <option value="3" ${currentMonth === 3 ? 'selected' : ''}>Kwiecie≈Ñ</option>
                                <option value="4" ${currentMonth === 4 ? 'selected' : ''}>Maj</option>
                                <option value="5" ${currentMonth === 5 ? 'selected' : ''}>Czerwiec</option>
                                <option value="6" ${currentMonth === 6 ? 'selected' : ''}>Lipiec</option>
                                <option value="7" ${currentMonth === 7 ? 'selected' : ''}>Sierpie≈Ñ</option>
                                <option value="8" ${currentMonth === 8 ? 'selected' : ''}>Wrzesie≈Ñ</option>
                                <option value="9" ${currentMonth === 9 ? 'selected' : ''}>Pa≈∫dziernik</option>
                                <option value="10" ${currentMonth === 10 ? 'selected' : ''}>Listopad</option>
                                <option value="11" ${currentMonth === 11 ? 'selected' : ''}>Grudzie≈Ñ</option>
                            </select>
                        </div>

                        <button id="btn_apply_filter" style="margin-top:auto; padding:6px 20px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">
                            PRZELICZ
                        </button>
                    </div>

                    <div id="settlements_results"></div>
                `;

                contentDiv.innerHTML = htmlFilters;

                // 3. LOGIKA FILTROWANIA I OBLICZE≈É
                const calculateAndShow = () => {
                    const mode = document.getElementById('filter_mode').value;
                    const year = parseInt(document.getElementById('filter_year').value);
                    const month = parseInt(document.getElementById('filter_month').value);

                    const isInPeriod = (dateString) => {
                        if (!dateString) return false;
                        if (mode === 'ALL') return true;
                        const d = new Date(dateString);
                        if (mode === 'YEAR') { return d.getFullYear() === year; }
                        if (mode === 'MONTH') { return d.getFullYear() === year && d.getMonth() === month; }
                        return true;
                    };

                    const stats = {};
                    let totalService = 0, totalPolicy = 0, totalIncome = 0;

                    vehicles.forEach(v => {
                        stats[v.id] = {
                            reg: v.registration_number,
                            marka: v.marka,
                            model: v.model,
                            serviceCost: 0, policyCost: 0, income: 0, balance: 0
                        };
                    });

                    // Agregacja danych
                    services.forEach(s => {
                        if (stats[s.pojazd] && isInPeriod(s.data_serwisu)) {
                            const k = parseFloat(s.koszt) || 0;
                            stats[s.pojazd].serviceCost += k;
                            totalService += k;
                        }
                    });

                    policies.forEach(p => {
                        if (stats[p.pojazd] && isInPeriod(p.data_waznosci_oc)) {
                            const k = parseFloat(p.koszt) || 0;
                            stats[p.pojazd].policyCost += k;
                            totalPolicy += k;
                        }
                    });

                    handovers.forEach(h => {
                        if (stats[h.pojazd] && isInPeriod(h.data_wydania)) {
                            const k = parseFloat(h.calkowity_koszt) || 0;
                            stats[h.pojazd].income += k;
                            totalIncome += k;
                        }
                    });

                    // Konwersja na tablicƒô i sortowanie
                    let resultsArray = Object.values(stats).map(s => {
                        s.balance = s.income - (s.serviceCost + s.policyCost);
                        return s;
                    });

                    if (mode !== 'ALL') {
                        resultsArray = resultsArray.filter(s => s.income !== 0 || s.serviceCost !== 0 || s.policyCost !== 0);
                    }
                    resultsArray = applySort(resultsArray);

                    const totalExpense = totalService + totalPolicy;
                    const balance = totalIncome - totalExpense;

                    // --- ZMIANA: DEFINICJA SIATKI NA CA≈ÅƒÑ SZEROKO≈öƒÜ (fr zamiast px) ---
                    // 50px (Lp), 1.2fr (Rej), 2fr (Pojazd - szerszy), reszta po 1fr
                    const gridLayout = "50px 1.2fr 2fr 1fr 1fr 1fr 1fr 1fr";

                    // --- GENEROWANIE HTML ---
                    let resultsHtml = `
                        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; margin-bottom:30px;">
                            <div style="background:white; padding:15px; border-radius:8px; border-left:5px solid #28a745; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                                <div style="font-size:0.9em; color:#666;">Przych√≥d (${mode === 'ALL' ? 'Ca≈Ço≈õƒá' : (mode === 'YEAR' ? year : (month+1)+'/'+year)})</div>
                                <div style="font-size:1.8em; font-weight:bold; color:#28a745;">${totalIncome.toFixed(2)} PLN</div>
                            </div>
                            <div style="background:white; padding:15px; border-radius:8px; border-left:5px solid #dc3545; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                                <div style="font-size:0.9em; color:#666;">Koszty Serwisu</div>
                                <div style="font-size:1.8em; font-weight:bold; color:#dc3545;">${totalService.toFixed(2)} PLN</div>
                            </div>
                            <div style="background:white; padding:15px; border-radius:8px; border-left:5px solid #007bff; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                                <div style="font-size:0.9em; color:#666;">Koszty Ubezpiecze≈Ñ</div>
                                <div style="font-size:1.8em; font-weight:bold; color:#0056b3;">${totalPolicy.toFixed(2)} PLN</div>
                            </div>
                            <div style="background:white; padding:15px; border-radius:8px; border-left:5px solid #17a2b8; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                                <div style="font-size:0.9em; color:#666;">BILANS OKRESU</div>
                                <div style="font-size:1.8em; font-weight:bold; color:${balance >= 0 ? '#17a2b8' : 'red'};">
                                    ${balance > 0 ? '+' : ''}${balance.toFixed(2)} PLN
                                </div>
                            </div>
                        </div>

                        <h3 style="margin-bottom:10px; color:#34495e;">Szczeg√≥≈Çy Pojazd√≥w</h3>

                        <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #ebedef; border-bottom: 2px solid #ccc;">
                            <div>Lp.</div>
                            ${getSortHeader('Nr Rej.', 'reg')}
                            ${getSortHeader('Pojazd', 'model')}
                            ${getSortHeader('Przych√≥d', 'income')}
                            ${getSortHeader('Serwis', 'serviceCost')}
                            ${getSortHeader('Polisy', 'policyCost')}
                            ${getSortHeader('Bilans', 'balance')}
                            <div>Status</div>
                        </div>
                        <div style="background:white; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    `;

                    let index = 1;
                    resultsArray.forEach(s => {
                        const rowColor = s.balance >= 0 ? '#e6fff2' : '#fff5f5';

                        resultsHtml += `
                            <div class="table-row-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; align-items: center; background-color:${rowColor};">
                                <div>${index++}.</div>
                                <div style="font-weight:bold;">${s.reg}</div>
                                <div style="font-size:0.9em;">${s.marka} ${s.model}</div>
                                <div style="font-weight:bold; color:#28a745;">${s.income.toFixed(2)}</div>
                                <div style="color:#dc3545;">${s.serviceCost.toFixed(2)}</div>
                                <div style="color:#007bff;">${s.policyCost.toFixed(2)}</div>
                                <div style="font-weight:bold; color:${s.balance >= 0 ? 'green' : 'red'};">
                                    ${s.balance.toFixed(2)}
                                </div>
                                <div style="font-size:0.8em; color:#666;">
                                    ${s.balance > 0 ? '‚úÖ OK' : '‚ö†Ô∏è STRATA'}
                                </div>
                            </div>
                        `;
                    });

                    if (index === 1) {
                        resultsHtml += '<div style="padding:20px; text-align:center;">Brak danych finansowych w wybranym okresie.</div>';
                    }

                    resultsHtml += '</div>';
                    document.getElementById('settlements_results').innerHTML = resultsHtml;
                };

                // 4. OBS≈ÅUGA ZDARZE≈É
                const filterModeSelect = document.getElementById('filter_mode');
                const yearContainer = document.getElementById('filter_year_container');
                const monthContainer = document.getElementById('filter_month_container');
                const applyBtn = document.getElementById('btn_apply_filter');

                filterModeSelect.addEventListener('change', () => {
                    const val = filterModeSelect.value;
                    if (val === 'ALL') {
                        yearContainer.style.display = 'none';
                        monthContainer.style.display = 'none';
                    } else if (val === 'YEAR') {
                        yearContainer.style.display = 'flex';
                        monthContainer.style.display = 'none';
                    } else if (val === 'MONTH') {
                        yearContainer.style.display = 'flex';
                        monthContainer.style.display = 'flex';
                    }
                });

                applyBtn.addEventListener('click', calculateAndShow);
                calculateAndShow();

            } catch (e) {
                contentDiv.innerHTML = `<div class="error">B≈ÇƒÖd generowania raportu: ${e.message}</div>`;
            }
        }

        async function renderVehicleDocsList() {
            const contentDiv = document.getElementById('docs-content');
            const gridLayout = "40px 100px 100px 100px 1fr 1fr 1fr 1fr 1fr 1fr";

            contentDiv.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 5px; font-weight: bold; padding: 10px; background: #fff3cd; border-bottom: 2px solid #ccc; font-size: 0.8em; text-align: center; align-items: center;">
                    <div>Lp.</div>
                    ${getSortHeader('Marka', 'marka')}
                    ${getSortHeader('Model', 'model')}
                    ${getSortHeader('Nr Rej.', 'registration_number')}
                    <div>Dow√≥d Rej.</div> <div>Polisa OC</div> <div>Polisa AC</div> <div>Badanie Tech.</div> <div>Ks. Serwisowa</div> <div>Faktura Zakupu</div>
                </div>
                <div id="docs-list-items">≈Åadowanie danych...</div>
            `;

            const listDiv = document.getElementById('docs-list-items');
            try {
                const response = await fetch(API_BASE + 'vehicles/', { headers: getAuthHeaders() });
                let vehicles = await response.json();

                vehicles = applySort(vehicles); // Sortowanie

                listDiv.innerHTML = '';
                if (vehicles.length === 0) { listDiv.innerHTML = '<div style="padding:20px;">Brak pojazd√≥w.</div>'; return; }

                const fileLink = (url, label) => url ? `<a href="${url}" target="_blank" style="display:block; background:#28a745; color:white; padding:4px; border-radius:4px; text-decoration:none; font-size:0.75em; text-align:center;">‚¨á ${label}</a>` : `<span style="color:#ccc; font-size:0.75em;">- brak -</span>`;

                vehicles.forEach((v, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '5px';
                    row.style.padding = '8px 5px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';
                    row.style.textAlign = 'center';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div style="font-weight:bold;">${v.marka || '-'}</div>
                        <div>${v.model || '-'}</div>
                        <div style="color:#007bff; font-weight:bold;">${v.registration_number}</div>
                        <div>${fileLink(v.scan_registration_card, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_policy_oc, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_policy_ac, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_tech_inspection, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_service_book, 'Pobierz')}</div>
                        <div>${fileLink(v.scan_purchase_invoice, 'Pobierz')}</div>
                    `;
                    row.style.cursor = "pointer";
                    row.onclick = (e) => { if(e.target.tagName !== 'A') openModal('vehicles', v.id); };
                    listDiv.appendChild(row);
                });
            } catch (e) { listDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${e.message}</div>`; }
        }

         async function renderServiceEvents(filterType = null) {
            const filterMap = {
                'inspection': {title: 'Inspekcje', type: 'INSPEKCJA'},
                'repairs': {title: 'Naprawy', type: 'NAPRAWA'},
                'reviews': {title: 'PrzeglƒÖdy Okresowe', type: 'PRZEGLAD'},
                'tech_inspections': {title: 'Badania Techniczne', type: 'BADANIE_TECH'},
            };

            const currentFilter = filterMap[filterType] || {title: 'Zdarzenia Serwisowe', type: null};
            currentView = filterType || 'service_events';
            viewTitle.textContent = currentFilter.title;

            // Sprawdzamy, czy to widok z VINem (PrzeglƒÖdy lub Badania)
            const showVinLayout = ['reviews', 'tech_inspections'].includes(filterType);

            let gridLayout = "";
            let headerHtml = "";

            if (showVinLayout) {
                // --- UK≈ÅAD DLA PRZEGLƒÑD√ìW I BADA≈É (Z VIN, OPISEM i KOSZTEM) ---

                // Dynamiczna nazwa nag≈Ç√≥wka daty
                let dateHeader = "Termin";
                if (filterType === 'reviews') dateHeader = "Termin przeglƒÖdu";
                if (filterType === 'tech_inspections') dateHeader = "Termin badania technicznego";

                // Grid: Lp(50), Rej(120), VIN(160), Opis(1fr - reszta miejsca), Koszt(100), Termin(140), Akcje(120)
                gridLayout = "50px 120px 160px 1fr 100px 140px 120px";

                headerHtml = `
                    <div>Lp.</div>
                    <div>Pojazd (Nr Rej.)</div>
                    <div>Nr VIN</div>
                    <div>Opis</div> <div>Koszt</div>
                    <div>${dateHeader}</div>
                    <div style="text-align: center;">Akcje</div>
                `;
            } else {
                // --- UK≈ÅAD DLA NAPRAW (STANDARDOWY) ---
                // Lp, Rej, Opis, Koszt, Data, Akcje
                gridLayout = "50px 120px 1fr 100px 120px 120px";
                headerHtml = `
                    <div>Lp.</div>
                    <div>Pojazd (Nr Rej.)</div>
                    <div>Opis Zdarzenia</div>
                    <div>Koszt</div>
                    <div>Data</div>
                    <div style="text-align: center;">Akcje</div>
                `;
            }

            mainContent.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #ebedef; border-bottom: 2px solid #ccc; align-items: center;">
                    ${headerHtml}
                </div>
                <div id="data-list">≈Åadowanie zdarze≈Ñ...</div>
            `;

            const dataListDiv = document.getElementById('data-list');

            try {
                const response = await fetch(API_BASE + 'service_events/', { headers: getAuthHeaders() });

                if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                if (!response.ok) throw new Error(response.statusText);

                let events = await response.json();

                if (currentFilter.type) {
                     events = events.filter(e => e.typ_zdarzenia === currentFilter.type);
                }

                dataListDiv.innerHTML = '';

                if (events.length === 0) {
                    dataListDiv.innerHTML = '<div style="padding: 20px;">Brak wpis√≥w w tej kategorii.</div>';
                    return;
                }

                events.forEach((event, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';

                    if (showVinLayout) {
                        // Wiersz dla PrzeglƒÖd√≥w/Bada≈Ñ (z VIN, Opisem i Kosztem)
                        row.innerHTML = `
                            <div>${index + 1}.</div>
                            <div style="font-weight: bold;">${event.pojazd_nr_rej || '---'}</div>
                            <div style="font-family: monospace; font-size: 0.9em; color: #555;">${event.pojazd_vin || '---'}</div>

                            <div style="font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${event.opis}">
                                ${event.opis || '---'}
                            </div>

                            <div>${event.koszt} PLN</div>
                            <div>${event.data_serwisu}</div>
                            <div style="text-align: center;">${getActionButtons(event, currentView)}</div>
                        `;
                    } else {
                        // Wiersz dla Napraw
                        row.innerHTML = `
                            <div>${index + 1}.</div>
                            <div style="font-weight: bold;">${event.pojazd_nr_rej || '---'}</div>

                            <div class="text-ellipsis" title="${event.opis}">
                                ${event.opis}
                            </div>

                            <div>${event.koszt} PLN</div>
                            <div>${event.data_serwisu}</div>
                            <div style="text-align: center;">${getActionButtons(event, currentView)}</div>
                        `;
                    }
                    dataListDiv.appendChild(row);
                });
            } catch (error) {
                dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}</div>`;
            }
        }

        async function renderPolicies() {
             currentView = 'policies';
             viewTitle.textContent = 'Polisy Ubezpieczeniowe';

             // ROZSZERZONY UK≈ÅAD KOLUMN:
             // Lp(40px), Rej(110px), VIN(160px), Ubezpieczyciel(1fr - elastyczny), Nr Polisy(130px), Koszt(90px), OC(100px), AC(100px), Akcje(100px)
             const gridLayout = "40px 110px 160px 1fr 130px 90px 100px 100px 100px";

             mainContent.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #ebedef; border-bottom: 2px solid #ccc; align-items: center;">
                    <div>Lp.</div>
                    <div>Nr Rej.</div>
                    <div>VIN</div> <div>Ubezpieczyciel</div>
                    <div>Nr Polisy</div>
                    <div>Koszt</div> <div title="Wa≈ºno≈õƒá OC">Wa≈ºno≈õƒá OC</div>
                    <div title="Wa≈ºno≈õƒá AC">Wa≈ºno≈õƒá AC</div>
                    <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie danych polis...</div>
             `;

             const dataListDiv = document.getElementById('data-list');
             try {
                 const response = await fetch(API_BASE + 'policies/', { headers: getAuthHeaders() });
                 if (response.status === 401) { handleLogout(); throw new Error('Sesja wygas≈Ça.'); }
                 if (!response.ok) throw new Error(response.statusText);

                 const policies = await response.json();
                 dataListDiv.innerHTML = '';

                 if (policies.length === 0) {
                    dataListDiv.innerHTML = '<div style="padding: 20px;">Brak polis. Kliknij DODAJ, aby utworzyƒá nowƒÖ.</div>';
                    return;
                 }

                 policies.forEach((policy, index) => {
                     const row = document.createElement('div');
                     row.className = 'table-row-sm';
                     row.style.display = 'grid';
                     row.style.gridTemplateColumns = gridLayout;
                     row.style.gap = '10px';
                     row.style.padding = '10px';
                     row.style.borderBottom = '1px solid #eee';
                     row.style.alignItems = 'center';

                     // Kolorowanie daty OC (czerwony je≈õli brak lub minƒô≈Ça - opcjonalnie mo≈ºna rozbudowaƒá)
                     const ocColor = policy.data_waznosci_oc ? 'black' : 'red';

                     row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div style="font-weight: bold;">${policy.pojazd_nr_rej || '---'}</div>

                        <div style="font-family: monospace; font-size: 0.9em; color: #555;">${policy.pojazd_vin || '---'}</div>

                        <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${policy.ubezpieczyciel}">
                            ${policy.ubezpieczyciel || '---'}
                        </div>

                        <div style="font-family: monospace; font-size: 0.9em;">${policy.numer_polisy}</div>
                        <div>${policy.koszt} PLN</div>

                        <div style="color: ${ocColor}; font-weight: bold;">${policy.data_waznosci_oc}</div>
                        <div style="font-size: 0.9em; color: #666;">${policy.data_waznosci_ac || '-'}</div>

                        <div style="text-align: center;">${getActionButtons(policy, 'policies')}</div>
                     `;
                     dataListDiv.appendChild(row);
                 });
             } catch (error) {
                 dataListDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}. <br>Pamiƒôtaj o restarcie serwera po zmianie serializers.py!</div>`;
             }
         }

        async function renderDrivers() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            currentView = 'drivers';
            viewTitle.textContent = 'U≈ºytkownicy (Kierowcy)';
            const gridLayout = "40px 150px 1fr 100px 110px 50px 110px 110px 100px";

            mainContent.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; padding: 10px; background: #ebedef; font-weight: bold; border-bottom: 2px solid #ccc; font-size: 0.85em; align-items: center;">
                    <div>Lp.</div>
                    ${getSortHeader('Kierowca', 'first_name')}
                    ${getSortHeader('Email', 'email')}
                    ${getSortHeader('Firma', 'company_name')}
                    ${getSortHeader('Nr Pr. Jazdy', 'numer_prawa_jazdy')}
                    <div>Kat.</div>
                    ${getSortHeader('Wa≈ºno≈õƒá PJ', 'data_waznosci_prawa_jazdy')}
                    ${getSortHeader('Badania lek.', 'data_waznosci_badan')}
                    <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie...</div>
            `;

            const dataList = document.getElementById('data-list');

            try {
                const response = await fetch(`${API_BASE}drivers/`, { headers: getAuthHeaders() });
                let data = await response.json();

                // Normalizacja imienia do sortowania (user_name vs first_name)
                data.forEach(d => {
                     d.full_name_sort = (d.first_name || d.last_name) ? `${d.first_name} ${d.last_name}` : d.user_name;
                });
                // Je≈õli sortujemy po imieniu, u≈ºywamy pola pomocniczego, w przeciwnym razie standardowo
                if(sortState.column === 'first_name') sortState.column = 'full_name_sort';

                data = applySort(data);

                dataList.innerHTML = '';
                if (data.length === 0) { dataList.innerHTML = '<div style="padding:20px;">Brak kierowc√≥w.</div>'; return; }

                data.forEach((driver, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.alignItems = 'center';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.fontSize = '0.85em';

                    const displayName = driver.full_name_sort;
                    const dataBadan = driver.data_waznosci_badan || '---';
                    const dataPJ = driver.data_waznosci_prawa_jazdy || '---';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div style="font-weight: bold;">${displayName}</div>
                        <div style="font-size: 0.9em; overflow: hidden; text-overflow: ellipsis;" title="${driver.email}">${driver.email || '---'}</div>
                        <div>${driver.company_name || '<span style="color: #ccc;">-</span>'}</div>
                        <div style="font-family: monospace;">${driver.numer_prawa_jazdy || '---'}</div>
                        <div style="text-align: center;">${driver.kategorie_prawa_jazdy || 'B'}</div>
                        <div style="font-weight:bold; color:#333;">${dataPJ}</div>
                        <div style="color: ${dataBadan !== '---' ? 'green' : '#666'}; font-weight: bold;">${dataBadan}</div>
                        <div style="text-align: center;">${getActionButtons(driver, 'drivers')}</div>
                    `;
                    dataList.appendChild(row);
                });
            } catch (error) { dataList.innerHTML = '<div style="color: red; padding: 10px;">B≈ÇƒÖd ≈Çadowania danych.</div>'; }
        }

        async function renderHandovers() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            currentView = 'handover';
            viewTitle.textContent = 'Przekazania Pojazd√≥w';

            // NOWA SIATKA (GRID):
            // Zdefiniowa≈Çem szeroko≈õci tak, aby dane siƒô mie≈õci≈Çy,
            // a "1fr" przy "Uwagi" sprawia, ≈ºe tabela zajmuje 100% szeroko≈õci.
            // Lp(40px), Imie(100px), Nazwisko(110px), Firma(100px), Marka(100px), Model(100px), Rej(100px), Wydanie(110px), Zwrot(110px), UWAGI(1fr - reszta), Akcje(100px)
            const gridLayout = "40px 100px 110px 100px 100px 100px 100px 110px 110px 1fr 100px";

            mainContent.innerHTML = `
                <div class="table-header" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; padding: 10px; background: #ebedef; font-weight: bold; border-bottom: 2px solid #ccc; font-size: 0.85em; align-items: center;">
                    <div>Lp.</div>
                    <div>Imiƒô</div>
                    <div>Nazwisko</div>
                    <div>Firma</div>
                    <div>Marka</div>
                    <div>Model</div>
                    <div>Rejestracja</div>
                    <div>Data Przyp.</div>
                    <div>Data Oddania</div>
                    <div>Uwagi</div> <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie danych...</div>
            `;

            const dataList = document.getElementById('data-list');

            try {
                const response = await fetch(`${API_BASE}handovers/`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) { handleLogout(); return; }
                if (!response.ok) throw new Error("B≈ÇƒÖd API: " + response.status);

                const handovers = await response.json();
                dataList.innerHTML = '';

                if (handovers.length === 0) {
                    dataList.innerHTML = '<div style="padding: 20px; text-align: center;">Brak danych w bazie. Kliknij DODAJ, aby stworzyƒá pierwsze przekazanie.</div>';
                    return;
                }

                handovers.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row';

                    // Stylizacja wiersza
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.fontSize = '0.85em';
                    row.style.alignItems = 'center';

                    // Logika koloru dla daty zwrotu
                    const zwrotText = item.data_zwrotu || '<span style="color: green; font-weight: bold;">W u≈ºytku</span>';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div>${item.imie || '-'}</div>
                        <div style="font-weight: bold;">${item.nazwisko || '-'}</div>
                        <div>${item.firma || '-'}</div>
                        <div>${item.marka || '-'}</div>
                        <div>${item.model || '-'}</div>
                        <div>${item.rejestracja || '-'}</div>
                        <div>${item.data_wydania}</div>
                        <div>${zwrotText}</div>

                        <div class="text-ellipsis" title="${item.uwagi || ''}">
                            ${item.uwagi || '-'}
                        </div>

                        <div style="text-align: center;">${getActionButtons(item, 'handover')}</div>
                    `;
                    dataList.appendChild(row);
                });
            } catch (error) {
                dataList.innerHTML = `<div style="color:red; padding:10px;">B≈ÇƒÖd po≈ÇƒÖczenia z serwerem: ${error.message}</div>`;
            }
        }

        async function renderVehicles() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            currentView = 'vehicles';
            viewTitle.textContent = 'Pojazdy';

            // Grid: Lp, Marka, Model, Typ, Rej, VIN, Paliwo, Przebieg, Firma, U≈ºytkownik, Status, Uwagi, Akcje
            const gridLayout = "40px 100px 100px 100px 100px 150px 100px 100px 100px 120px 100px 1fr 120px";

            mainContent.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #ebedef; border-bottom: 2px solid #ccc; align-items: center; font-size: 0.85em;">
                    <div>Lp.</div>
                    ${getSortHeader('Marka', 'marka')}
                    ${getSortHeader('Model', 'model')}
                    ${getSortHeader('Typ', 'typ_pojazdu')}
                    ${getSortHeader('Nr Rej.', 'registration_number')}
                    ${getSortHeader('VIN', 'vin')}
                    ${getSortHeader('Paliwo', 'fuel_type')}
                    ${getSortHeader('Przebieg', 'przebieg')}
                    ${getSortHeader('Firma', 'company_name')}
                    ${getSortHeader('U≈ºytkownik', 'assigned_user_name')}
                    ${getSortHeader('Status', 'status')}
                    <div>Uwagi</div>
                    <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie pojazd√≥w...</div>
            `;

            const dataList = document.getElementById('data-list');

            try {
                const response = await fetch(API_BASE + 'vehicles/', { headers: getAuthHeaders() });
                if (response.status === 401) { handleLogout(); return; }
                let vehicles = await response.json();

                // SORTOWANIE
                vehicles = applySort(vehicles);

                dataList.innerHTML = '';
                if (vehicles.length === 0) {
                    dataList.innerHTML = '<div style="padding: 20px;">Brak pojazd√≥w. Kliknij DODAJ.</div>';
                    return;
                }

                vehicles.forEach((v, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';
                    row.style.fontSize = '0.85em';

                    const statusColor = v.status === 'SPRAWNY' ? 'green' : 'red';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div style="font-weight:bold;">${v.marka || '-'}</div>
                        <div>${v.model || '-'}</div>
                        <div>${v.typ_display || v.typ_pojazdu}</div>
                        <div style="color:#007bff; font-weight:bold;">${v.registration_number}</div>
                        <div style="font-family:monospace;">${v.vin}</div>
                        <div>${v.fuel_type_display || v.fuel_type}</div>
                        <div>${v.przebieg} km</div>
                        <div>${v.company_name || '-'}</div>
                        <div>${v.assigned_user_name || '-'}</div>
                        <div style="color:${statusColor}; font-weight:bold;">${v.status_display || v.status}</div>
                        <div class="text-ellipsis" title="${v.uwagi || ''}">${v.uwagi || '-'}</div>
                        <div style="text-align: center;">${getActionButtons(v, 'vehicles')}</div>
                    `;
                    dataList.appendChild(row);
                });
            } catch (error) {
                dataList.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}</div>`;
            }
        }

        async function renderVehicleHistory(selectedVehicleId = null) {
            const contentDiv = document.getElementById('main-content');
            currentView = 'vehicle_history';

            // 1. WIDOK WYBORU POJAZDU (KAFELKI)
            if (!selectedVehicleId) {
                viewTitle.textContent = 'Historia Pojazdu - Wybierz Samoch√≥d';
                contentDiv.innerHTML = '<div id="v-grid" class="vehicle-grid">≈Åadowanie...</div>';

                // Ukrywamy przycisk DODAJ, bo tu tylko przeglƒÖdamy
                document.getElementById('add-btn').style.display = 'none';

                try {
                    const response = await fetch(API_BASE + 'vehicles/', { headers: getAuthHeaders() });
                    const vehicles = await response.json();

                    const grid = document.getElementById('v-grid');
                    grid.innerHTML = '';

                    if(vehicles.length === 0) {
                        grid.innerHTML = 'Brak pojazd√≥w w bazie.';
                        return;
                    }

                    vehicles.forEach(v => {
                        const card = document.createElement('div');
                        card.className = 'vehicle-card';
                        card.innerHTML = `
                            <h3>${v.registration_number}</h3>
                            <p style="font-weight:bold; font-size:1.1em;">${v.marka} ${v.model}</p>
                            <p>${v.vin}</p>
                            <p style="color:${v.status==='SPRAWNY'?'green':'red'}">${v.status}</p>
                            <button style="margin-top:10px; padding:5px 15px; cursor:pointer; background:#007bff; color:white; border:none; border-radius:4px;">
                                Zobacz Historiƒô
                            </button>
                        `;
                        card.onclick = () => renderVehicleHistory(v.id);
                        grid.appendChild(card);
                    });

                } catch (e) {
                    contentDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${e.message}</div>`;
                }
            }

            // 2. WIDOK OSI CZASU (KONKRETNY POJAZD)
            else {
                contentDiv.innerHTML = '<div style="text-align:center; padding:20px;">Pobieranie historii...</div>';
                document.getElementById('add-btn').style.display = 'none';

                try {
                    // Pobieramy historiƒô z naszego nowego endpointu w views.py
                    const response = await fetch(`${API_BASE}vehicles/${selectedVehicleId}/history/`, { headers: getAuthHeaders() });

                    if(!response.ok) throw new Error("B≈ÇƒÖd pobierania historii");
                    const events = await response.json();

                    // Pobierz info o aucie dla tytu≈Çu (opcjonalnie mo≈ºna wyciƒÖgnƒÖƒá z events je≈õli API by zwraca≈Ço)
                    // Dla uproszczenia ustawiamy og√≥lny tytu≈Ç, lub mo≈ºna pobraƒá vehicle/${id}
                    viewTitle.innerHTML = `
                        <button onclick="renderVehicleHistory()" style="font-size:0.6em; cursor:pointer; margin-right:10px; padding:5px 10px;">‚¨Ö Wr√≥ƒá</button>
                        Historia Pojazdu
                    `;

                    if (events.length === 0) {
                        contentDiv.innerHTML = '<div style="text-align:center; padding:40px;">To auto nie ma jeszcze ≈ºadnej historii (brak wyda≈Ñ, szk√≥d, serwis√≥w).</div>';
                        return;
                    }

                    let timelineHtml = '<div class="timeline-container">';

                    events.forEach(e => {
                        timelineHtml += `
                            <div class="timeline-item">
                                <div class="timeline-date">${e.date}</div>
                                <div class="timeline-icon" style="background-color: ${e.color};">
                                    <i class="fas ${e.icon}"></i>
                                </div>
                                <div class="timeline-content" style="border-left-color: ${e.color};">
                                    <h4 style="color:${e.color}">${e.title}</h4>
                                    <p>${e.description}</p>
                                </div>
                            </div>
                        `;
                    });

                    timelineHtml += '</div>';
                    contentDiv.innerHTML = timelineHtml;

                } catch (e) {
                    contentDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${e.message}</div>`;
                }
            }
        }


        async function renderReservations() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            currentView = 'reservations';
            viewTitle.textContent = 'Rezerwacje Pojazd√≥w';
            const gridLayout = "40px 100px 100px 120px 100px 120px 140px 130px 1fr 100px";

            mainContent.innerHTML = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #ebedef; border-bottom: 2px solid #ccc; align-items: center;">
                    <div>Lp.</div>
                    ${getSortHeader('Imiƒô', 'first_name')}
                    ${getSortHeader('Nazwisko', 'last_name')}
                    ${getSortHeader('Firma', 'company')}
                    ${getSortHeader('Typ', 'vehicle_type')}
                    ${getSortHeader('Pojazd', 'assigned_vehicle_display')}
                    ${getSortHeader('Termin', 'date_from')}
                    ${getSortHeader('Status', 'status')}
                    <div>Info</div>
                    <div style="text-align: center;">Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie rezerwacji...</div>
            `;

            const dataList = document.getElementById('data-list');

            try {
                const response = await fetch(API_BASE + 'reservations/', { headers: getAuthHeaders() });
                if (response.status === 401) { handleLogout(); return; }

                let data = await response.json();
                data = applySort(data); // SORTOWANIE

                dataList.innerHTML = '';
                if (data.length === 0) { dataList.innerHTML = '<div style="padding: 20px;">Brak rezerwacji.</div>'; return; }

                data.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';

                    let statusColor = '#333'; let statusBg = '#f0f0f0';
                    if (item.status === 'OCZEKUJACE') { statusColor = '#856404'; statusBg = '#fff3cd'; }
                    if (item.status === 'PRZYJETE') { statusColor = '#004085'; statusBg = '#cce5ff'; }
                    if (item.status === 'ZATWIERDZONE') { statusColor = '#155724'; statusBg = '#d4edda'; }
                    if (item.status === 'ODRZUCONE') { statusColor = '#721c24'; statusBg = '#f8d7da'; }

                    const dOd = item.date_from || '---'; const dDo = item.date_to || '---';
                    const terminHtml = `<div style="font-size:0.85em; line-height:1.4em;">Od: <b>${dOd}</b><br>Do: <b>${dDo}</b></div>`;
                    const typHtml = `<span class="badge" style="background:#e6f7ff; padding: 2px 5px; border-radius:4px; font-size:0.9em;">${item.vehicle_type}</span>`;
                    let pojazdHtml = item.assigned_vehicle_display ? `<strong style="color: #007bff;">${item.assigned_vehicle_display}</strong>` : '<span style="color: #ccc;">---</span>';

                    // Info content (skr√≥cone dla przejrzysto≈õci)
                    let infoContent = item.additional_info ? `<div style="font-style:italic; color:#555;">${item.additional_info}</div>` : '';
                    if (item.attachments && item.attachments.length > 0) infoContent += '<div>üìé Za≈ÇƒÖczniki</div>';
                    if (!infoContent) infoContent = '-';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div>${item.first_name}</div>
                        <div style="font-weight: bold;">${item.last_name}</div>
                        <div>${item.company}</div>
                        <div>${typHtml}</div>
                        <div>${pojazdHtml}</div>
                        <div>${terminHtml}</div>
                        <div><span style="background-color: ${statusBg}; color: ${statusColor}; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85em;">${item.status}</span></div>
                        <div style="font-size: 0.85em;">${infoContent}</div>
                        <div style="text-align: center;">${getActionButtons(item, 'reservations')}</div>
                    `;
                    dataList.appendChild(row);
                });
            } catch (error) { dataList.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}</div>`; }
        }

        async function renderRentalHistoryList() {
            const contentDiv = document.getElementById('docs-content');

            // Grid bez ID Rezerwacji
            const gridLayout = "40px 100px 100px 120px 100px 100px 100px 1fr 60px";

            let html = `
                <div class="table-header-sm" style="display: grid; grid-template-columns: ${gridLayout}; gap: 10px; font-weight: bold; padding: 10px; background: #d4edda; border-bottom: 2px solid #ccc; font-size: 0.8em; align-items: center;">
                    <div>Lp.</div>
                    <div>Imiƒô</div>
                    <div>Nazwisko</div>
                    <div>Firma</div>
                    <div>Nr Rej.</div>
                    <div>Wydano</div>
                    <div>Zwr√≥cono</div>
                    <div style="text-align:center;">Dokumenty (Umowa / Wydanie / Zwrot)</div>
                    <div style="text-align:center;">Edycja</div>
                </div>
                <div id="history-list-items">≈Åadowanie...</div>
            `;
            contentDiv.innerHTML = html;

            const listDiv = document.getElementById('history-list-items');

            try {
                const response = await fetch(API_BASE + 'handovers/', { headers: getAuthHeaders() });
                const data = await response.json();

                data.sort((a, b) => new Date(b.data_wydania) - new Date(a.data_wydania));

                listDiv.innerHTML = '';
                if (data.length === 0) {
                    listDiv.innerHTML = '<div style="padding:20px;">Brak historii najmu.</div>';
                    return;
                }

                // Helper do przycisk√≥w
                const fileBtn = (url, label, color) => {
                    if(!url) return `<span style="color:#ccc; font-size:0.8em; margin-right:5px; opacity:0.5;">${label}</span>`;
                    return `<a href="${url}" target="_blank" style="background:${color}; color:white; padding:3px 6px; border-radius:4px; text-decoration:none; font-size:0.75em; margin-right:5px;">‚¨á ${label}</a>`;
                };

                data.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'table-row-sm';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = '10px';
                    row.style.padding = '8px 10px';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.alignItems = 'center';
                    row.style.fontSize = '0.85em';

                    const zwrot = item.data_zwrotu || '<span style="color:green; font-weight:bold;">W TRAKCIE</span>';

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div>${item.imie || '-'}</div>
                        <div>${item.nazwisko || '-'}</div>
                        <div>${item.firma || '-'}</div>
                        <div style="color:#007bff; font-weight:bold;">${item.rejestracja}</div>
                        <div>${item.data_wydania}</div>
                        <div>${zwrot}</div>
                        <div style="display:flex; justify-content:center; align-items:center;">
                            ${fileBtn(item.scan_agreement, 'Umowa', '#007bff')}
                            ${fileBtn(item.scan_handover_protocol, 'Wydanie', '#28a745')}
                            ${fileBtn(item.scan_return_protocol, 'Zwrot', '#dc3545')}
                        </div>
                        <div style="text-align:center;">
                            <button onclick="openModal('handover', ${item.id})" style="cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:4px; padding:2px 6px;">‚úèÔ∏è</button>
                        </div>
                    `;
                    listDiv.appendChild(row);
                });

            } catch (e) {
                listDiv.innerHTML = `<div class="error">B≈ÇƒÖd: ${e.message}</div>`;
            }
        }


        async function renderHrDocs(activeTab = 'documents') {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            viewTitle.textContent = 'Dokumentacja i Historia';

            // 1. Pasek zak≈Çadek
            const navHtml = `
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
                    <button onclick="renderHrDocs('documents')"
                        style="padding: 10px 20px; cursor: pointer; border: none; background: ${activeTab === 'documents' ? '#007bff' : '#e9ecef'}; color: ${activeTab === 'documents' ? 'white' : 'black'}; border-radius: 4px; font-weight: bold;">
                        üìÇ Dokumenty Pojazdu
                    </button>
                    <button onclick="renderHrDocs('history')"
                        style="padding: 10px 20px; cursor: pointer; border: none; background: ${activeTab === 'history' ? '#007bff' : '#e9ecef'}; color: ${activeTab === 'history' ? 'white' : 'black'}; border-radius: 4px; font-weight: bold;">
                        üìú Historia Najmu
                    </button>
                </div>
                <div id="docs-content">≈Åadowanie...</div>
            `;

            mainContent.innerHTML = navHtml;

            const addBtn = document.getElementById('add-btn');

            // 2. Logika widoczno≈õci i kontekstu przycisku
            if (activeTab === 'documents') {
                // Ustawiamy currentView na 'vehicle_documents', ≈ºeby przycisk DODAJ wiedzia≈Ç co robiƒá
                currentView = 'vehicle_documents';
                addBtn.style.display = 'none';

                // WA≈ªNE: Tutaj usunƒÖ≈Çem linijkƒô "addBtn.onclick = ...",
                // poniewa≈º loadView i tak ustawi domy≈õlne dzia≈Çanie openModal(currentView)

                await renderVehicleDocsList();
            } else {
                currentView = 'hr_history';
                addBtn.style.display = 'none';
                await renderRentalHistoryList();
            }
        }

        async function fetchDrivers() {
            try {
                const response = await fetch(API_BASE + 'drivers/', { headers: getAuthHeaders() });
                if (!response.ok) return [];
                return await response.json();
            } catch (e) { return []; }
        }

        async function renderDamageEvents() {
            viewTitle.textContent = 'Zdarzenia Szkodowe i Awarie';
            const token = localStorage.getItem('access_token');
            // Zdefiniujmy grid layout w jednym miejscu
            const gridLayout = "50px 120px 1fr 150px 150px 120px";

            mainContent.innerHTML = `
                <div class="table-header" style="display:grid; grid-template-columns: ${gridLayout}; gap:10px; padding:10px; background:#ebedef; font-weight:bold; align-items:center;">
                    <div>Lp.</div>
                    ${getSortHeader('Nr Rej.', 'pojazd_nr_rej')}
                    ${getSortHeader('Opis Szkody', 'opis')}
                    ${getSortHeader('Data', 'data_zdarzenia')}
                    ${getSortHeader('Status', 'status_naprawy')}
                    <div>Akcje</div>
                </div>
                <div id="data-list">≈Åadowanie szk√≥d...</div>
            `;

            const dataListDiv = document.getElementById('data-list');

            try {
                const response = await fetch('http://127.0.0.1:8000/api/damage_events/', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                let damages = await response.json();

                damages = applySort(damages); // SORTOWANIE

                dataListDiv.innerHTML = '';
                damages.forEach((damage, index) => {
                    const statusMap = {
                        'ZGLOSZONA': { txt: 'Zg≈Çoszona', col: '#ffc107' },
                        'W_NAPRAWIE': { txt: 'W naprawie', col: '#17a2b8' },
                        'ZAMKNIETA': { txt: 'Zamkniƒôta', col: '#28a745' }
                    };
                    const status = statusMap[damage.status_naprawy] || { txt: damage.status_naprawy, col: '#6c757d' };

                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.style.display = "grid";
                    row.style.gridTemplateColumns = gridLayout;
                    row.style.gap = "10px";
                    row.style.alignItems = "center"; // Wa≈ºne dla wyr√≥wnania

                    row.innerHTML = `
                        <div>${index + 1}.</div>
                        <div>${damage.pojazd_nr_rej}</div>
                        <div class="text-ellipsis" title="${damage.opis}">${damage.opis}</div>
                        <div>${damage.data_zdarzenia}</div>
                        <div style="color: ${status.col}; font-weight: bold;">${status.txt}</div>
                        <div>${getActionButtons(damage, 'damages')}</div>
                    `;
                    dataListDiv.appendChild(row);
                });
            } catch (err) { dataListDiv.innerHTML = `<p style="color:red;">B≈ÇƒÖd: ${err.message}</p>`; }
        }

         function renderPlaceholder(title) {
             currentView = title;
             viewTitle.textContent = title;
             mainContent.innerHTML = `<div style="padding: 40px; text-align: center; color: #6c757d;">
                 <h2>${title}</h2>
                 <p>Ten modu≈Ç wymaga osobnego endpointu API Django, modelu i logiki biznesowej. Front-end jest gotowy!</p>
             </div>`;
         }


        // --- NOWA LOGIKA DLA KALENDARZA ---

        let currentDate = new Date();

        async function fetchCalendarEvents() {
            const headers = getAuthHeaders();
            let events = [];

            try {
                const serviceResponse = await fetch(API_BASE + 'service_events/', { headers });
                if (serviceResponse.ok) {
                    const serviceEvents = await serviceResponse.json();
                    serviceEvents.forEach(e => {
                        if (e.data_serwisu) {
                            let type;
                            if (e.typ_zdarzenia.toLowerCase().includes('przeglad')) {
                                type = 'review';
                            } else if (e.typ_zdarzenia.toLowerCase().includes('naprawa')) {
                                type = 'repair';
                            } else {
                                type = 'inspection';
                            }
                            events.push({
                                date: e.data_serwisu,
                                title: `${e.pojazd_nr_rej} - ${e.typ_zdarzenia}`,
                                type: type,
                                record: e
                            });
                        }
                    });
                }

                const policyResponse = await fetch(API_BASE + 'policies/', { headers });
                if (policyResponse.ok) {
                    const policies = await policyResponse.json();
                    policies.forEach(p => {
                        if (p.data_waznosci_oc) {
                            events.push({
                                date: p.data_waznosci_oc,
                                title: `${p.pojazd_nr_rej} - Wa≈ºno≈õƒá OC`,
                                type: 'policy',
                                record: p
                            });
                        }
                        if (p.data_waznosci_ac && p.data_waznosci_ac !== 'Brak') {
                             events.push({
                                date: p.data_waznosci_ac,
                                title: `${p.pojazd_nr_rej} - Wa≈ºno≈õƒá AC`,
                                type: 'policy',
                                record: p
                            });
                        }
                    });
                }

            } catch (error) {
                console.error("B≈ÇƒÖd ≈Çadowania zdarze≈Ñ do kalendarza:", error);
            }

            return events;
        }

        function filterTable() {
            const input = document.getElementById('table-search');
            if (!input) return;

            const filter = input.value.toLowerCase();
            const rows = document.querySelectorAll('.table-row');

            rows.forEach(row => {
                const text = row.textContent || row.innerText;
                row.style.display = text.toLowerCase().includes(filter) ? "grid" : "none";
            });
        }

        async function renderCalendar() {
            currentView = 'calendar';
            viewTitle.textContent = 'Terminarz Floty';

            const allEvents = await fetchCalendarEvents();
            generateCalendarHTML(allEvents, currentDate);
        }

        function generateCalendarHTML(events, displayDate) {
            mainContent.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'calendar-view';

            const year = displayDate.getFullYear();
            const month = displayDate.getMonth();

            // --- 1. POBIERAMY DZISIEJSZƒÑ DATƒò ---
            const today = new Date();
            // ------------------------------------

            const monthNames = ["Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec",
                                "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"];

            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.innerHTML = `
                <button onclick="changeMonth(-1)">&#9664; Poprzedni</button>
                <span>${monthNames[month]} ${year}</span>
                <button onclick="changeMonth(1)">Nastƒôpny &#9654;</button>
            `;
            container.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'calendar-grid';

            const dayNames = ["Pon", "Wto", "≈öro", "Czw", "PiƒÖ", "Sob", "Nie"];
            dayNames.forEach(day => {
                const dayNameDiv = document.createElement('div');
                dayNameDiv.className = 'day-name';
                dayNameDiv.textContent = day;
                grid.appendChild(dayNameDiv);
            });

            const firstDayOfMonth = new Date(year, month, 1);
            const dayOfWeek = (firstDayOfMonth.getDay() === 0) ? 6 : firstDayOfMonth.getDay() - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < dayOfWeek; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day current-month';
                dayDiv.setAttribute('data-date', dateString);

                // --- 2. LOGIKA WYR√ì≈ªNIANIA "DZI≈ö" (POGRUBIENIE I RAMKA) ---
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayDiv.style.border = "2px solid #949494";   // gruba ramka
                    dayDiv.style.fontWeight = "bold";            // Pogrubiona czcionka
                    dayDiv.style.backgroundColor = "#eeeeee";    // Lekko szare t≈Ço

                    // Opcjonalnie: Zmieniamy te≈º styl samego numerka
                    dayDiv.innerHTML = `<span class="calendar-day-number" style="color:#000000; font-size:1.2em;">${day} </span>`;
                } else {
                    dayDiv.innerHTML = `<span class="calendar-day-number">${day}</span>`;
                }
                // ----------------------------------------------------------

                const dayEvents = events.filter(e => e.date === dateString);
                const borderClasses = new Set();

                dayEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    let borderClass = '';

                    if (event.type === 'policy') {
                        eventDiv.className = `event-item event-policy`;
                        borderClass = 'day-border-policy';
                    } else if (event.type === 'review') {
                        eventDiv.className = `event-item event-review`;
                        borderClass = 'day-border-review';
                    } else if (event.type === 'inspection') {
                        eventDiv.className = `event-item event-inspection`;
                        borderClass = 'day-border-inspection';
                    } else if (event.type === 'repair') {
                        eventDiv.className = `event-item event-repair`;
                        borderClass = 'day-border-repair';
                    } else {
                        eventDiv.className = `event-item`;
                    }

                    eventDiv.title = event.title;
                    eventDiv.textContent = event.title;
                    dayDiv.appendChild(eventDiv);

                    if (borderClass) {
                        borderClasses.add(borderClass);
                    }
                });

                // Dodajemy klasy ramek tylko je≈õli to NIE jest dzisiaj (≈ºeby nie nadpisaƒá czerwonej ramki "dzi≈õ")
                if (!(day === today.getDate() && month === today.getMonth() && year === today.getFullYear())) {
                    borderClasses.forEach(className => dayDiv.classList.add(className));
                }

                grid.appendChild(dayDiv);
            }

            container.appendChild(grid);
            mainContent.appendChild(container);
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }
        window.changeMonth = changeMonth;


        // --- LOGIKA PRZE≈ÅƒÑCZANIA WIDOK√ìW I AUTORYZACJI ---

        const viewMap = {
            'vehicles': renderVehicles,
            'drivers': renderDrivers,
            'damages': renderDamageEvents,
            'handover': renderHandovers,
            'calendar': renderCalendar,
            'policies': renderPolicies,
            'reservations': renderReservations,
            'vehicle_documents': renderVehicleDocsList,
            'vehicle_history': () => renderVehicleHistory(),

            // --- NAPRAWIONE ZAK≈ÅADKI SERWISOWE ---
            // Teraz wywo≈ÇujƒÖ funkcjƒô renderServiceEvents z odpowiednim filtrem
            'reviews': () => renderServiceEvents('reviews'),
            'repairs': () => renderServiceEvents('repairs'),
            'tech_inspections': () => renderServiceEvents('tech_inspections'),
            'inspection': () => renderServiceEvents('inspection'),

            // --- BRAKUJƒÑCE ZAK≈ÅADKI (ZABEZPIECZENIE PRZED B≈ÅƒòDEM) ---
            // Dziƒôki temu klikniƒôcie nie spowoduje b≈Çƒôdu w konsoli
            'hr_docs': () => renderHrDocs('documents'),
            'settlements': renderSettlements,
            'settings': renderSettings,
            'other': () => renderPlaceholder('Pozosta≈Çe'),
        };

        function loadView(viewName) {
            menuItems.forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`[data-view="${viewName}"]`);
            if(activeItem) {
                activeItem.classList.add('active');
            }

            const parentView = activeItem ? activeItem.closest('.menu-item') : null;
            if (parentView) {
                parentView.classList.add('active');
            }

            currentView = viewName;

            addBtn.onclick = () => openModal(currentView);

            const isCalendarRelated = ['calendar', 'policies', 'tech_inspections', 'reviews', 'repairs', 'legalization', 'inspection'].includes(viewName);

            if (viewName === 'calendar' || viewName === 'settings' || viewName === 'settlements') {
                 // Tu mo≈ºesz ukryƒá przycisk dla widok√≥w, gdzie nie ma dodawania
                 // addBtn.style.display = 'none';
                 // Ale zostawmy 'inline' dla sp√≥jno≈õci, chyba ≈ºe wolisz ukrywaƒá
                 addBtn.style.display = 'inline';
            } else {
                addBtn.style.display = 'inline';
            }

            viewMap[viewName]();
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                if (localStorage.getItem('access_token')) {
                    loadView(item.dataset.view);
                }
            });
        });

        async function getAlertsData() {
            const headers = getAuthHeaders();
            let alerts = [];
            let alertDays = 7; // Domy≈õlnie

            try {
                // 1. Pobierz ustawienia globalne (dni wyprzedzenia)
                const settingsRes = await fetch(API_BASE + 'settings/', { headers });
                if (settingsRes.ok) {
                    const settings = await settingsRes.json();
                    alertDays = settings.alert_days || 7;
                }

                // 2. Pobierz dane
                const [policies, services] = await Promise.all([
                    fetch(API_BASE + 'policies/', { headers }).then(r => r.json()),
                    fetch(API_BASE + 'service_events/', { headers }).then(r => r.json())
                ]);

                const today = new Date();
                today.setHours(0,0,0,0);

                const warningDate = new Date();
                warningDate.setDate(today.getDate() + alertDays); // Data za X dni

                // A. SPRAWDZANIE POLIS (OC i AC)
                policies.forEach(p => {
                    // Funkcja pomocnicza
                    const checkDate = (dateStr, type) => {
                        if (!dateStr) return;
                        const d = new Date(dateStr);

                        if (d < today) {
                            alerts.push({ type: 'CRITICAL', msg: `Polisa ${type} wygas≈Ça!`, date: dateStr, reg: p.pojazd_nr_rej, id: p.id, view: 'policies' });
                        } else if (d <= warningDate) {
                            const diff = Math.ceil((d - today) / (1000 * 60 * 60 * 24));
                            alerts.push({ type: 'WARNING', msg: `Polisa ${type} wygasa za ${diff} dni`, date: dateStr, reg: p.pojazd_nr_rej, id: p.id, view: 'policies' });
                        }
                    };
                    checkDate(p.data_waznosci_oc, 'OC');
                    checkDate(p.data_waznosci_ac, 'AC');
                });

                // B. SPRAWDZANIE TERMIN√ìW BADA≈É I PRZEGLƒÑD√ìW
                // Filtrujemy tylko przysz≈Çe zdarzenia lub te z dzisiaj
                services.forEach(s => {
                    if (!['BADANIE_TECH', 'PRZEGLAD', 'LEGALIZACJA'].includes(s.typ_zdarzenia)) return;

                    const d = new Date(s.data_serwisu);
                    // Tutaj logika jest inna: szukamy zdarze≈Ñ, kt√≥re sƒÖ "planowane" w przysz≈Ço≈õci, a nie wykonane w przesz≈Ço≈õci.
                    // Ale w Twoim modelu data_serwisu to data wykonania.
                    // Za≈Ç√≥≈ºmy, ≈ºe je≈õli data jest w przysz≈Ço≈õci lub "dzi≈õ", to jest to plan.

                    if (d < today) {
                         // Opcjonalnie: Mo≈ºesz tu dodaƒá logikƒô "Przeterminowany przeglƒÖd" je≈õli w systemie nie ma nowszego wpisu.
                         // Na razie pominiemy to, ≈ºeby nie spamowaƒá starymi serwisami.
                    } else if (d <= warningDate) {
                        const diff = Math.ceil((d - today) / (1000 * 60 * 60 * 24));
                        const label = s.typ_zdarzenia === 'BADANIE_TECH' ? 'Badanie Tech.' : 'PrzeglƒÖd';
                        alerts.push({ type: 'WARNING', msg: `Zbli≈ºa siƒô ${label} (za ${diff} dni)`, date: s.data_serwisu, reg: s.pojazd_nr_rej, id: s.id, view: 'inspection' });
                    }
                });

            } catch (e) { console.error("B≈ÇƒÖd powiadomie≈Ñ:", e); }

            // Sortowanie: Najpierw przeterminowane (Critical), potem wg daty
            alerts.sort((a, b) => {
                if (a.type === 'CRITICAL' && b.type !== 'CRITICAL') return -1;
                if (a.type !== 'CRITICAL' && b.type === 'CRITICAL') return 1;
                return new Date(a.date) - new Date(b.date);
            });

            return alerts;
        }

        // Funkcja aktualizujƒÖca "CzerwonƒÖ kropkƒô" (uruchamiana przy starcie)
        async function updateNotificationBadge() {
            const alerts = await getAlertsData();
            const badge = document.getElementById('notif-badge-count');

            // Pobieramy liczbƒô ostatnio widzianych powiadomie≈Ñ
            const lastSeenCount = parseInt(localStorage.getItem('last_seen_alerts_count') || '0');
            const currentCount = alerts.length;

            // Pokazuj kropkƒô TYLKO je≈õli jest wiƒôcej b≈Çƒôd√≥w ni≈º ostatnio widzieli≈õmy
            // LUB je≈õli u≈ºytkownik nigdy ich nie widzia≈Ç (lastSeenCount == 0) a b≈Çƒôdy sƒÖ.
            if (currentCount > 0 && currentCount > lastSeenCount) {
                badge.style.display = 'inline-block';
                badge.textContent = currentCount; // Pokazuje liczbƒô wszystkich aktywnych
            } else {
                badge.style.display = 'none';
            }
        }

        // G≈Å√ìWNA FUNKCJA WIDOKU
        async function renderNotifications() {
            currentView = 'notifications';
            viewTitle.textContent = 'Centrum Powiadomie≈Ñ';
            document.getElementById('add-btn').style.display = 'none';

            const contentDiv = document.getElementById('main-content');
            contentDiv.innerHTML = '<div style="text-align:center; padding:20px;">Sprawdzanie termin√≥w...</div>';

            const alerts = await getAlertsData();

            // --- 1. RESETOWANIE LICZNIKA (ZNIKANIE KROPKI) ---
            // Zapisujemy, ≈ºe u≈ºytkownik widzia≈Ç tyle powiadomie≈Ñ, ile jest teraz
            localStorage.setItem('last_seen_alerts_count', alerts.length);
            updateNotificationBadge(); // Od≈õwie≈ºamy kropkƒô (zniknie)

            if (alerts.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align:center; padding:50px; color:#28a745;">
                        <i class="fas fa-check-circle" style="font-size:3em; margin-bottom:15px;"></i>
                        <h3>Wszystko w porzƒÖdku!</h3>
                        <p>Brak zbli≈ºajƒÖcych siƒô termin√≥w polis czy przeglƒÖd√≥w.</p>
                    </div>
                `;
                return;
            }

            // --- 2. GRUPOWANIE NA DZIA≈ÅY ---
            const insuranceAlerts = alerts.filter(a => a.view === 'policies');
            const techAlerts = alerts.filter(a => a.view === 'inspection' || a.view === 'repairs' || a.view === 'tech_inspections');

            // Funkcja pomocnicza do generowania sekcji HTML
            const renderSection = (title, icon, items, colorClass) => {
                if (items.length === 0) return '';
                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="border-bottom: 2px solid #ccc; padding-bottom: 10px; color: #2c3e50;">
                            <i class="fas ${icon}" style="margin-right:10px;"></i> ${title}
                        </h3>
                `;

                items.forEach(a => {
                    const statusIcon = a.type === 'CRITICAL'
                        ? '<i class="fas fa-exclamation-circle" style="color:#dc3545; font-size:1.5em;"></i>'
                        : '<i class="fas fa-clock" style="color:#ffc107; font-size:1.5em;"></i>';

                    // --- 3. BRAK PRZYCISKU EDYCJI ---
                    // Generujemy kafelek TYLKO z informacjƒÖ, bez buttona <button onclick="openModal...">

                    html += `
                        <div class="alert-card ${a.type === 'CRITICAL' ? 'alert-critical' : 'alert-warning'}" style="cursor: default;">
                            <div style="display:flex; align-items:center; gap:15px; width: 100%;">
                                ${statusIcon}
                                <div>
                                    <div style="font-weight:bold; font-size:1.1em;">${a.reg}</div>
                                    <div style="font-size:0.95em;">${a.msg}</div>
                                    <div style="font-size:0.85em; color:#666; margin-top:4px;">
                                        üìÖ Termin: <strong>${a.date}</strong>
                                    </div>
                                </div>
                            </div>
                            </div>
                    `;
                });
                html += '</div>';
                return html;
            };

            let finalHtml = '<div style="max-width: 800px; margin: 0 auto;">';

            // Renderujemy sekcjƒô Ubezpiecze≈Ñ
            finalHtml += renderSection('Dzia≈Ç Ubezpiecze≈Ñ (Polisy)', 'fa-file-contract', insuranceAlerts);

            // Renderujemy sekcjƒô TechnicznƒÖ
            finalHtml += renderSection('Dzia≈Ç Techniczny (Serwis)', 'fa-wrench', techAlerts);

            finalHtml += '</div>';
            contentDiv.innerHTML = finalHtml;
        }

        function checkAuthentication() {
            const accessToken = localStorage.getItem('access_token');
            const userRole = localStorage.getItem('user_role');

            if (accessToken && userRole) {
                loginContainer.style.display = 'none';
                mainApp.style.display = 'flex';
                updateHeaderUser();

                updateNotificationBadge(); // <--- DODAJ TO TUTAJ

                loadView('vehicles');
            } else {
                loginContainer.style.display = 'flex';
                mainApp.style.display = 'none';
            }
        }

        checkAuthentication();
    </script>

</body>
</html>